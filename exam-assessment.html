<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mitests - مراجعة الاختبار</title>
  <meta name="description" content="واجهة المعلم لمراجعة واعتماد العلامات المقترحة بواسطة الذكاء الاصطناعي.">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">

  <style>
    .teacher-navbar { border-bottom: 1px solid var(--color-gray-200); }
    body.rtl .main-content .teacher-navbar { right: var(--sidebar-width); left: 0; }
    body.ltr .main-content .teacher-navbar { left: var(--sidebar-width); right: 0; }
    body.rtl .main-content.main-content--expanded .teacher-navbar { right: var(--sidebar-collapsed-width); }
    body.ltr .main-content.main-content--expanded .teacher-navbar { left: var(--sidebar-collapsed-width); }

    .teacher-navbar .navbar__brand-icon { background: linear-gradient(135deg, var(--color-teacher), var(--color-primary-400)); }
    .sidebar__item:hover, .sidebar__item--active { background: rgba(53, 86, 178, 0.25); color: var(--color-white); }
    .sidebar__item--active { border-inline-start: 3px solid var(--color-teacher); }

    .btn--teacher { background: var(--color-teacher); border-color: var(--color-teacher); color: var(--color-white); }
    .btn--teacher:hover { background: var(--color-primary-600); border-color: var(--color-primary-600); color: var(--color-white); }
    .btn--approve { background: var(--color-green-500); border-color: var(--color-green-500); color: var(--color-white); }
    .btn--approve:hover { background: #16a34a; border-color: #16a34a; color: var(--color-white); }

    .assessment-main {
      padding: calc(var(--navbar-height) + var(--space-6)) var(--space-6) var(--space-8);
      display: grid;
      gap: var(--space-5);
    }

    .header-card {
      background: var(--color-white);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-md);
      border-top: 4px solid var(--color-teacher);
      padding: var(--space-6);
      display: grid;
      gap: var(--space-3);
    }

    .header-card h1 {
      font-size: var(--font-size-3xl);
      color: var(--color-gray-900);
      line-height: 1.2;
    }

    .header-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      background: var(--color-primary-100);
      color: var(--color-primary-700);
      border-radius: var(--border-radius-full);
      padding: var(--space-1) var(--space-3);
      font-size: var(--font-size-sm);
      font-weight: 600;
    }

    .card { display: grid; gap: var(--space-4); }

    .grade-summary {
      grid-template-columns: repeat(2, minmax(0, 1fr));
      align-items: stretch;
      gap: var(--space-4);
    }

    .grade-box {
      border: 1px solid var(--color-gray-200);
      border-radius: var(--border-radius-md);
      padding: var(--space-4);
      display: grid;
      gap: var(--space-2);
      background: var(--color-gray-50);
    }

    .grade-box__label {
      color: var(--color-gray-600);
      font-size: var(--font-size-sm);
      font-weight: 600;
    }

    .grade-box__value {
      font-size: var(--font-size-4xl);
      font-weight: 700;
      color: var(--color-teacher);
      line-height: 1.1;
    }

    .question-list {
      display: grid;
      gap: var(--space-4);
    }

    .question-card {
      background: var(--color-white);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--color-gray-200);
      border-top: 4px solid var(--color-teacher);
      padding: var(--space-5);
      display: grid;
      gap: var(--space-3);
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    .question-header h3 {
      color: var(--color-gray-900);
      font-size: var(--font-size-xl);
      line-height: 1.3;
    }

    .question-points {
      color: var(--color-gray-500);
      font-size: var(--font-size-sm);
      font-weight: 600;
    }

    .answer-box {
      border: 1px solid var(--color-gray-200);
      border-radius: var(--border-radius-sm);
      padding: var(--space-3);
      background: var(--color-gray-50);
      color: var(--color-gray-800);
      line-height: 1.7;
    }

    .analysis-wrap {
      display: grid;
      gap: var(--space-2);
    }

    .analysis-badges {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      border-radius: var(--border-radius-full);
      padding: var(--space-1) var(--space-3);
      font-size: var(--font-size-xs);
      font-weight: 700;
    }

    .badge--bloom {
      background: var(--color-primary-100);
      color: var(--color-teacher);
    }

    .badge--mark {
      background: var(--color-secondary-100);
      color: var(--color-secondary-700);
    }

    .ai-bubble {
      background: #eef3ff;
      border: 1px solid var(--color-primary-200);
      border-radius: var(--border-radius-md);
      padding: var(--space-3);
      color: var(--color-gray-700);
      font-size: var(--font-size-sm);
      line-height: 1.7;
    }

    .action-area {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-3);
      flex-wrap: wrap;
      border-top: 1px solid var(--color-gray-200);
      padding-top: var(--space-3);
    }

    .mark-edit {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      color: var(--color-gray-700);
      font-size: var(--font-size-sm);
      font-weight: 600;
    }

    .mark-edit input {
      width: 88px;
      border: 1px solid var(--color-gray-300);
      border-radius: var(--border-radius-sm);
      padding: var(--space-2);
      font-family: inherit;
      text-align: center;
      color: var(--color-gray-800);
    }

    .mark-edit input:focus {
      outline: none;
      border-color: var(--color-teacher);
      box-shadow: 0 0 0 3px rgba(53, 86, 178, 0.15);
    }

    .teacher-note textarea {
      width: 100%;
      min-height: 140px;
      border: 1px solid var(--color-gray-300);
      border-radius: var(--border-radius-sm);
      padding: var(--space-3);
      font-family: inherit;
      font-size: var(--font-size-base);
      line-height: 1.6;
      resize: vertical;
    }

    .teacher-note textarea:focus {
      outline: none;
      border-color: var(--color-teacher);
      box-shadow: 0 0 0 3px rgba(53, 86, 178, 0.15);
    }

    .teacher-note-tools {
      display: grid;
      gap: var(--space-3);
      border: 1px solid var(--color-primary-200);
      border-radius: var(--border-radius-md);
      background: rgba(53, 86, 178, 0.06);
      padding: var(--space-3);
    }

    .teacher-note-tools__hint {
      margin: 0;
      color: var(--color-gray-700);
      font-size: var(--font-size-sm);
    }

    .teacher-note-tools__actions {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .teacher-note-tools__actions .btn {
      white-space: nowrap;
    }

    .ai-note-preview {
      border: 1px dashed var(--color-primary-300);
      border-radius: var(--border-radius-sm);
      background: var(--color-white);
      padding: var(--space-3);
      min-height: 72px;
      color: var(--color-gray-700);
      font-size: var(--font-size-sm);
      line-height: 1.7;
    }

    .approval-footer {
      position: sticky;
      bottom: 0;
      background: rgba(255, 255, 255, 0.97);
      border: 1px solid var(--color-gray-200);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-lg);
      padding: var(--space-4);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    .approval-footer__hint {
      color: var(--color-gray-600);
      font-size: var(--font-size-sm);
    }

    @media (max-width: 1023px) {
      body.rtl .main-content .teacher-navbar { right: var(--sidebar-collapsed-width); }
      body.ltr .main-content .teacher-navbar { left: var(--sidebar-collapsed-width); }
      body.rtl .main-content { margin-right: var(--sidebar-collapsed-width); }
      body.ltr .main-content { margin-left: var(--sidebar-collapsed-width); }
      .sidebar { width: var(--sidebar-collapsed-width); }
      .sidebar .sidebar__brand-text, .sidebar .sidebar__item span, .sidebar .sidebar__toggle span { display: none; }
      .grade-summary { grid-template-columns: 1fr; }
    }

    @media (max-width: 767px) {
      .sidebar { display: none; }
      body.rtl .main-content, body.ltr .main-content { margin: 0; }
      body.rtl .main-content .teacher-navbar, body.ltr .main-content .teacher-navbar { right: 0; left: 0; }
      .assessment-main { padding-inline: var(--space-4); }
      .header-card h1 { font-size: var(--font-size-2xl); }
      .action-area .btn { width: 100%; }
    }
  </style>
</head>

<body class="rtl">
  <aside class="sidebar" id="sidebar" aria-label="Sidebar navigation">
    <div class="sidebar__header">
      <div class="sidebar__logo">M</div>
      <span class="sidebar__brand-text">سراج - المعلم</span>
    </div>
    <nav class="sidebar__nav">
      <a class="sidebar__item" href="teacher-dashboard.html"><i class="fas fa-gauge"></i><span>نظرة عامة</span></a>
      <a class="sidebar__item sidebar__item--active" href="exam-assessment.html"><i class="fas fa-file-lines"></i><span>مراجعة الاختبار</span></a>
      <a class="sidebar__item" href="teacher-group.html"><i class="fas fa-users"></i><span>المجموعات</span></a>
      <a class="sidebar__item" href="teacher-question-bank.html"><i class="fas fa-database"></i><span>بنك الأسئلة</span></a>
      <a class="sidebar__item" href="teacher-community.html"><i class="fas fa-comments"></i><span>المجتمع</span></a>
      <a class="sidebar__item" href="teacher-settings.html"><i class="fas fa-gear"></i><span>الإعدادات</span></a>
    </nav>
    <button class="sidebar__toggle" id="sidebar-toggle" aria-label="Toggle sidebar"><i class="fas fa-angles-right"></i><span>تصغير</span></button>
  </aside>

  <div class="main-content" id="main-content">
    <nav class="navbar teacher-navbar" role="navigation" aria-label="Teacher top navigation">
      <a href="teacher-dashboard.html" class="navbar__brand">
        <div class="navbar__brand-icon"><i class="fas fa-marker"></i></div>
        <span class="navbar__brand-text" data-i18n="brand">مراجعة الاختبار</span>
      </a>
      <div class="navbar__actions">
        <div class="lang-switcher" role="group" aria-label="Language selector">
          <button class="lang-switcher__btn active" data-lang="ar" aria-label="Arabic">&#1593;</button>
          <button class="lang-switcher__btn" data-lang="he" aria-label="Hebrew">&#1506;&#1489;</button>
          <button class="lang-switcher__btn" data-lang="en" aria-label="English">En</button>
        </div>
        <div class="avatar-dropdown">
          <button class="avatar-btn" type="button" data-avatar-toggle="teacher-avatar-menu" aria-label="قائمة حساب المعلم">
            <i class="fas fa-user"></i>
          </button>
          <div class="avatar-menu" id="teacher-avatar-menu" data-avatar-menu>
            <span class="avatar-menu__label">حساب المعلم</span>
            <a class="avatar-menu__link" href="teacher-profile.html"><i class="fas fa-id-card"></i><span data-i18n="profileMenu">الملف الشخصي</span></a>
            <a class="avatar-menu__link" href="teacher-settings.html"><i class="fas fa-gear"></i><span>الإعدادات</span></a>
          </div>
        </div>
        <a href="index.html" class="btn btn--teacher btn--sm"><i class="fas fa-right-from-bracket"></i><span data-i18n="logout">تسجيل الخروج</span></a>
      </div>
    </nav>

    <main class="assessment-main">
      <header class="header-card">
        <h1><span data-i18n="studentLabel">الطالب</span>: <span id="assessment-student-name">يوسف علي</span></h1>
        <div class="header-meta">
          <span class="chip"><i class="fas fa-file-pen"></i><span id="assessment-kind-label" data-i18n="examLabel">الاختبار</span>: <strong id="assessment-title">الإنجليزية - اختبار منتصف الفصل</strong></span>
          <span class="chip"><i class="fas fa-users"></i><span data-i18n="groupLabel">المجموعة</span>: <strong id="assessment-group">تاسع 1</strong></span>
        </div>
      </header>

      <section class="card">
        <h2 data-i18n="summaryTitle">ملخص التقييم</h2>
        <div class="grade-summary">
          <div class="grade-box">
            <p class="grade-box__label" data-i18n="aiSuggested">العلامة المقترحة من AI</p>
            <p class="grade-box__value">86</p>
          </div>
          <div class="grade-box">
            <p class="grade-box__label" data-i18n="teacherConfirmed">العلامة المعتمدة من المعلم</p>
            <p class="grade-box__value">84</p>
          </div>
        </div>
      </section>

      <section class="question-list" aria-label="Question review list">
        <h2 data-i18n="questionsTitle">قائمة مراجعة الأسئلة</h2>

        <article class="question-card">
          <div class="question-header">
            <h3 data-i18n="q1Title">السؤال 1: تحليل نص</h3>
            <span class="question-points">/10</span>
          </div>
          <div>
            <strong data-i18n="studentAnswer">إجابة الطالب</strong>
            <div class="answer-box">بنى الطالب التوتر باستخدام مفردات قوية وأسلوب رسمي، لكنه لم يوضح الفعل الرئيسي بشكل كافٍ.</div>
          </div>
          <div class="analysis-wrap">
            <div class="analysis-badges">
              <span class="badge badge--bloom"><i class="fas fa-layer-group"></i><span data-i18n="bloom">Bloom</span>: L4</span>
              <span class="badge badge--mark"><i class="fas fa-star"></i><span data-i18n="suggestedMark">Suggested</span>: 8/10</span>
            </div>
            <div class="ai-bubble" data-i18n="q1Ai">
              The student used complex vocabulary but missed the main verb and therefore the core action remained unclear.
            </div>
          </div>
          <div class="action-area">
            <button class="btn btn--approve btn--sm"><i class="fas fa-check"></i><span data-i18n="approve">اعتماد</span></button>
            <label class="mark-edit"><span data-i18n="editMark">تعديل العلامة</span><input type="number" value="8" min="0" max="10"></label>
          </div>
        </article>

        <article class="question-card">
          <div class="question-header">
            <h3 data-i18n="q2Title">السؤال 2: جبر (LaTeX)</h3>
            <span class="question-points">/15</span>
          </div>
          <div>
            <strong data-i18n="studentAnswer">إجابة الطالب</strong>
            <div class="answer-box">
              \(x^2 - 5x + 6 = 0\)، إذًا \(x = \frac{5 \pm \sqrt{25-24}}{2}\Rightarrow x=3 \text{ أو } x=2\)
            </div>
          </div>
          <div class="analysis-wrap">
            <div class="analysis-badges">
              <span class="badge badge--bloom"><i class="fas fa-layer-group"></i><span data-i18n="bloom">Bloom</span>: L3</span>
              <span class="badge badge--mark"><i class="fas fa-star"></i><span data-i18n="suggestedMark">Suggested</span>: 14/15</span>
            </div>
            <div class="ai-bubble" data-i18n="q2Ai">
              The method is mathematically correct and clearly structured. A small notation detail was missing in the final line.
            </div>
          </div>
          <div class="action-area">
            <button class="btn btn--approve btn--sm"><i class="fas fa-check"></i><span data-i18n="approve">اعتماد</span></button>
            <label class="mark-edit"><span data-i18n="editMark">تعديل العلامة</span><input type="number" value="14" min="0" max="15"></label>
          </div>
        </article>
      </section>

      <section class="card teacher-note">
        <h2 data-i18n="teacherNoteTitle">ملاحظة المعلم</h2>
        <div class="teacher-note-tools">
          <p class="teacher-note-tools__hint" data-i18n="teacherNoteAiHint">يمكن للذكاء الاصطناعي اقتراح ملخص ونصائح وتوصيات قصيرة لإدراجها مباشرة في ملاحظة المعلم.</p>
          <div class="teacher-note-tools__actions">
            <button type="button" class="btn btn--outline btn--sm note-ai-btn" data-note-mode="summary" data-i18n="aiSummaryBtn">توليد ملخص قصير</button>
            <button type="button" class="btn btn--outline btn--sm note-ai-btn" data-note-mode="tips" data-i18n="aiTipsBtn">توليد نصائح</button>
            <button type="button" class="btn btn--outline btn--sm note-ai-btn" data-note-mode="recommendations" data-i18n="aiRecommendationsBtn">توليد توصيات</button>
          </div>
          <div class="ai-note-preview" id="ai-note-preview" data-i18n="aiNotePreviewPlaceholder">ستظهر هنا صياغة AI قبل إضافتها إلى ملاحظة المعلم.</div>
        </div>
        <textarea id="teacher-note-input" data-i18n-placeholder="teacherNotePlaceholder" placeholder="اكتب ملاحظة عامة للطالب حول نقاط القوة وما يحتاج إلى تحسين."></textarea>
      </section>

      <footer class="approval-footer">
        <span class="approval-footer__hint" data-i18n="finalHint">بعد الاعتماد النهائي سيتم إرسال النتيجة والملاحظات إلى الطالب.</span>
        <a href="exam-report.html" class="btn btn--teacher btn--lg"><i class="fas fa-paper-plane"></i><span data-i18n="finalize">اعتماد نهائي وإرسال للطالب</span></a>
      </footer>
    </main>
  </div>

  <script src="shared-layout.js"></script>
  <script src="tenant-mode.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
  <script>
    (function () {
      'use strict';

      var I18N = {
        he: {
          pageTitle: 'Mitests - בדיקת מבחן',
          pageDescription: 'מסך הערכה למורה לאישור ציונים מוצעים על ידי AI.',
          brand: 'בדיקת מבחן',
          logout: 'יציאה',
          profileMenu: 'פרופיל',
          studentLabel: 'תלמיד',
          examLabel: 'מבחן',
          groupLabel: 'קבוצה',
          summaryTitle: 'סיכום ציונים',
          aiSuggested: 'ציון מוצע על ידי AI',
          teacherConfirmed: 'ציון מאושר על ידי המורה',
          questionsTitle: 'רשימת בדיקת שאלות',
          q1Title: 'שאלה 1: ניתוח טקסט',
          q2Title: 'שאלה 2: אלגברה (LaTeX)',
          studentAnswer: 'תשובת התלמיד',
          bloom: 'Bloom',
          suggestedMark: 'מוצע',
          q1Ai: 'התלמיד השתמש באוצר מילים מורכב אך פספס את הפועל המרכזי, ולכן הפעולה המרכזית נשארה לא ברורה.',
          q2Ai: 'השיטה המתמטית נכונה ומסודרת. חסר פרט סימון קטן בשורה האחרונה.',
          approve: 'אישור',
          editMark: 'עריכת ציון',
          teacherNoteTitle: 'הערת מורה',
          teacherNoteAiHint: 'ה-AI יכול להציע סיכום קצר, טיפים והמלצות להוספה ישירה להערת המורה.',
          aiSummaryBtn: 'יצירת סיכום קצר',
          aiTipsBtn: 'יצירת טיפים',
          aiRecommendationsBtn: 'יצירת המלצות',
          aiNotePreviewPlaceholder: 'כאן תופיע הצעת ה-AI לפני הוספה להערת המורה.',
          teacherNotePlaceholder: 'כתוב משוב כללי לתלמיד על נקודות לחיזוק והצלחות.',
          finalHint: 'לאחר אישור סופי, הציון והמשוב ישלחו לתלמיד.',
          finalize: 'סיום ושליחה לתלמיד'
        },
        ar: {
          pageTitle: 'Mitests - مراجعة الاختبار',
          pageDescription: 'واجهة المعلم لمراجعة واعتماد العلامات المقترحة بواسطة الذكاء الاصطناعي.',
          brand: 'مراجعة الاختبار',
          logout: 'تسجيل الخروج',
          profileMenu: 'الملف الشخصي',
          studentLabel: 'الطالب',
          examLabel: 'الاختبار',
          groupLabel: 'المجموعة',
          summaryTitle: 'ملخص التقييم',
          aiSuggested: 'العلامة المقترحة من AI',
          teacherConfirmed: 'العلامة المعتمدة من المعلم',
          questionsTitle: 'قائمة مراجعة الأسئلة',
          q1Title: 'السؤال 1: تحليل نص',
          q2Title: 'السؤال 2: جبر (LaTeX)',
          studentAnswer: 'إجابة الطالب',
          bloom: 'Bloom',
          suggestedMark: 'المقترح',
          q1Ai: 'استخدم الطالب مفردات متقدمة لكنه أغفل الفعل الرئيسي، لذلك بقيت الفكرة الأساسية غير واضحة.',
          q2Ai: 'الطريقة الرياضية صحيحة ومنظمة. يوجد نقص بسيط في الترميز في السطر الأخير.',
          approve: 'اعتماد',
          editMark: 'تعديل العلامة',
          teacherNoteTitle: 'ملاحظة المعلم',
          teacherNoteAiHint: 'يمكن للذكاء الاصطناعي اقتراح ملخص ونصائح وتوصيات قصيرة لإدراجها مباشرة في ملاحظة المعلم.',
          aiSummaryBtn: 'توليد ملخص قصير',
          aiTipsBtn: 'توليد نصائح',
          aiRecommendationsBtn: 'توليد توصيات',
          aiNotePreviewPlaceholder: 'ستظهر هنا صياغة AI قبل إضافتها إلى ملاحظة المعلم.',
          teacherNotePlaceholder: 'اكتب ملاحظة عامة للطالب حول نقاط القوة وما يحتاج إلى تحسين.',
          finalHint: 'بعد الاعتماد النهائي سيتم إرسال النتيجة والملاحظات إلى الطالب.',
          finalize: 'اعتماد نهائي وإرسال للطالب'
        },
        en: {
          pageTitle: 'Mitests - Exam Assessment',
          pageDescription: 'Teacher view for reviewing and approving AI-generated marks.',
          brand: 'Exam Assessment',
          logout: 'Logout',
          profileMenu: 'Profile',
          studentLabel: 'Student',
          examLabel: 'Exam',
          groupLabel: 'Group',
          summaryTitle: 'Grading Summary',
          aiSuggested: 'AI Suggested Grade',
          teacherConfirmed: 'Teacher Confirmed Grade',
          questionsTitle: 'Question Review List',
          q1Title: 'Question 1: Text Analysis',
          q2Title: 'Question 2: Algebra (LaTeX)',
          studentAnswer: 'Student\'s Answer',
          bloom: 'Bloom',
          suggestedMark: 'Suggested',
          q1Ai: 'The student used complex vocabulary but missed the main verb, so the core action remained unclear.',
          q2Ai: 'The mathematical method is correct and well-structured. A small notation detail was missing in the final line.',
          approve: 'Approve',
          editMark: 'Edit Mark',
          teacherNoteTitle: 'Teacher Note',
          teacherNoteAiHint: 'AI can suggest short summary, tips, and recommendations that can be inserted directly into the teacher note.',
          aiSummaryBtn: 'Generate Short Summary',
          aiTipsBtn: 'Generate Tips',
          aiRecommendationsBtn: 'Generate Recommendations',
          aiNotePreviewPlaceholder: 'AI wording will appear here before inserting it into the teacher note.',
          teacherNotePlaceholder: 'Write general feedback for the student on strengths and areas to improve.',
          finalHint: 'After finalizing, the grade and feedback will be sent to the student.',
          finalize: 'Finalize & Send to Student'
        }
      };

      function setText(selector, value) {
        var el = document.querySelector(selector);
        if (el) el.textContent = value;
      }

      function applyLanguage(lang) {
        var t = I18N[lang] || I18N.ar;
        var metaDesc = document.querySelector('meta[name="description"]');
        var textNodes = document.querySelectorAll('[data-i18n]');
        var placeholderNodes = document.querySelectorAll('[data-i18n-placeholder]');

        document.title = t.pageTitle;
        if (metaDesc) metaDesc.setAttribute('content', t.pageDescription);

        for (var i = 0; i < textNodes.length; i++) {
          var key = textNodes[i].getAttribute('data-i18n');
          if (t[key]) textNodes[i].textContent = t[key];
        }

        for (var j = 0; j < placeholderNodes.length; j++) {
          var phKey = placeholderNodes[j].getAttribute('data-i18n-placeholder');
          if (t[phKey]) placeholderNodes[j].setAttribute('placeholder', t[phKey]);
        }
      }

      function applyAssessmentContext(lang) {
        var params = new URLSearchParams(window.location.search);
        var kind = params.get('kind') || 'exam';
        var title = params.get('title');
        var student = params.get('student');
        var group = params.get('group');

        var studentEl = document.getElementById('assessment-student-name');
        var titleEl = document.getElementById('assessment-title');
        var groupEl = document.getElementById('assessment-group');
        var kindLabelEl = document.getElementById('assessment-kind-label');

        if (studentEl && student) studentEl.textContent = student;
        if (titleEl && title) titleEl.textContent = title;
        if (groupEl && group) groupEl.textContent = group;

        if (kindLabelEl) {
          if (kind === 'assignment') {
            kindLabelEl.textContent = lang === 'he' ? 'מטלה' : (lang === 'en' ? 'Assignment' : 'الواجب');
          } else {
            var currentLang = I18N[lang] || I18N.ar;
            kindLabelEl.textContent = currentLang.examLabel;
          }
        }
      }

      function buildAiTeacherNote(mode, lang) {
        var params = new URLSearchParams(window.location.search);
        var kind = params.get('kind') === 'assignment' ? 'assignment' : 'exam';
        var title = params.get('title') || '';
        var student = params.get('student') || '';

        var kindAr = kind === 'assignment' ? 'الواجب' : 'الاختبار';
        var kindEn = kind === 'assignment' ? 'assignment' : 'exam';
        var kindHe = kind === 'assignment' ? 'המטלה' : 'המבחן';

        if (lang === 'en') {
          if (mode === 'summary') return 'Short summary: In the ' + kindEn + (title ? ' "' + title + '"' : '') + ', ' + (student || 'the student') + ' showed good effort with clear potential, but still needs better accuracy in key answers.';
          if (mode === 'tips') return 'Tips: 1) Re-check keywords before answering. 2) Organize the answer into short logical steps. 3) Leave 2 minutes at the end for revision.';
          return 'Recommendations: Assign 2 focused practice tasks this week and follow up with a mini-check to track progress before the next assessment.';
        }

        if (lang === 'he') {
          if (mode === 'summary') return 'סיכום קצר: ב' + kindHe + (title ? ' "' + title + '"' : '') + ', ' + (student || 'התלמיד/ה') + ' הראה/תה מאמץ טוב ופוטנציאל ברור, אך עדיין צריך/ה דיוק טוב יותר בתשובות המרכזיות.';
          if (mode === 'tips') return 'טיפים: 1) לבדוק מילות מפתח לפני המענה. 2) לסדר את התשובה בשלבים קצרים וברורים. 3) להשאיר 2 דקות בסוף לבדיקה עצמית.';
          return 'המלצות: לתת שתי משימות תרגול ממוקדות השבוע ולעקוב בבדיקה קצרה לפני ההערכה הבאה.';
        }

        if (mode === 'summary') return 'ملخص قصير: في ' + kindAr + (title ? ' "' + title + '"' : '') + '، أظهر ' + (student || 'الطالب') + ' جهدًا جيدًا وقدرة واضحة، لكنه يحتاج إلى دقة أعلى في الإجابات الأساسية.';
        if (mode === 'tips') return 'نصائح: 1) اقرأ الكلمات المفتاحية قبل الإجابة. 2) نظّم الإجابة على شكل خطوات قصيرة وواضحة. 3) اترك دقيقتين في النهاية للمراجعة.';
        return 'توصيات: تكليف الطالب بمهمتين تدريبيتين مركزتين هذا الأسبوع مع متابعة قصيرة قبل التقييم القادم.';
      }

      function bindAiTeacherNoteTools() {
        var buttons = document.querySelectorAll('.note-ai-btn');
        var preview = document.getElementById('ai-note-preview');
        var noteInput = document.getElementById('teacher-note-input');
        if (!buttons.length || !preview || !noteInput) return;

        for (var i = 0; i < buttons.length; i++) {
          buttons[i].addEventListener('click', function () {
            var mode = this.getAttribute('data-note-mode') || 'summary';
            var lang = document.documentElement.getAttribute('lang') || 'ar';
            var generated = buildAiTeacherNote(mode, lang);
            preview.textContent = generated;

            var existing = noteInput.value.trim();
            noteInput.value = existing ? (existing + '\n\n' + generated) : generated;
            noteInput.focus();
          });
        }
      }

      document.addEventListener('mitests:languagechange', function (e) {
        var lang = (e.detail && e.detail.lang) || document.documentElement.getAttribute('lang') || 'ar';
        applyLanguage(lang);
        applyAssessmentContext(lang);
      });

      document.addEventListener('DOMContentLoaded', function () {
        var lang = document.documentElement.getAttribute('lang') || 'ar';
        applyLanguage(lang);
        setText('.navbar__brand-text[data-i18n="brand"]', (I18N[lang] || I18N.ar).brand);
        applyAssessmentContext(lang);
        bindAiTeacherNoteTools();
      });
    })();
  </script>
</body>
</html>


