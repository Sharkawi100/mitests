<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mitests - اختبار نشط</title>
  <meta name="description" content="واجهة اختبار مركزة للطالب مع مؤقت، حفظ تلقائي، وتنبيهات أمان.">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">

  <style>
    body { background: #f4fbfb; }

    .exam-topbar {
      position: sticky;
      top: 0;
      z-index: 250;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--color-gray-200);
      padding: var(--space-3) var(--space-5);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    .exam-headline { display: grid; gap: var(--space-1); }
    .exam-headline h1 { font-size: var(--font-size-xl); color: var(--color-gray-900); line-height: 1.3; }
    .exam-headline p { color: var(--color-gray-600); font-size: var(--font-size-sm); }

    .exam-top-actions {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    .timer-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      border-radius: var(--border-radius-full);
      padding: var(--space-2) var(--space-4);
      background: var(--color-amber-100);
      color: #9a3412;
      font-size: var(--font-size-sm);
      font-weight: 700;
      border: 1px solid #fcd9a6;
    }

    .timer-badge.timer--danger {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
      animation: timerPulse 1.2s infinite;
    }

    @keyframes timerPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(185, 28, 28, 0.2); }
      50% { box-shadow: 0 0 0 8px rgba(185, 28, 28, 0); }
    }

    .autosave {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      border-radius: var(--border-radius-full);
      padding: var(--space-2) var(--space-3);
      background: var(--color-gray-100);
      color: var(--color-gray-600);
      font-size: var(--font-size-xs);
      font-weight: 700;
    }

    .autosave i { color: var(--color-gray-500); transition: color var(--transition-fast), transform var(--transition-fast); }

    .autosave.is-syncing i {
      color: var(--color-green-500);
      animation: syncPulse 1.1s ease;
      transform: scale(1.08);
    }

    @keyframes syncPulse {
      0% { transform: scale(0.95); opacity: 0.65; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    .exam-shell {
      max-width: 900px;
      margin: var(--space-6) auto calc(120px + var(--space-6));
      padding-inline: var(--space-4);
      display: grid;
      gap: var(--space-4);
    }

    .question-card {
      background: var(--color-white);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-md);
      border-top: 4px solid var(--color-student);
      padding: var(--space-6);
      display: grid;
      gap: var(--space-4);
    }

    .question-meta {
      display: flex;
      justify-content: space-between;
      gap: var(--space-3);
      flex-wrap: wrap;
      color: var(--color-gray-600);
      font-size: var(--font-size-sm);
      font-weight: 600;
    }

    .question-text {
      color: var(--color-gray-900);
      font-size: var(--font-size-lg);
      line-height: 1.8;
    }

    .question-answer {
      display: grid;
      gap: var(--space-2);
    }

    .question-answer textarea {
      width: 100%;
      min-height: 140px;
      border: 1px solid var(--color-gray-300);
      border-radius: var(--border-radius-sm);
      padding: var(--space-3);
      font-family: inherit;
      font-size: var(--font-size-base);
      resize: vertical;
    }

    .question-answer textarea:focus {
      outline: none;
      border-color: var(--color-student);
      box-shadow: 0 0 0 3px rgba(14, 165, 165, 0.18);
    }

    .options {
      display: grid;
      gap: var(--space-2);
    }

    .option-item {
      border: 1px solid var(--color-gray-200);
      border-radius: var(--border-radius-sm);
      padding: var(--space-3);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      background: var(--color-gray-50);
      color: var(--color-gray-800);
      font-size: var(--font-size-base);
    }

    .option-item input { accent-color: var(--color-student); }

    .exam-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.97);
      border-top: 1px solid var(--color-gray-200);
      box-shadow: 0 -6px 16px rgba(0, 0, 0, 0.08);
      padding: var(--space-3) var(--space-4);
      z-index: 220;
    }

    .exam-footer__actions {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      gap: var(--space-2);
      flex-wrap: wrap;
    }

    .btn--student { background: var(--color-student); border-color: var(--color-student); color: var(--color-white); }
    .btn--student:hover { background: #0b8b8b; border-color: #0b8b8b; color: var(--color-white); }
    .btn--submit {
      background: linear-gradient(135deg, var(--color-student), #21bdbd);
      border-color: var(--color-student);
      color: var(--color-white);
      box-shadow: 0 10px 20px rgba(14, 165, 165, 0.28);
    }
    .btn--submit:hover { background: linear-gradient(135deg, #0b8b8b, #0ea5a5); color: var(--color-white); }

    .warning-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      z-index: 500;
      display: none;
      align-items: center;
      justify-content: center;
      padding: var(--space-4);
    }

    .warning-overlay.active { display: flex; }

    .warning-modal {
      width: 100%;
      max-width: 520px;
      background: var(--color-white);
      border-radius: var(--border-radius-lg);
      border-top: 4px solid #dc2626;
      box-shadow: var(--shadow-xl);
      padding: var(--space-6);
      display: grid;
      gap: var(--space-3);
    }

    .warning-modal h2 { color: #b91c1c; font-size: var(--font-size-xl); }
    .warning-modal p { color: var(--color-gray-700); line-height: 1.7; }

    @media (max-width: 767px) {
      .exam-topbar { padding-inline: var(--space-3); }
      .exam-headline h1 { font-size: var(--font-size-lg); }
      .question-card { padding: var(--space-4); }
      .exam-footer__actions { flex-direction: column-reverse; }
      .exam-footer__actions .btn { width: 100%; }
    }
  </style>
</head>

<body class="rtl">
  <header class="exam-topbar">
    <div class="exam-headline">
      <h1 id="exam-title"></h1>
      <p><span data-i18n="studentLabel">الطالب</span>: <strong id="student-name"></strong></p>
    </div>
    <div class="exam-top-actions">
      <div class="lang-switcher" role="group" aria-label="Language selector">
        <button class="lang-switcher__btn active" data-lang="ar" aria-label="Arabic">&#1593;</button>
        <button class="lang-switcher__btn" data-lang="he" aria-label="Hebrew">&#1506;&#1489;</button>
        <button class="lang-switcher__btn" data-lang="en" aria-label="English">En</button>
      </div>
      <div class="autosave" id="autosave-indicator"><i class="fas fa-cloud"></i><span id="autosave-text" data-i18n="autosaveWaiting">بانتظار الحفظ...</span></div>
      <div class="timer-badge" id="timer-badge"><i class="fas fa-clock"></i><span id="timer-label"></span></div>
    </div>
  </header>

  <main class="exam-shell">
    <article class="question-card">
      <div class="question-meta">
        <span id="question-counter"></span>
        <span id="question-points"></span>
      </div>
      <div class="question-text" id="question-text"></div>
      <div class="question-answer" id="question-answer"></div>
    </article>
  </main>

  <footer class="exam-footer">
    <div class="exam-footer__actions">
      <button class="btn btn--outline" id="btn-prev" data-i18n="previous">السابق</button>
      <button class="btn btn--student" id="btn-next" data-i18n="next">التالي</button>
      <button class="btn btn--submit btn--lg" id="btn-submit" data-i18n="submitExam">إرسال الاختبار</button>
    </div>
  </footer>

  <div class="warning-overlay" id="warning-overlay" aria-hidden="true">
    <div class="warning-modal">
      <h2 data-i18n="warningTitle">تحذير</h2>
      <p data-i18n="warningText">تحذير: مغادرة تبويب الاختبار يتم تسجيلها وإبلاغ المعلم.</p>
      <button class="btn btn--student" id="warning-close" data-i18n="warningClose">فهمت</button>
    </div>
  </div>

  <div class="warning-overlay" id="confirm-submit-overlay" aria-hidden="true">
    <div class="warning-modal" style="border-top-color: var(--color-student);">
      <h2 data-i18n="confirmSubmitTitle">تأكيد الإرسال</h2>
      <p data-i18n="confirmSubmitText">هل أنت متأكد من رغبتك في تسليم الاختبار وإنهاء المحاولة؟</p>
      <div class="exam-footer__actions" style="justify-content: flex-end; margin-top: 1rem;">
        <button class="btn btn--outline" id="confirm-cancel" data-i18n="cancel">إلغاء</button>
        <button class="btn btn--submit" id="confirm-proceed" data-i18n="submitExam">نعم، سلم الاختبار</button>
      </div>
    </div>
  </div>

  <div class="exam-shell" id="review-screen" style="display: none;">
    <h2 data-i18n="reviewAnswersTitle" style="margin-bottom: var(--space-4);">مراجعة الإجابات</h2>
    <div class="question-card" id="review-list">
      <!-- Review items will be injected here -->
    </div>
    <div class="exam-footer__actions" style="margin-top: var(--space-4);">
      <button class="btn btn--outline" id="return-to-exam" data-i18n="returnToExam">عودة للأسئلة</button>
      <button class="btn btn--submit" id="review-submit" data-i18n="submitExam">تسليم الاختبار</button>
    </div>
  </div>

  <script src="shared-layout.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
  <script src="cefr-data.js"></script>
  <script>
    (function () {
      'use strict';

      var STUDENT_NAME = 'يوسف علي';
      var EXAM_TITLE = {
        he: 'מבחן מתמטיקה - פונקציות ואלגברה',
        ar: 'اختبار الرياضيات - الدوال والجبر',
        en: 'Math Exam - Functions and Algebra'
      };

      var I18N = {
        he: {
          pageTitle: 'Mitests - בחינה פעילה',
          pageDescription: 'ממשק בחינה ממוקד לתלמיד עם טיימר, שמירה אוטומטית והתראות אבטחה.',
          studentLabel: 'תלמיד',
          autosaveWaiting: 'המתנה לשמירה...',
          autosaveSaved: 'נשמר בהצלחה',
          timerPrefix: 'זמן נותר',
          previous: 'הקודם',
          next: 'הבא',
          submitExam: 'שלח מבחן',
          warningTitle: 'אזהרה',
          warningText: 'אזהרה: יציאה מלשונית הבחינה מדווחת למורה.',
          warningClose: 'הבנתי',
          counterTemplate: 'שאלה {current} מתוך {total}',
          pointsTemplate: '{points} נקודות',
          openPlaceholder: 'כתוב כאן את התשובה שלך...',
          submittedMsg: 'המבחן נשלח בהצלחה.',
          confirmSubmitTitle: 'אישור הגשה',
          confirmSubmitText: 'האם את/ה בטוח/ה שברצונך להגיש את המבחן ולסיים את הניסיון?',
          cancel: 'ביטול',
          returnToExam: 'חזרה לשאלות',
          reviewAnswersTitle: 'סקירת תשובות',
          reviewStatusAnswered: 'נענה',
          reviewStatusUnanswered: 'לא נענה',
          reviewGoto: 'עבור לשאלה',
          progressTemplate: '{answered} מתוך {total} נענו'
        },
        ar: {
          pageTitle: 'Mitests - اختبار نشط',
          pageDescription: 'واجهة اختبار مركزة للطالب مع مؤقت وحفظ تلقائي وتنبيه أمني.',
          studentLabel: 'الطالب',
          autosaveWaiting: 'بانتظار الحفظ...',
          autosaveSaved: 'تم الحفظ',
          timerPrefix: 'الوقت المتبقي',
          previous: 'السابق',
          next: 'التالي',
          submitExam: 'إرسال الاختبار',
          warningTitle: 'تحذير',
          warningText: 'تحذير: مغادرة تبويب الاختبار يتم تسجيلها وإبلاغ المعلم.',
          warningClose: 'فهمت',
          counterTemplate: 'السؤال {current} من {total}',
          pointsTemplate: '{points} نقاط',
          openPlaceholder: 'اكتب إجابتك هنا...',
          submittedMsg: 'تم إرسال الاختبار بنجاح.',
          confirmSubmitTitle: 'تأكيد الإرسال',
          confirmSubmitText: 'هل أنت متأكد من رغبتك في تسليم الاختبار وإنهاء المحاولة؟',
          cancel: 'إلغاء',
          returnToExam: 'عودة للأسئلة',
          reviewAnswersTitle: 'مراجعة الإجابات',
          reviewStatusAnswered: 'تمت الإجابة',
          reviewStatusUnanswered: 'لم تتم الإجابة',
          reviewGoto: 'ذهاب للسؤال',
          progressTemplate: 'تمت إجابة {answered} من {total}'
        },
        en: {
          pageTitle: 'Mitests - Active Exam',
          pageDescription: 'Focused student exam interface with timer, autosave, and security warnings.',
          studentLabel: 'Student',
          autosaveWaiting: 'Autosave waiting...',
          autosaveSaved: 'Saved',
          timerPrefix: 'Time left',
          previous: 'Previous',
          next: 'Next',
          submitExam: 'Submit Exam',
          warningTitle: 'Warning',
          warningText: 'Warning: Exiting the exam tab is being reported to your teacher!',
          warningClose: 'I Understand',
          counterTemplate: 'Question {current} of {total}',
          pointsTemplate: '{points} points',
          openPlaceholder: 'Write your answer here...',
          submittedMsg: 'Exam submitted successfully.',
          confirmSubmitTitle: 'Confirm Submission',
          confirmSubmitText: 'Are you sure you want to submit the exam and end your attempt?',
          cancel: 'Cancel',
          returnToExam: 'Return to Questions',
          reviewAnswersTitle: 'Review Answers',
          reviewStatusAnswered: 'Answered',
          reviewStatusUnanswered: 'Not Answered',
          reviewGoto: 'Go to Question',
          progressTemplate: '{answered} of {total} answered'
        }
      };

      var QUESTIONS = {
        he: [
          {
            type: 'open',
            points: 15,
            text: 'פתרו את המשוואה: \\(x^2 - 5x + 6 = 0\\). כתבו את דרך הפתרון.',
            answer: ''
          },
          {
            type: 'mc',
            points: 10,
            text: 'מהי הנגזרת של \\(f(x)=x^3\\)?',
            options: ['\\(3x^2\\)', '\\(x^2\\)', '\\(3x\\)', '\\(x^3\\)'],
            answer: null
          },
          {
            type: 'open',
            points: 12,
            text: 'הסבירו במשפט אחד כיצד משתמשים בנוסחת השורשים.',
            answer: ''
          }
        ],
        ar: [
          {
            type: 'open',
            points: 15,
            text: 'حل المعادلة: \\(x^2 - 5x + 6 = 0\\). اشرح خطوات الحل.',
            answer: ''
          },
          {
            type: 'mc',
            points: 10,
            text: 'ما مشتقة \\(f(x)=x^3\\)؟',
            options: ['\\(3x^2\\)', '\\(x^2\\)', '\\(3x\\)', '\\(x^3\\)'],
            answer: null
          },
          {
            type: 'open',
            points: 12,
            text: 'اشرح بجملة واحدة كيف تُستخدم صيغة الجذور.',
            answer: ''
          }
        ],
        en: [
          {
            type: 'open',
            points: 15,
            text: 'Solve the equation: \\(x^2 - 5x + 6 = 0\\). Show your method.',
            answer: ''
          },
          {
            type: 'mc',
            points: 10,
            text: 'What is the derivative of \\(f(x)=x^3\\)?',
            options: ['\\(3x^2\\)', '\\(x^2\\)', '\\(3x\\)', '\\(x^3\\)'],
            answer: null
          },
          {
            type: 'open',
            points: 12,
            text: 'Explain in one sentence how to use the quadratic formula.',
            answer: ''
          }
        ]
      };

      var currentIndex = 0;
      var activeLang = 'ar';
      var timeLeftSeconds = 45 * 60;
      var timerInterval = null;
      var autosaveInterval = null;
      var tabViolations = 0;

      var examTitleEl = document.getElementById('exam-title');
      var studentNameEl = document.getElementById('student-name');
      var questionCounterEl = document.getElementById('question-counter');
      var questionPointsEl = document.getElementById('question-points');
      var questionTextEl = document.getElementById('question-text');
      var questionAnswerEl = document.getElementById('question-answer');
      var timerLabelEl = document.getElementById('timer-label');
      var timerBadgeEl = document.getElementById('timer-badge');
      var autosaveIndicatorEl = document.getElementById('autosave-indicator');
      var autosaveTextEl = document.getElementById('autosave-text');
      var prevBtn = document.getElementById('btn-prev');
      var nextBtn = document.getElementById('btn-next');
      var submitBtn = document.getElementById('btn-submit');
      var warningOverlay = document.getElementById('warning-overlay');
      var warningClose = document.getElementById('warning-close');
      
      // QA Fixes Elements
      var confirmOverlay = document.getElementById('confirm-submit-overlay');
      var confirmProceedBtn = document.getElementById('confirm-proceed');
      var confirmCancelBtn = document.getElementById('confirm-cancel');
      var reviewScreen = document.getElementById('review-screen');
      var reviewList = document.getElementById('review-list');
      var reviewSubmitBtn = document.getElementById('review-submit');
      var returnToExamBtn = document.getElementById('return-to-exam');
      var examShell = document.querySelector('main.exam-shell'); // Original main container

      function format(template, values) {
        var out = template;
        for (var key in values) {
          if (Object.prototype.hasOwnProperty.call(values, key)) {
            out = out.replace('{' + key + '}', values[key]);
          }
        }
        return out;
      }

      function getLang() {
        var lang = document.documentElement.getAttribute('lang') || 'ar';
        return I18N[lang] ? lang : 'ar';
      }

      function applyLanguage(lang) {
        var t = I18N[lang] || I18N.ar;
        var nodes = document.querySelectorAll('[data-i18n]');
        var metaDesc = document.querySelector('meta[name="description"]');

        activeLang = lang;
        document.title = t.pageTitle;
        if (metaDesc) metaDesc.setAttribute('content', t.pageDescription);

        for (var i = 0; i < nodes.length; i++) {
          var key = nodes[i].getAttribute('data-i18n');
          if (t[key]) nodes[i].textContent = t[key];
        }

        examTitleEl.textContent = EXAM_TITLE[lang] || EXAM_TITLE.ar;
        studentNameEl.textContent = STUDENT_NAME;

        renderQuestion();
        renderTimer();
      }

      function renderQuestion() {
        var t = I18N[activeLang] || I18N.ar;
        var questionSet = QUESTIONS[activeLang] || QUESTIONS.he;
        var q = questionSet[currentIndex];

        questionCounterEl.textContent = format(t.counterTemplate, {
          current: String(currentIndex + 1),
          total: String(questionSet.length)
        });
        
        // Progress Indicator (QA Fix #4)
        var answeredCount = 0;
        for(var k=0; k<questionSet.length; k++) {
             var qCheck = questionSet[k];
             if(qCheck.type === 'mc' || qCheck.type === 'True/False') {
                 if(qCheck.answer !== null && qCheck.answer !== undefined) answeredCount++;
             } else {
                 if(qCheck.answer && String(qCheck.answer).trim().length > 0) answeredCount++;
             }
        }
        var progressText = format(t.progressTemplate, { answered: String(answeredCount), total: String(questionSet.length) });
        // Append progress to counter or make a new element. For now appending.
        questionCounterEl.innerHTML = format(t.counterTemplate, {
          current: String(currentIndex + 1),
          total: String(questionSet.length)
        }) + ' <span style="margin-inline-start:10px; font-size:0.85em; opacity:0.8; font-weight:normal;">(' + progressText + ')</span>';

        questionPointsEl.textContent = format(t.pointsTemplate, { points: String(q.points) });
        questionTextEl.innerHTML = q.text;

        questionAnswerEl.innerHTML = '';

        if (q.type === 'open') {
          var ta = document.createElement('textarea');
          ta.placeholder = t.openPlaceholder;
          ta.value = q.answer || '';
          ta.addEventListener('input', function () {
            q.answer = ta.value;
          });
          questionAnswerEl.appendChild(ta);
        } else if (q.type === 'mc') {
          var optionsWrap = document.createElement('div');
          optionsWrap.className = 'options';

          for (var i = 0; i < q.options.length; i++) {
            var id = 'opt-' + currentIndex + '-' + i;
            var label = document.createElement('label');
            label.className = 'option-item';

            var input = document.createElement('input');
            input.type = 'radio';
            input.name = 'question-' + currentIndex;
            input.value = String(i);
            input.id = id;
            if (q.answer === i) input.checked = true;
            input.addEventListener('change', function (event) {
              q.answer = Number(event.target.value);
            });

            var span = document.createElement('span');
            span.innerHTML = q.options[i];

            label.appendChild(input);
            label.appendChild(span);
            optionsWrap.appendChild(label);
          }

          questionAnswerEl.appendChild(optionsWrap);
        }

        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex === questionSet.length - 1;

        if (window.MathJax && window.MathJax.typesetPromise) {
          window.MathJax.typesetPromise([questionTextEl, questionAnswerEl]).catch(function () {});
        }
      }

      function renderTimer() {
        var t = I18N[activeLang] || I18N.ar;
        var minutes = Math.floor(timeLeftSeconds / 60);
        var seconds = timeLeftSeconds % 60;
        var mm = minutes < 10 ? '0' + minutes : String(minutes);
        var ss = seconds < 10 ? '0' + seconds : String(seconds);

        timerLabelEl.textContent = t.timerPrefix + ': ' + mm + ':' + ss;
        timerBadgeEl.classList.toggle('timer--danger', timeLeftSeconds <= 5 * 60);
      }

      function tickTimer() {
        if (timeLeftSeconds <= 0) {
          clearInterval(timerInterval);
          submitExam();
          return;
        }
        timeLeftSeconds -= 1;
        renderTimer();
      }

      function autosavePulse() {
        var t = I18N[activeLang] || I18N.ar;
        autosaveIndicatorEl.classList.add('is-syncing');
        autosaveTextEl.textContent = t.autosaveSaved;
        setTimeout(function () {
          autosaveIndicatorEl.classList.remove('is-syncing');
          autosaveTextEl.textContent = t.autosaveWaiting;
        }, 1200);
      }

      function submitExam() {
        alert((I18N[activeLang] || I18N.ar).submittedMsg || 'تم إرسال الاختبار بنجاح.');
        window.location.href = 'student-dashboard.html';
      }

      function showWarningModal() {
        warningOverlay.classList.add('active');
        warningOverlay.setAttribute('aria-hidden', 'false');
      }

      function hideWarningModal() {
        warningOverlay.classList.remove('active');
        warningOverlay.setAttribute('aria-hidden', 'true');
      }

      function showConfirmModal() {
        confirmOverlay.classList.add('active');
        confirmOverlay.setAttribute('aria-hidden', 'false');
      }

      function hideConfirmModal() {
        confirmOverlay.classList.remove('active');
        confirmOverlay.setAttribute('aria-hidden', 'true');
      }

      function showReviewScreen() {
        var t = I18N[activeLang] || I18N.ar;
        var questionSet = QUESTIONS[activeLang] || QUESTIONS.he;
        
        examShell.style.display = 'none';
        reviewScreen.style.display = 'block';
        
        reviewList.innerHTML = '';
        var table = document.createElement('div');
        table.style.display = 'grid';
        table.style.gap = '10px';
        
        for(var i=0; i<questionSet.length; i++) {
            var q = questionSet[i];
            var isAnswered = false;
             if(q.type === 'mc' || q.type === 'True/False') {
                 if(q.answer !== null && q.answer !== undefined) isAnswered = true;
             } else {
                 if(q.answer && String(q.answer).trim().length > 0) isAnswered = true;
             }
            
            var row = document.createElement('div');
            row.className = 'option-item'; // reuse existing class
            row.style.justifyContent = 'space-between';
            row.style.alignItems = 'center';
            
            var infoDiv = document.createElement('div');
            infoDiv.innerHTML = '<strong>' + (i+1) + '.</strong> ' + (isAnswered 
                ? '<span style="color:var(--color-green-500);"><i class="fas fa-check-circle"></i> ' + t.reviewStatusAnswered + '</span>'
                : '<span style="color:var(--color-red-500);"><i class="fas fa-circle-exclamation"></i> ' + t.reviewStatusUnanswered + '</span>');
            
            var gotoBtn = document.createElement('button');
            gotoBtn.className = 'btn btn--outline btn--sm';
            gotoBtn.textContent = t.reviewGoto;
            (function(idx){
                gotoBtn.onclick = function() {
                    currentIndex = idx;
                    hideReviewScreen();
                    renderQuestion();
                };
            })(i);
            
            row.appendChild(infoDiv);
            row.appendChild(gotoBtn);
            table.appendChild(row);
        }
        reviewList.appendChild(table);
      }

      function hideReviewScreen() {
        reviewScreen.style.display = 'none';
        examShell.style.display = 'grid';
      }

      prevBtn.addEventListener('click', function () {
        if (currentIndex > 0) {
          currentIndex -= 1;
          renderQuestion();
        }
      });

      nextBtn.addEventListener('click', function () {
        var questionSet = QUESTIONS[activeLang] || QUESTIONS.he;
        if (currentIndex < questionSet.length - 1) {
          currentIndex += 1;
          renderQuestion();
        }
      });

      submitBtn.addEventListener('click', function() {
          showReviewScreen();
      });
      
      confirmProceedBtn.addEventListener('click', submitExam);
      confirmCancelBtn.addEventListener('click', hideConfirmModal);
      
      reviewSubmitBtn.addEventListener('click', showConfirmModal);
      returnToExamBtn.addEventListener('click', hideReviewScreen);

      warningClose.addEventListener('click', hideWarningModal);

      document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
          tabViolations += 1;
          if (tabViolations >= 2) {
             showWarningModal();
          }
        }
      });

      document.addEventListener('mitests:languagechange', function (e) {
        var lang = (e.detail && e.detail.lang) || getLang();
        applyLanguage(lang);
      });

      document.addEventListener('DOMContentLoaded', function () {
        applyLanguage(getLang());
        timerInterval = setInterval(tickTimer, 1000);
        autosaveInterval = setInterval(autosavePulse, 10000);
      });
    })();
  </script>
</body>
</html>

