<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mitests - ملف المؤسسة</title>
  <meta name="description" content="صفحة مستقلة لإدارة ملف المؤسسة التعليمية.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <style>
    .school-navbar { border-bottom: 1px solid var(--color-gray-200); }
    body.rtl .main-content .school-navbar { right: var(--sidebar-width); left: 0; }
    body.ltr .main-content .school-navbar { left: var(--sidebar-width); right: 0; }
    body.rtl .main-content.main-content--expanded .school-navbar { right: var(--sidebar-collapsed-width); }
    body.ltr .main-content.main-content--expanded .school-navbar { left: var(--sidebar-collapsed-width); }
    .school-navbar .navbar__brand-icon { background: linear-gradient(135deg, var(--color-school), #fbbf24); }
    .sidebar__item:hover, .sidebar__item--active { background: rgba(245, 158, 11, 0.24); color: var(--color-white); }
    .sidebar__item--active { border-inline-start: 3px solid var(--color-school); }
    .btn--school { background: var(--color-school); border-color: var(--color-school); color: var(--color-white); }
    .main { padding: calc(var(--navbar-height) + var(--space-6)) var(--space-6) var(--space-8); }
    .card-block { background: var(--color-white); border: 1px solid var(--color-gray-200); border-top: 4px solid var(--color-school); border-radius: var(--border-radius-md); box-shadow: var(--shadow-sm); padding: var(--space-4); display: grid; gap: var(--space-3); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); }
    .field { display: grid; gap: var(--space-1); }
    .field label { color: var(--color-gray-700); font-size: var(--font-size-sm); font-weight: 600; }
    .field input, .field textarea, .field select { border: 1px solid var(--color-gray-300); border-radius: var(--border-radius-sm); padding: var(--space-2) var(--space-3); font-family: inherit; }
    .field textarea { min-height: 84px; resize: vertical; }
    @media (max-width: 1023px) {
      body.rtl .main-content .school-navbar { right: var(--sidebar-collapsed-width); }
      body.ltr .main-content .school-navbar { left: var(--sidebar-collapsed-width); }
      body.rtl .main-content { margin-right: var(--sidebar-collapsed-width); }
      body.ltr .main-content { margin-left: var(--sidebar-collapsed-width); }
      .sidebar { width: var(--sidebar-collapsed-width); }
      .sidebar .sidebar__brand-text, .sidebar .sidebar__item span, .sidebar .sidebar__toggle span { display: none; }
      .grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 767px) {
      .sidebar { display: none; }
      body.rtl .main-content, body.ltr .main-content { margin: 0; }
      body.rtl .main-content .school-navbar, body.ltr .main-content .school-navbar { right: 0; left: 0; }
      .main { padding-inline: var(--space-4); }
    }
  </style>
</head>
<body class="rtl">
  <aside class="sidebar" id="sidebar" aria-label="Sidebar navigation">
    <div class="sidebar__header"><div class="sidebar__logo">M</div><span class="sidebar__brand-text">سراج - المدرسة</span></div>
    <nav class="sidebar__nav">
      <a class="sidebar__item" href="school.html"><i class="fas fa-gauge"></i><span>لوحة المدرسة</span></a>
      <a class="sidebar__item sidebar__item--active" href="school-profile.html"><i class="fas fa-id-card"></i><span>ملف المؤسسة</span></a>
      <a class="sidebar__item" href="school-whitelabel.html"><i class="fas fa-palette"></i><span>الهوية المؤسسية</span></a>
      <a class="sidebar__item" href="school-communications.html"><i class="fas fa-comments"></i><span>التواصل والإشعارات</span></a>
      <a class="sidebar__item" href="school-settings.html"><i class="fas fa-gear"></i><span>الإعدادات</span></a>
    </nav>
    <button class="sidebar__toggle" id="sidebar-toggle" aria-label="Toggle sidebar"><i class="fas fa-angles-right"></i><span>تصغير</span></button>
  </aside>

  <div class="main-content" id="main-content">
    <nav class="navbar school-navbar" role="navigation" aria-label="School top navigation">
      <a href="school-profile.html" class="navbar__brand"><div class="navbar__brand-icon"><i class="fas fa-id-card"></i></div><span class="navbar__brand-text">ملف المؤسسة</span></a>
      <div class="navbar__actions">
        <div class="lang-switcher" role="group" aria-label="Language selector">
          <button class="lang-switcher__btn active" data-lang="ar" aria-label="Arabic">&#1593;</button>
          <button class="lang-switcher__btn" data-lang="he" aria-label="Hebrew">&#1506;&#1489;</button>
          <button class="lang-switcher__btn" data-lang="en" aria-label="English">En</button>
        </div>
        <div class="avatar-dropdown">
          <button class="avatar-btn" type="button" data-avatar-toggle="school-avatar-menu" aria-label="قائمة حساب المدرسة"><i class="fas fa-building-columns"></i></button>
          <div class="avatar-menu" id="school-avatar-menu" data-avatar-menu>
            <span class="avatar-menu__label">حساب المدرسة</span>
            <a class="avatar-menu__link" href="school-profile.html"><i class="fas fa-id-card"></i><span>ملف المؤسسة</span></a>
            <a class="avatar-menu__link" href="school-whitelabel.html"><i class="fas fa-palette"></i><span>الهوية المؤسسية</span></a>
            <a class="avatar-menu__link" href="school-communications.html"><i class="fas fa-comments"></i><span>التواصل والإشعارات</span></a>
          </div>
        </div>
        <a href="index.html" class="btn btn--school btn--sm"><i class="fas fa-right-from-bracket"></i><span>تسجيل الخروج</span></a>
      </div>
    </nav>

    <main class="main">
      <section class="card-block">
        <h1>ملف المؤسسة التعليمية</h1>
        <div class="grid">
          <div class="field"><label for="school-name">اسم المؤسسة</label><input id="school-name" value="مدرسة سراج الدولية"></div>
          <div class="field"><label for="school-code">رمز المؤسسة</label><input id="school-code" value="SRJ-RYD-01"></div>
          <div class="field"><label for="school-email">ايميل المؤسسة</label><input id="school-email" value="admin@seraj.edu"></div>
          <div class="field"><label for="school-phone">رقم الهاتف</label><input id="school-phone" value="+966 11 555 7788"></div>
          <div class="field"><label for="school-country">الدولة</label><input id="school-country" value="السعودية"></div>
          <div class="field"><label for="school-address">العنوان</label><input id="school-address" value="الرياض - حي النخيل - شارع الملك فهد"></div>
          <div class="field"><label for="school-language">اللغة الافتراضية</label><select id="school-language"><option value="ar">العربية</option><option value="he">עברית</option><option value="en">English</option></select></div>
          <div class="field"><label for="school-grades">المراحل التعليمية</label><input id="school-grades" value="الصف السابع، الصف الثامن، الصف التاسع"></div>
          <div class="field" style="grid-column:1/-1;"><label for="school-social">روابط التواصل</label><textarea id="school-social">https://x.com/serajschool
https://instagram.com/serajschool</textarea></div>
        </div>
        <div><button class="btn btn--school" id="school-profile-save" type="button">حفظ ملف المؤسسة</button></div>
      </section>
    </main>
  </div>
  <script src="shared-layout.js"></script>
  <script>
    (function () {
      'use strict';

      var fields = {
        name: document.getElementById('school-name'),
        code: document.getElementById('school-code'),
        email: document.getElementById('school-email'),
        phone: document.getElementById('school-phone'),
        country: document.getElementById('school-country'),
        address: document.getElementById('school-address'),
        language: document.getElementById('school-language'),
        grades: document.getElementById('school-grades'),
        social: document.getElementById('school-social')
      };
      var saveBtn = document.getElementById('school-profile-save');
      var schoolsKey = 'mitests-schools';
      var activeCodeKey = 'mitests-active-school-code';

      function loadSchools() {
        try {
          var raw = localStorage.getItem(schoolsKey);
          if (!raw) return [];
          var parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) return parsed;
        } catch (e) {}
        return [];
      }

      function saveSchools(list) {
        try {
          localStorage.setItem(schoolsKey, JSON.stringify(list));
        } catch (e) {}
      }

      function getActiveIndex(list) {
        if (!Array.isArray(list) || !list.length) return -1;
        var activeCode = localStorage.getItem(activeCodeKey);
        if (!activeCode) return 0;
        for (var i = 0; i < list.length; i++) {
          if (String(list[i].code || '').toLowerCase() === String(activeCode).toLowerCase()) return i;
        }
        return 0;
      }

      function splitGrades(value) {
        return String(value || '')
          .split(/[\n,،]/)
          .map(function (item) { return item.trim(); })
          .filter(function (item) { return item.length > 0; });
      }

      function joinGrades(list) {
        if (!Array.isArray(list) || !list.length) return '';
        return list.join('، ');
      }

      function applySchoolToForm(school) {
        var profile = school.profile || {};
        fields.name.value = school.name || '';
        fields.code.value = school.code || '';
        fields.email.value = school.email || '';
        fields.phone.value = profile.phone || school.phone || '';
        fields.country.value = profile.country || school.country || '';
        fields.address.value = profile.address || school.address || '';
        fields.language.value = profile.defaultLanguage || school.defaultLanguage || 'ar';
        fields.grades.value = joinGrades(school.grades || []);
        fields.social.value = profile.socialLinks || school.socialLinks || '';
      }

      function readForm() {
        return {
          name: String(fields.name.value || '').trim(),
          code: String(fields.code.value || '').trim(),
          email: String(fields.email.value || '').trim(),
          phone: String(fields.phone.value || '').trim(),
          country: String(fields.country.value || '').trim(),
          address: String(fields.address.value || '').trim(),
          language: String(fields.language.value || 'ar').trim(),
          grades: splitGrades(fields.grades.value),
          social: String(fields.social.value || '').trim()
        };
      }

      function loadIntoForm() {
        var list = loadSchools();
        var index = getActiveIndex(list);
        if (index < 0 || !list[index]) return;
        applySchoolToForm(list[index]);
      }

      saveBtn.addEventListener('click', function () {
        var formData = readForm();
        if (!formData.name || !formData.code || !formData.email) {
          alert('يرجى تعبئة اسم المؤسسة ورمزها والبريد الإلكتروني.');
          return;
        }

        var list = loadSchools();
        var index = getActiveIndex(list);
        if (index < 0) index = 0;

        var school = list[index] || {};
        school.code = formData.code;
        school.name = formData.name;
        school.email = formData.email;
        school.phone = formData.phone;
        school.country = formData.country;
        school.address = formData.address;
        school.defaultLanguage = formData.language;
        school.socialLinks = formData.social;
        school.grades = formData.grades;
        school.profile = school.profile || {};
        school.profile.phone = formData.phone;
        school.profile.country = formData.country;
        school.profile.address = formData.address;
        school.profile.defaultLanguage = formData.language;
        school.profile.socialLinks = formData.social;
        if (typeof school.tokens === 'undefined') school.tokens = 0;

        if (!list.length) {
          list.push(school);
        } else {
          list[index] = school;
        }

        saveSchools(list);
        localStorage.setItem(activeCodeKey, formData.code);
        if (formData.grades.length) {
          localStorage.setItem('mitests-school-default-grade', formData.grades[0]);
        }
        alert('تم حفظ ملف المؤسسة بنجاح.');
      });

      loadIntoForm();
    })();
  </script>
</body>
</html>

