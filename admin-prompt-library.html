<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mitests - مكتبة البرومبت</title>
  <meta name="description" content="إدارة برومبتات المواد للمسؤول.">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">

  <style>
    .admin-navbar { border-bottom: 1px solid var(--color-gray-200); }
    body.rtl .main-content .admin-navbar { right: var(--sidebar-width); left: 0; }
    body.ltr .main-content .admin-navbar { left: var(--sidebar-width); right: 0; }
    body.rtl .main-content.main-content--expanded .admin-navbar { right: var(--sidebar-collapsed-width); }
    body.ltr .main-content.main-content--expanded .admin-navbar { left: var(--sidebar-collapsed-width); }

    .admin-navbar .navbar__brand-icon { background: linear-gradient(135deg, var(--color-admin), #f38a8d); }
    .sidebar__item:hover, .sidebar__item--active { background: rgba(239, 93, 96, 0.2); color: var(--color-white); }
    .sidebar__item--active { border-inline-start: 3px solid var(--color-admin); }
    .btn--admin { background: var(--color-admin); border-color: var(--color-admin); color: var(--color-white); }
    .btn--admin:hover { background: #db4f53; border-color: #db4f53; color: var(--color-white); }

    .main { padding: calc(var(--navbar-height) + var(--space-6)) var(--space-6) var(--space-8); display: grid; gap: var(--space-4); }
    .head { background: var(--color-white); border-top: 4px solid var(--color-admin); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-md); padding: var(--space-5); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-3); }
    .head h1 { font-size: var(--font-size-3xl); color: var(--color-gray-900); margin-bottom: var(--space-1); }
    .head p { color: var(--color-gray-600); }

    .card-block { background: var(--color-white); border: 1px solid var(--color-gray-200); border-top: 4px solid var(--color-admin); border-radius: var(--border-radius-md); box-shadow: var(--shadow-sm); padding: var(--space-4); display: grid; gap: var(--space-3); }
    .table-wrap { overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; min-width: 760px; }
    .data-table th, .data-table td { padding: var(--space-3); border-bottom: 1px solid var(--color-gray-200); text-align: start; font-size: var(--font-size-sm); vertical-align: top; }
    .data-table th { background: var(--color-gray-50); color: var(--color-gray-500); font-weight: 700; }

    .prompt-preview {
      color: var(--color-gray-700);
      line-height: 1.8;
      max-width: 520px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .actions { display: flex; justify-content: space-between; gap: var(--space-3); flex-wrap: wrap; }
    .modal-body { padding: var(--space-4) var(--space-6) var(--space-6); display: grid; gap: var(--space-3); }
    .field { display: grid; gap: var(--space-1); }
    .field label { color: var(--color-gray-700); font-size: var(--font-size-sm); font-weight: 600; }
    .field input, .field textarea, .field select {
      border: 1px solid var(--color-gray-300);
      border-radius: var(--border-radius-sm);
      padding: var(--space-2) var(--space-3);
      font-family: inherit;
      color: var(--color-gray-800);
      background: var(--color-white);
    }
    .field textarea { min-height: 160px; resize: vertical; }
    .field input:focus, .field textarea:focus, .field select:focus {
      outline: none;
      border-color: var(--color-admin);
      box-shadow: 0 0 0 3px rgba(239, 93, 96, 0.16);
    }

    .helper { color: var(--color-gray-500); font-size: var(--font-size-xs); line-height: 1.7; }
    .status-chip {
      border-radius: var(--border-radius-full);
      background: var(--color-coral-100);
      color: var(--color-admin);
      font-weight: 700;
      font-size: var(--font-size-xs);
      padding: var(--space-1) var(--space-3);
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
    }

    .modal-actions { display: flex; justify-content: space-between; flex-wrap: wrap; gap: var(--space-2); padding-top: var(--space-2); border-top: 1px solid var(--color-gray-200); }

    @media (max-width: 1023px) {
      body.rtl .main-content .admin-navbar { right: var(--sidebar-collapsed-width); }
      body.ltr .main-content .admin-navbar { left: var(--sidebar-collapsed-width); }
      body.rtl .main-content { margin-right: var(--sidebar-collapsed-width); }
      body.ltr .main-content { margin-left: var(--sidebar-collapsed-width); }
      .sidebar { width: var(--sidebar-collapsed-width); }
      .sidebar .sidebar__brand-text, .sidebar .sidebar__item span, .sidebar .sidebar__toggle span { display: none; }
    }

    @media (max-width: 767px) {
      .sidebar { display: none; }
      body.rtl .main-content, body.ltr .main-content { margin: 0; }
      body.rtl .main-content .admin-navbar, body.ltr .main-content .admin-navbar { right: 0; left: 0; }
      .main { padding-inline: var(--space-4); }
      .actions .btn, .modal-actions .btn { width: 100%; }
      .modal__header, .modal-body { padding-inline: var(--space-4); }
    }
  </style>
</head>
<body class="rtl">
  <aside class="sidebar" id="sidebar" aria-label="Sidebar navigation">
    <div class="sidebar__header"><div class="sidebar__logo">M</div><span class="sidebar__brand-text">سراج - الإدارة</span></div>
    <nav class="sidebar__nav">
      <a class="sidebar__item" href="admin-dashboard.html"><i class="fas fa-gauge"></i><span>نظرة عامة</span></a>
      <a class="sidebar__item" href="admin-ai-config.html"><i class="fas fa-robot"></i><span>إعدادات AI</span></a>
      <a class="sidebar__item sidebar__item--active" href="admin-prompt-library.html"><i class="fas fa-book-open"></i><span>مكتبة البرومبت</span></a>
      <a class="sidebar__item" href="admin-plans.html"><i class="fas fa-layer-group"></i><span>الخطط والاشتراكات</span></a>
      <a class="sidebar__item" href="admin-schools.html"><i class="fas fa-school"></i><span>إدارة المدارس</span></a>
      <a class="sidebar__item" href="admin-settings.html"><i class="fas fa-gear"></i><span>الإعدادات</span></a>
      <a class="sidebar__item" href="admin-profile.html"><i class="fas fa-id-badge"></i><span>ملفي الشخصي</span></a>
    </nav>
    <button class="sidebar__toggle" id="sidebar-toggle" aria-label="Toggle sidebar"><i class="fas fa-angles-right"></i><span>تصغير</span></button>
  </aside>

  <div class="main-content" id="main-content">
    <nav class="navbar admin-navbar" role="navigation" aria-label="Admin top navigation">
      <a href="admin-dashboard.html" class="navbar__brand">
        <div class="navbar__brand-icon"><i class="fas fa-book-open"></i></div>
        <span class="navbar__brand-text">مكتبة البرومبت</span>
      </a>
      <div class="navbar__actions">
        <div class="lang-switcher" role="group" aria-label="Language selector">
          <button class="lang-switcher__btn active" data-lang="ar" aria-label="Arabic">&#1593;</button>
          <button class="lang-switcher__btn" data-lang="he" aria-label="Hebrew">&#1506;&#1489;</button>
          <button class="lang-switcher__btn" data-lang="en" aria-label="English">En</button>
        </div>
        <div class="avatar-dropdown">
          <button class="avatar-btn" type="button" data-avatar-toggle="admin-avatar-menu" aria-label="قائمة الحساب">
            <i class="fas fa-user-shield"></i>
          </button>
          <div class="avatar-menu" id="admin-avatar-menu" data-avatar-menu>
            <span class="avatar-menu__label">حساب المدير</span>
            <a class="avatar-menu__link" href="admin-profile.html"><i class="fas fa-id-card"></i><span>ملفي الشخصي</span></a>
            <a class="avatar-menu__link" href="admin-dashboard.html"><i class="fas fa-gauge"></i><span>لوحة الإدارة</span></a>
          </div>
        </div>
        <a href="index.html" class="btn btn--admin btn--sm"><i class="fas fa-right-from-bracket"></i><span>تسجيل الخروج</span></a>
      </div>
    </nav>

    <main class="main">
      <header class="head">
        <div>
          <h1>مكتبة برومبت المواد</h1>
          <p>إدارة مركزية للبرومبتات الأكاديمية مع تحرير مباشر وإضافة موضوعات جديدة.</p>
        </div>
        <span class="status-chip"><i class="fas fa-bolt"></i><span id="prompt-count">0 برومبت</span></span>
      </header>

      <section class="card-block">
        <div class="table-wrap">
          <table class="data-table">
            <thead>
              <tr>
                <th>المادة</th>
                <th>البرومبت المختصر</th>
                <th>آخر تحديث</th>
                <th>المسؤول</th>
                <th>الإجراء</th>
              </tr>
            </thead>
            <tbody id="prompts-body"></tbody>
          </table>
        </div>
      </section>

      <section class="actions">
        <a href="admin-dashboard.html" class="btn btn--outline">العودة للوحة</a>
        <button class="btn btn--admin" data-modal-open="add-prompt-modal"><i class="fas fa-plus"></i><span>إضافة برومبت جديد</span></button>
      </section>
    </main>
  </div>

  <div class="modal-overlay" id="edit-prompt-modal" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="edit-prompt-title" aria-modal="true">
      <div class="modal__header">
        <h2 id="edit-prompt-title">تعديل البرومبت</h2>
        <button class="modal__close" data-modal-close aria-label="Close"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-prompt-id">
        <div class="field">
          <label for="edit-prompt-subject">المادة</label>
          <input id="edit-prompt-subject" type="text" readonly>
        </div>
        <div class="field">
          <label for="edit-prompt-owner">المسؤول</label>
          <input id="edit-prompt-owner" type="text" placeholder="مثال: فريق المناهج">
        </div>
        <div class="field">
          <label for="edit-prompt-text">نص البرومبت</label>
          <textarea id="edit-prompt-text" placeholder="اكتب البرومبت المخصص لهذه المادة..."></textarea>
        </div>
        <div class="modal-actions">
          <button class="btn btn--outline" data-modal-close type="button">إلغاء</button>
          <button class="btn btn--admin" id="save-edit-prompt" type="button">حفظ التعديلات</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="add-prompt-modal" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="add-prompt-title" aria-modal="true">
      <div class="modal__header">
        <h2 id="add-prompt-title">إضافة برومبت جديد</h2>
        <button class="modal__close" data-modal-close aria-label="Close"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label for="add-prompt-subject">المادة</label>
          <select id="add-prompt-subject"></select>
        </div>
        <div class="field">
          <label for="add-prompt-owner">المسؤول</label>
          <input id="add-prompt-owner" type="text" placeholder="مثال: فريق التقييم">
        </div>
        <div class="field">
          <label for="add-prompt-text">نص البرومبت</label>
          <textarea id="add-prompt-text" placeholder="اكتب برومبت المادة بالشكل الاحترافي المطلوب..."></textarea>
          <p class="helper">إذا كانت المادة موجودة مسبقًا سيتم تحديث برومبتها بنفس النموذج.</p>
        </div>
        <div class="modal-actions">
          <button class="btn btn--outline" data-modal-close type="button">إلغاء</button>
          <button class="btn btn--admin" id="save-add-prompt" type="button">إضافة البرومبت</button>
        </div>
      </div>
    </div>
  </div>

  <script src="shared-layout.js"></script>
  <script>
    (function () {
      'use strict';

      var promptsKey = 'mitests-subject-prompts';
      var subjectsKey = 'mitests-admin-subjects';

      var promptsBodyEl = document.getElementById('prompts-body');
      var promptCountEl = document.getElementById('prompt-count');

      var editModalEl = document.getElementById('edit-prompt-modal');
      var addModalEl = document.getElementById('add-prompt-modal');

      var editIdEl = document.getElementById('edit-prompt-id');
      var editSubjectEl = document.getElementById('edit-prompt-subject');
      var editOwnerEl = document.getElementById('edit-prompt-owner');
      var editTextEl = document.getElementById('edit-prompt-text');

      var addSubjectEl = document.getElementById('add-prompt-subject');
      var addOwnerEl = document.getElementById('add-prompt-owner');
      var addTextEl = document.getElementById('add-prompt-text');

      var defaultPrompts = [
        {
          id: 'prompt-en',
          subject: 'اللغة الإنجليزية',
          prompt: 'أنشئ اختبارًا يوازن بين الفهم القرائي والكتابة التحليلية مع تنويع مستويات بلوم وتقديم Rubric واضح للتصحيح.',
          updatedAt: '2026-02-05',
          owner: 'فريق المناهج'
        },
        {
          id: 'prompt-math',
          subject: 'الرياضيات',
          prompt: 'ولّد أسئلة تدريجية تبدأ من المهارات الأساسية ثم تنتقل إلى حل المسائل المركبة، مع إظهار خطوات الحل المتوقعة.',
          updatedAt: '2026-02-10',
          owner: 'فريق التقييم'
        },
        {
          id: 'prompt-science',
          subject: 'العلوم',
          prompt: 'صمّم أسئلة تقيس التفسير العلمي وربط المفاهيم بالتجارب، مع أسئلة تحليل بيانات مختبرية قصيرة.',
          updatedAt: '2026-02-09',
          owner: 'فريق البحث'
        }
      ];

      function escapeHtml(value) {
        return String(value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function closeModal(modalEl) {
        if (!modalEl) return;
        modalEl.classList.remove('modal-overlay--active');
        modalEl.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }

      function openModal(modalEl) {
        if (!modalEl) return;
        modalEl.classList.add('modal-overlay--active');
        modalEl.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      }

      function todayStamp() {
        var d = new Date();
        var m = String(d.getMonth() + 1).padStart(2, '0');
        var day = String(d.getDate()).padStart(2, '0');
        return d.getFullYear() + '-' + m + '-' + day;
      }

      function readStorageArray(key, fallback) {
        try {
          var raw = localStorage.getItem(key);
          if (!raw) return fallback.slice();
          var parsed = JSON.parse(raw);
          if (Array.isArray(parsed) && parsed.length) return parsed;
        } catch (e) {}
        return fallback.slice();
      }

      function loadPrompts() {
        var list = readStorageArray(promptsKey, defaultPrompts);
        var normalized = [];

        for (var i = 0; i < list.length; i++) {
          var row = list[i] || {};
          normalized.push({
            id: String(row.id || ('prompt-' + (i + 1))).trim(),
            subject: String(row.subject || '').trim(),
            prompt: String(row.prompt || '').trim(),
            updatedAt: String(row.updatedAt || todayStamp()).trim(),
            owner: String(row.owner || 'فريق المناهج').trim()
          });
        }

        return normalized.filter(function (item) { return item.subject; });
      }

      function savePrompts(list) {
        try {
          localStorage.setItem(promptsKey, JSON.stringify(list));
        } catch (e) {}
      }

      function loadSubjects() {
        var fallback = ['اللغة الإنجليزية', 'الرياضيات', 'العلوم'];
        var subjects = readStorageArray(subjectsKey, fallback);
        var filtered = [];

        for (var i = 0; i < subjects.length; i++) {
          var value = String(subjects[i] || '').trim();
          if (value && filtered.indexOf(value) === -1) filtered.push(value);
        }

        if (!filtered.length) return fallback;
        return filtered;
      }

      var prompts = loadPrompts();

      function renderSubjectOptions() {
        var subjects = loadSubjects();
        addSubjectEl.innerHTML = '';

        for (var i = 0; i < subjects.length; i++) {
          var opt = document.createElement('option');
          opt.value = subjects[i];
          opt.textContent = subjects[i];
          addSubjectEl.appendChild(opt);
        }
      }

      function renderTable() {
        promptsBodyEl.innerHTML = '';

        for (var i = 0; i < prompts.length; i++) {
          var row = prompts[i];
          var tr = document.createElement('tr');
          tr.innerHTML = '' +
            '<td>' + escapeHtml(row.subject) + '</td>' +
            '<td><p class="prompt-preview">' + escapeHtml(row.prompt) + '</p></td>' +
            '<td>' + escapeHtml(row.updatedAt) + '</td>' +
            '<td>' + escapeHtml(row.owner) + '</td>' +
            '<td><button class="btn btn--admin btn--sm" type="button" data-edit-id="' + escapeHtml(row.id) + '">تعديل البرومبت</button></td>';
          promptsBodyEl.appendChild(tr);
        }

        promptCountEl.textContent = prompts.length + ' برومبت';
      }

      function openEditById(id) {
        var target = null;
        for (var i = 0; i < prompts.length; i++) {
          if (prompts[i].id === id) {
            target = prompts[i];
            break;
          }
        }

        if (!target) return;

        editIdEl.value = target.id;
        editSubjectEl.value = target.subject;
        editOwnerEl.value = target.owner;
        editTextEl.value = target.prompt;
        openModal(editModalEl);
      }

      promptsBodyEl.addEventListener('click', function (e) {
        var btn = e.target.closest('[data-edit-id]');
        if (!btn) return;
        openEditById(btn.getAttribute('data-edit-id'));
      });

      document.getElementById('save-edit-prompt').addEventListener('click', function () {
        var id = String(editIdEl.value || '').trim();
        var owner = String(editOwnerEl.value || '').trim() || 'فريق المناهج';
        var prompt = String(editTextEl.value || '').trim();

        if (!id || !prompt) {
          alert('يرجى إدخال نص البرومبت.');
          return;
        }

        for (var i = 0; i < prompts.length; i++) {
          if (prompts[i].id !== id) continue;
          prompts[i].owner = owner;
          prompts[i].prompt = prompt;
          prompts[i].updatedAt = todayStamp();
          break;
        }

        savePrompts(prompts);
        renderTable();
        closeModal(editModalEl);
      });

      document.getElementById('save-add-prompt').addEventListener('click', function () {
        var subject = String(addSubjectEl.value || '').trim();
        var owner = String(addOwnerEl.value || '').trim() || 'فريق المناهج';
        var prompt = String(addTextEl.value || '').trim();

        if (!subject || !prompt) {
          alert('يرجى تحديد المادة وكتابة البرومبت.');
          return;
        }

        var existing = null;
        for (var i = 0; i < prompts.length; i++) {
          if (prompts[i].subject === subject) {
            existing = prompts[i];
            break;
          }
        }

        if (existing) {
          existing.owner = owner;
          existing.prompt = prompt;
          existing.updatedAt = todayStamp();
        } else {
          prompts.push({
            id: 'prompt-' + Date.now().toString(36),
            subject: subject,
            prompt: prompt,
            updatedAt: todayStamp(),
            owner: owner
          });
        }

        savePrompts(prompts);
        renderTable();

        addOwnerEl.value = '';
        addTextEl.value = '';
        closeModal(addModalEl);
      });

      document.addEventListener('click', function (e) {
        var trigger = e.target.closest('[data-modal-open="add-prompt-modal"]');
        if (!trigger) return;
        renderSubjectOptions();
      });

      document.addEventListener('keydown', function (e) {
        if (e.key !== 'Escape') return;
        closeModal(editModalEl);
        closeModal(addModalEl);
      });

      document.addEventListener('DOMContentLoaded', function () {
        renderSubjectOptions();
        renderTable();
      });
    })();
  </script>
</body>
</html>



