<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mitests - كتالوج المواد</title>
  <meta name="description" content="إدارة كتالوج المواد الدراسي المركزي عبر قائمة منظمة بإضافة وحذف وتعديل.">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">

  <style>
    .admin-navbar { border-bottom: 1px solid var(--color-gray-200); }
    body.rtl .main-content .admin-navbar { right: var(--sidebar-width); left: 0; }
    body.ltr .main-content .admin-navbar { left: var(--sidebar-width); right: 0; }
    body.rtl .main-content.main-content--expanded .admin-navbar { right: var(--sidebar-collapsed-width); }
    body.ltr .main-content.main-content--expanded .admin-navbar { left: var(--sidebar-collapsed-width); }

    .admin-navbar .navbar__brand-icon { background: linear-gradient(135deg, var(--color-admin), #f38a8d); }
    .sidebar__item:hover, .sidebar__item--active { background: rgba(239, 93, 96, 0.2); color: var(--color-white); }
    .sidebar__item--active { border-inline-start: 3px solid var(--color-admin); }

    .btn--admin { background: var(--color-admin); border-color: var(--color-admin); color: var(--color-white); }
    .btn--admin:hover { background: #db4f53; border-color: #db4f53; color: var(--color-white); }

    .main {
      padding: calc(var(--navbar-height) + var(--space-6)) var(--space-6) var(--space-8);
      display: grid;
      gap: var(--space-4);
    }

    .head {
      background: var(--color-white);
      border-top: 4px solid var(--color-admin);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-md);
      padding: var(--space-5);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: var(--space-4);
      flex-wrap: wrap;
    }

    .head h1 {
      color: var(--color-gray-900);
      font-size: var(--font-size-3xl);
      margin: 0 0 var(--space-1);
    }

    .head p {
      color: var(--color-gray-600);
      margin: 0;
    }

    .count-chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      background: var(--color-coral-100);
      border: 1px solid var(--color-coral-500);
      color: var(--color-admin);
      border-radius: var(--border-radius-full);
      padding: var(--space-2) var(--space-4);
      font-weight: 700;
      font-size: var(--font-size-sm);
      white-space: nowrap;
    }

    .catalog-card {
      background: var(--color-white);
      border: 1px solid var(--color-gray-200);
      border-top: 4px solid var(--color-admin);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-sm);
      padding: var(--space-4);
      display: grid;
      gap: var(--space-3);
    }

    .toolbar {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: var(--space-3);
      align-items: end;
    }

    .field {
      display: grid;
      gap: var(--space-1);
    }

    .field label {
      color: var(--color-gray-700);
      font-size: var(--font-size-sm);
      font-weight: 600;
    }

    .field input {
      border: 1px solid var(--color-gray-300);
      border-radius: var(--border-radius-sm);
      padding: var(--space-2) var(--space-3);
      font-family: inherit;
      color: var(--color-gray-800);
      background: var(--color-white);
      min-width: 240px;
    }

    .field input:focus {
      outline: none;
      border-color: var(--color-admin);
      box-shadow: 0 0 0 3px rgba(239, 93, 96, 0.16);
    }

    .toolbar-actions {
      display: flex;
      gap: var(--space-2);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .helper-text {
      color: var(--color-gray-500);
      font-size: var(--font-size-xs);
      margin: 0;
      line-height: 1.7;
    }

    .tools-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: var(--space-3);
      align-items: end;
    }

    .status-note {
      color: var(--color-gray-600);
      font-size: var(--font-size-sm);
      font-weight: 600;
      min-height: 22px;
      margin: 0;
    }

    .status-note--success { color: #15803d; }
    .status-note--warn { color: #b45309; }
    .status-note--danger { color: #b91c1c; }

    .table-wrap {
      overflow-x: auto;
      border: 1px solid var(--color-gray-200);
      border-radius: var(--border-radius-md);
    }

    .catalog-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 680px;
      background: var(--color-white);
    }

    .catalog-table th,
    .catalog-table td {
      text-align: start;
      padding: var(--space-3);
      border-bottom: 1px solid var(--color-gray-200);
      font-size: var(--font-size-sm);
    }

    .catalog-table th {
      background: var(--color-gray-50);
      color: var(--color-gray-500);
      font-weight: 700;
    }

    .item-name {
      font-weight: 600;
      color: var(--color-gray-900);
    }

    .index-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      height: 32px;
      border-radius: var(--border-radius-full);
      background: var(--color-coral-100);
      color: var(--color-admin);
      font-weight: 700;
      font-size: var(--font-size-xs);
    }

    .actions-cell {
      display: flex;
      gap: var(--space-2);
      justify-content: flex-end;
      align-items: center;
    }

    .btn-icon {
      width: 34px;
      height: 34px;
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--color-gray-300);
      background: var(--color-white);
      color: var(--color-gray-700);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .btn-icon:hover {
      border-color: var(--color-admin);
      color: var(--color-admin);
      background: var(--color-coral-100);
    }

    .btn-icon--danger:hover {
      border-color: #b91c1c;
      color: #b91c1c;
      background: #fee2e2;
    }

    .empty-state {
      padding: var(--space-6);
      text-align: center;
      color: var(--color-gray-500);
      display: grid;
      gap: var(--space-2);
      background: var(--color-gray-50);
    }

    .empty-state i {
      font-size: 1.3rem;
      color: var(--color-gray-400);
    }

    .footer-actions {
      display: flex;
      justify-content: space-between;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    @media (max-width: 1023px) {
      body.rtl .main-content .admin-navbar { right: var(--sidebar-collapsed-width); }
      body.ltr .main-content .admin-navbar { left: var(--sidebar-collapsed-width); }
      body.rtl .main-content { margin-right: var(--sidebar-collapsed-width); }
      body.ltr .main-content { margin-left: var(--sidebar-collapsed-width); }
      .sidebar { width: var(--sidebar-collapsed-width); }
      .sidebar .sidebar__brand-text, .sidebar .sidebar__item span, .sidebar .sidebar__toggle span { display: none; }
    }

    @media (max-width: 767px) {
      .sidebar { display: none; }
      body.rtl .main-content, body.ltr .main-content { margin: 0; }
      body.rtl .main-content .admin-navbar, body.ltr .main-content .admin-navbar { right: 0; left: 0; }
      .main { padding-inline: var(--space-4); }
      .toolbar, .tools-row { grid-template-columns: 1fr; }
      .toolbar-actions, .footer-actions { justify-content: stretch; }
      .toolbar-actions .btn, .footer-actions .btn { width: 100%; justify-content: center; }
      .head { align-items: stretch; }
      .count-chip { width: fit-content; }
    }
  </style>
</head>
<body class="rtl">
  <aside class="sidebar" id="sidebar" aria-label="Sidebar navigation">
    <div class="sidebar__header"><div class="sidebar__logo">M</div><span class="sidebar__brand-text">سراج - الإدارة</span></div>
    <nav class="sidebar__nav">
      <a class="sidebar__item" href="admin-dashboard.html"><i class="fas fa-gauge"></i><span>نظرة عامة</span></a>
      <a class="sidebar__item" href="admin-ai-config.html"><i class="fas fa-robot"></i><span>إعدادات AI</span></a>
      <a class="sidebar__item" href="admin-prompt-library.html"><i class="fas fa-book-open"></i><span>مكتبة البرومبت</span></a>
      <a class="sidebar__item" href="admin-plans.html"><i class="fas fa-layer-group"></i><span>الخطط والاشتراكات</span></a>
      <a class="sidebar__item" href="admin-schools.html"><i class="fas fa-school"></i><span>إدارة المدارس</span></a>
      <a class="sidebar__item sidebar__item--active" href="admin-settings.html"><i class="fas fa-gear"></i><span>الإعدادات</span></a>
      <a class="sidebar__item" href="admin-profile.html"><i class="fas fa-id-badge"></i><span>ملفي الشخصي</span></a>
    </nav>
    <button class="sidebar__toggle" id="sidebar-toggle" aria-label="Toggle sidebar"><i class="fas fa-angles-right"></i><span>تصغير</span></button>
  </aside>

  <div class="main-content" id="main-content">
    <nav class="navbar admin-navbar" role="navigation" aria-label="Admin top navigation">
      <a href="admin-subjects-catalog.html" class="navbar__brand">
        <div class="navbar__brand-icon"><i class="fas fa-book"></i></div>
        <span class="navbar__brand-text">كتالوج المواد</span>
      </a>
      <div class="navbar__actions">
        <div class="lang-switcher" role="group" aria-label="Language selector">
          <button class="lang-switcher__btn active" data-lang="ar" aria-label="Arabic">&#1593;</button>
          <button class="lang-switcher__btn" data-lang="he" aria-label="Hebrew">&#1506;&#1489;</button>
          <button class="lang-switcher__btn" data-lang="en" aria-label="English">En</button>
        </div>
        <div class="avatar-dropdown">
          <button class="avatar-btn" type="button" data-avatar-toggle="admin-avatar-menu" aria-label="قائمة الحساب">
            <i class="fas fa-user-shield"></i>
          </button>
          <div class="avatar-menu" id="admin-avatar-menu" data-avatar-menu>
            <span class="avatar-menu__label">حساب المدير</span>
            <a class="avatar-menu__link" href="admin-profile.html"><i class="fas fa-id-card"></i><span>ملفي الشخصي</span></a>
            <a class="avatar-menu__link" href="admin-dashboard.html"><i class="fas fa-gauge"></i><span>لوحة الإدارة</span></a>
          </div>
        </div>
        <a href="index.html" class="btn btn--admin btn--sm"><i class="fas fa-right-from-bracket"></i><span>تسجيل الخروج</span></a>
      </div>
    </nav>

    <main class="main">
      <header class="head">
        <div>
          <h1>كتالوج المواد (إداري)</h1>
          <p>أضف المواد واحدة تلو الأخرى، وستظهر مباشرة في القوائم الخاصة بالمدارس والمعلمين.</p>
        </div>
        <div class="count-chip"><i class="fas fa-book-open-reader"></i><span id="item-count">0 مادة</span></div>
      </header>

      <section class="catalog-card">
        <div class="toolbar">
          <div class="field">
            <label for="new-item-input">إضافة مادة جديدة</label>
            <input id="new-item-input" type="text" placeholder="مثال: الرياضيات">
            <p class="helper-text">يمكنك الضغط Enter للإضافة السريعة.</p>
          </div>
          <div class="toolbar-actions">
            <button class="btn btn--admin" id="add-item-btn"><i class="fas fa-plus"></i><span>إضافة</span></button>
          </div>
        </div>

        <div class="tools-row">
          <div class="field">
            <label for="search-input">بحث داخل المواد</label>
            <input id="search-input" type="text" placeholder="ابحث باسم المادة...">
          </div>
          <button class="btn btn--outline" id="reset-defaults-btn"><i class="fas fa-rotate-left"></i><span>استرجاع الافتراضي</span></button>
        </div>

        <p class="status-note" id="status-note" aria-live="polite"></p>

        <div class="table-wrap">
          <table class="catalog-table">
            <thead>
              <tr>
                <th style="width: 90px;">#</th>
                <th>اسم المادة</th>
                <th style="width: 170px; text-align: end;">إجراءات</th>
              </tr>
            </thead>
            <tbody id="catalog-body"></tbody>
          </table>
        </div>

        <div class="footer-actions">
          <a href="admin-settings.html" class="btn btn--outline"><i class="fas fa-arrow-right"></i><span>العودة إلى الإعدادات</span></a>
        </div>
      </section>
    </main>
  </div>

  <script src="shared-layout.js"></script>
  <script>
    (function () {
      'use strict';

      var storageKey = 'mitests-admin-subjects';

      var defaultItems = [
        'اللغة العربية', 'اللغة الإنجليزية', 'الرياضيات', 'العلوم', 'الفيزياء', 'الكيمياء',
        'الأحياء', 'التاريخ', 'الجغرافيا', 'التربية الإسلامية', 'الحاسوب'
      ];

      var inputEl = document.getElementById('new-item-input');
      var addBtn = document.getElementById('add-item-btn');
      var searchEl = document.getElementById('search-input');
      var resetBtn = document.getElementById('reset-defaults-btn');
      var tableBody = document.getElementById('catalog-body');
      var countEl = document.getElementById('item-count');
      var statusEl = document.getElementById('status-note');

      var items = loadItems();

      function normalizeText(value) {
        return String(value || '').replace(/\s+/g, ' ').trim();
      }

      function loadItems() {
        var list = defaultItems.slice();
        try {
          var raw = localStorage.getItem(storageKey);
          if (raw) {
            var parsed = JSON.parse(raw);
            if (Array.isArray(parsed) && parsed.length) {
              list = parsed.map(normalizeText).filter(Boolean);
            }
          }
        } catch (e) {}
        return uniqueItems(list);
      }

      function uniqueItems(list) {
        var out = [];
        for (var i = 0; i < list.length; i++) {
          var value = normalizeText(list[i]);
          if (!value) continue;
          if (!containsItem(value, out)) out.push(value);
        }
        return out;
      }

      function containsItem(value, source, ignoreIndex) {
        var needle = normalizeText(value).toLowerCase();
        var list = source || items;
        for (var i = 0; i < list.length; i++) {
          if (typeof ignoreIndex === 'number' && i === ignoreIndex) continue;
          if (normalizeText(list[i]).toLowerCase() === needle) return true;
        }
        return false;
      }

      function saveItems() {
        try { localStorage.setItem(storageKey, JSON.stringify(items)); } catch (e) {}
      }

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function renderTable() {
        if (!tableBody) return;

        var query = normalizeText(searchEl && searchEl.value).toLowerCase();
        var rows = [];

        for (var i = 0; i < items.length; i++) {
          var name = items[i];
          if (query && name.toLowerCase().indexOf(query) === -1) continue;
          rows.push({ index: i, name: name });
        }

        if (countEl) {
          countEl.textContent = items.length + ' مادة';
        }

        if (!rows.length) {
          tableBody.innerHTML = '<tr><td colspan="3"><div class="empty-state"><i class="fas fa-inbox"></i><span>لا توجد نتائج مطابقة. جرّب عبارة بحث أخرى أو أضف مادة جديدة.</span></div></td></tr>';
          return;
        }

        var html = '';
        for (var j = 0; j < rows.length; j++) {
          var row = rows[j];
          html += '' +
            '<tr>' +
              '<td><span class="index-badge">' + (j + 1) + '</span></td>' +
              '<td><span class="item-name">' + escapeHtml(row.name) + '</span></td>' +
              '<td>' +
                '<div class="actions-cell">' +
                  '<button class="btn-icon" type="button" data-action="edit" data-index="' + row.index + '" aria-label="تعديل المادة"><i class="fas fa-pen"></i></button>' +
                  '<button class="btn-icon btn-icon--danger" type="button" data-action="delete" data-index="' + row.index + '" aria-label="حذف المادة"><i class="fas fa-trash"></i></button>' +
                '</div>' +
              '</td>' +
            '</tr>';
        }

        tableBody.innerHTML = html;
      }

      function setStatus(message, type) {
        if (!statusEl) return;
        statusEl.textContent = message || '';
        statusEl.className = 'status-note';
        if (!type) return;
        statusEl.classList.add('status-note--' + type);
      }

      function addItem() {
        var value = normalizeText(inputEl && inputEl.value);
        if (!value) {
          setStatus('اكتب اسم مادة قبل الإضافة.', 'warn');
          if (inputEl) inputEl.focus();
          return;
        }

        if (containsItem(value)) {
          setStatus('هذه المادة موجودة بالفعل.', 'warn');
          return;
        }

        items.push(value);
        saveItems();
        renderTable();
        setStatus('تمت إضافة المادة بنجاح.', 'success');

        if (inputEl) {
          inputEl.value = '';
          inputEl.focus();
        }
      }

      function editItem(index) {
        var oldValue = items[index];
        if (!oldValue) return;

        var updated = prompt('تعديل اسم المادة:', oldValue);
        if (updated === null) return;

        updated = normalizeText(updated);
        if (!updated) {
          setStatus('لا يمكن حفظ اسم فارغ.', 'danger');
          return;
        }

        if (containsItem(updated, items, index)) {
          setStatus('الاسم الجديد مكرر في القائمة.', 'warn');
          return;
        }

        items[index] = updated;
        saveItems();
        renderTable();
        setStatus('تم تعديل المادة بنجاح.', 'success');
      }

      function deleteItem(index) {
        var value = items[index];
        if (!value) return;

        if (!confirm('هل تريد حذف "' + value + '" من القائمة؟')) return;

        items.splice(index, 1);
        saveItems();
        renderTable();
        setStatus('تم حذف المادة.', 'success');
      }

      if (addBtn) {
        addBtn.addEventListener('click', addItem);
      }

      if (inputEl) {
        inputEl.addEventListener('keydown', function (event) {
          if (event.key === 'Enter') {
            event.preventDefault();
            addItem();
          }
        });
      }

      if (searchEl) {
        searchEl.addEventListener('input', renderTable);
      }

      if (resetBtn) {
        resetBtn.addEventListener('click', function () {
          if (!confirm('استرجاع القائمة الافتراضية سيستبدل القائمة الحالية. متابعة؟')) return;
          items = defaultItems.slice();
          saveItems();
          renderTable();
          setStatus('تم استرجاع القائمة الافتراضية للمواد.', 'success');
        });
      }

      if (tableBody) {
        tableBody.addEventListener('click', function (event) {
          var trigger = event.target.closest('[data-action]');
          if (!trigger) return;

          var action = trigger.getAttribute('data-action');
          var index = parseInt(trigger.getAttribute('data-index'), 10);
          if (isNaN(index)) return;

          if (action === 'edit') editItem(index);
          if (action === 'delete') deleteItem(index);
        });
      }

      renderTable();
      setStatus('يمكنك الآن إدارة المواد بإضافة/تعديل/حذف مباشر.', 'success');
    })();
  </script>
</body>
</html>
