<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mitests - محرر الاختبار</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <style>
    .teacher-navbar{border-bottom:1px solid var(--color-gray-200)}
    body.rtl .main-content .teacher-navbar{right:var(--sidebar-width);left:0}
    body.ltr .main-content .teacher-navbar{left:var(--sidebar-width);right:0}
    body.rtl .main-content.main-content--expanded .teacher-navbar{right:var(--sidebar-collapsed-width)}
    body.ltr .main-content.main-content--expanded .teacher-navbar{left:var(--sidebar-collapsed-width)}
    .teacher-navbar .navbar__brand-icon{background:linear-gradient(135deg,var(--color-teacher),var(--color-primary-400))}
    .btn--teacher{background:var(--color-teacher);border-color:var(--color-teacher);color:var(--color-white)}
    .btn--teacher:hover{background:var(--color-primary-600);border-color:var(--color-primary-600);color:var(--color-white)}
    .sidebar__item:hover,.sidebar__item--active{background:rgba(53,86,178,.25);color:var(--color-white)}
    .sidebar__item--active{border-inline-start:3px solid var(--color-teacher)}

    /* Editor Specific Styles */
    .editor-layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: var(--space-6);
      align-items: start;
    }
    @media (max-width: 1024px) {
      .editor-layout { grid-template-columns: 1fr; }
    }

    .settings-panel {
      background: var(--color-white);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-sm);
      padding: var(--space-4);
      position: sticky;
      top: calc(var(--navbar-height) + var(--space-4));
    }
    .questions-panel {
      display: grid;
      gap: var(--space-4);
    }
    
    .question-card {
      background: var(--color-white);
      border: 1px solid var(--color-gray-200);
      border-radius: var(--border-radius-md);
      padding: var(--space-5);
      position: relative;
      transition: box-shadow 0.2s;
    }
    .question-card:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--color-primary-200);
    }
    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-3);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-gray-100);
    }
    .question-number {
      font-weight: 700;
      color: var(--color-teacher);
      background: var(--color-primary-100);
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: var(--font-size-sm);
    }
    .question-actions {
      display: flex;
      gap: var(--space-2);
    }
    .q-btn {
      color: var(--color-gray-400);
      background: none;
      border: none;
      cursor: pointer;
      font-size: var(--font-size-lg);
      padding: 4px;
      transition: color 0.2s;
    }
    .q-btn:hover { color: var(--color-primary-600); }
    .q-btn.delete:hover { color: var(--color-admin); }

    .field-group { margin-bottom: var(--space-3); }
    .field-label { display: block; font-size: var(--font-size-sm); font-weight: 600; margin-bottom: 4px; color: var(--color-gray-700); }
    .input-control { width: 100%; padding: 8px 12px; border: 1px solid var(--color-gray-300); border-radius: var(--border-radius-sm); font-family: inherit; }
    .input-control:focus { outline: none; border-color: var(--color-teacher); box-shadow: 0 0 0 3px rgba(53,86,178,0.1); }
    
    .options-list { margin-top: var(--space-3); display: grid; gap: var(--space-2); }
    .option-item { display: flex; align-items: center; gap: var(--space-2); }
    .option-radio { accent-color: var(--color-teacher); width: 18px; height: 18px; }

    .add-q-btn {
      width: 100%;
      padding: var(--space-4);
      border: 2px dashed var(--color-primary-300);
      background: var(--color-primary-100);
      color: var(--color-primary-700);
      border-radius: var(--border-radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .add-q-btn:hover {
      background: var(--color-primary-200);
      border-color: var(--color-primary-500);
    }

    .public-toggle-wrapper {
      background: var(--color-amber-100);
      border: 1px solid var(--color-amber-500);
      padding: var(--space-3);
      border-radius: var(--border-radius-sm);
      margin-top: var(--space-4);
    }
    .toggle-switch {
      display: flex;
      align-items: center;
      cursor: pointer;
      gap: var(--space-2);
    }
    .toggle-switch input { display: none; }
    .toggle-track {
      width: 40px; height: 20px; background: var(--color-gray-300);
      border-radius: 20px; position: relative; transition: background 0.3s;
    }
    .toggle-thumb {
      width: 16px; height: 16px; background: white; border-radius: 50%;
      position: absolute; top: 2px; left: 2px; transition: transform 0.3s;
    }
    body.rtl .toggle-thumb { right: 2px; left: auto; }
    .toggle-switch input:checked + .toggle-track { background: var(--color-school); }
    .toggle-switch input:checked + .toggle-track .toggle-thumb { transform: translateX(20px); }
    body.rtl .toggle-switch input:checked + .toggle-track .toggle-thumb { transform: translateX(-20px); }

    /* Floating Save Bar for Mobile */
    .floating-actions {
      display: none;
      position: fixed; bottom: 0; left: 0; right: 0;
      background: white; padding: var(--space-3);
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 100;
      justify-content: space-between;
    }
    @media (max-width: 768px) { .floating-actions { display: flex; } }
    
    .conflict-alert-icon {
      color: #dc2626;
      background: #fee2e2;
      border-radius: 50%;
      width: 24px; height: 24px;
      display: none; /* hidden by default */
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      cursor: pointer;
      margin-inline-start: 8px;
    }
  </style>
</head>
<body class="rtl">
  <aside class="sidebar" id="sidebar" aria-label="Sidebar navigation">
    <div class="sidebar__header"><div class="sidebar__logo">M</div><span class="sidebar__brand-text">سراج - المعلم</span></div>
    <nav class="sidebar__nav">
      <a class="sidebar__item" href="teacher-dashboard.html"><i class="fas fa-gauge"></i><span>نظرة عامة</span></a>
      <a class="sidebar__item sidebar__item--active" href="teacher-exams.html"><i class="fas fa-file-lines"></i><span>اختباراتي</span></a>
      <a class="sidebar__item" href="teacher-tasks.html"><i class="fas fa-list-check"></i><span>مهام المعلم</span></a>
      <a class="sidebar__item" href="teacher-group.html"><i class="fas fa-users"></i><span>المجموعات</span></a>
      <a class="sidebar__item" href="teacher-question-bank.html"><i class="fas fa-database"></i><span>بنك الأسئلة</span></a>
      <a class="sidebar__item" href="teacher-community.html"><i class="fas fa-comments"></i><span>المجتمع</span></a>
      <a class="sidebar__item" href="teacher-settings.html"><i class="fas fa-gear"></i><span>الإعدادات</span></a>
    </nav>
    <button class="sidebar__toggle" id="sidebar-toggle" aria-label="Toggle sidebar"><i class="fas fa-angles-right"></i><span>تصغير</span></button>
  </aside>

  <div class="main-content" id="main-content">
    <nav class="navbar teacher-navbar" role="navigation">
      <a href="teacher-dashboard.html" class="navbar__brand"><div class="navbar__brand-icon"><i class="fas fa-pen-to-square"></i></div><span class="navbar__brand-text">محرر الاختبار</span></a>
      <div class="navbar__actions">
        <button type="button" class="btn btn--outline btn--sm" id="preview-exam-btn"><i class="fas fa-eye"></i> معاينة</button>
        <a href="teacher-exams.html" class="btn btn--outline btn--sm">إلغاء</a>
        <button type="button" class="btn btn--teacher btn--sm" id="save-exam-btn"><i class="fas fa-save"></i> حفظ الاختبار</button>
      </div>
    </nav>

    <main class="container section">
      <div class="editor-layout">
        <!-- Sidebar Settings -->
        <aside class="settings-panel">
          <h3 class="section-title" style="font-size:1.1rem; margin-bottom:1rem;">إعدادات الاختبار</h3>
          
          <div class="field-group">
            <label class="field-label" for="exam-title">عنوان الاختبار</label>
            <input type="text" id="exam-title" class="input-control" placeholder="مثال: اختبار الوحدة الأولى">
          </div>

          <div class="field-group">
            <label class="field-label" for="exam-grade">الصف</label>
            <select id="exam-grade" class="input-control">
              <option value="">اختر الصف</option>
              <option value="الصف السابع">الصف السابع</option>
              <option value="الصف الثامن">الصف الثامن</option>
              <option value="الصف التاسع">الصف التاسع</option>
              <option value="الصف العاشر">الصف العاشر</option>
            </select>
          </div>

          <div class="field-group">
            <label class="field-label" for="exam-subject">المادة</label>
            <select id="exam-subject" class="input-control">
              <option value="">اختر المادة</option>
              <option value="اللغة العربية">اللغة العربية</option>
              <option value="اللغة الإنجليزية">اللغة الإنجليزية</option>
              <option value="الرياضيات">الرياضيات</option>
              <option value="العلوم">العلوم</option>
            </select>
          </div>

          <div class="field-group">
            <label class="field-label" for="exam-duration">المدة (دقائق)</label>
            <input type="number" id="exam-duration" class="input-control" value="45" min="5">
          </div>

          <div class="field-group">
            <label class="field-label" for="exam-date">
              تاريخ ووقت الاختبار 
              <span id="conflict-alert" class="conflict-alert-icon" title="يوجد تعارض في المواعيد"><i class="fas fa-exclamation"></i></span>
            </label>
            <input type="date" id="exam-date" class="input-control" style="margin-bottom:0.5rem;">
            <input type="time" id="exam-time" class="input-control">
          </div>

          <div class="public-toggle-wrapper">
             <label class="toggle-switch">
               <input type="checkbox" id="public-toggle">
               <div class="toggle-track"><div class="toggle-thumb"></div></div>
               <span style="font-size:0.9rem; font-weight:600; color:var(--color-gray-800);">مشاركة في بنك الأسئلة العام</span>
             </label>
             <p style="font-size:0.75rem; color:var(--color-gray-600); margin-top:0.5rem; line-height:1.4;">
               عند التفعيل، سيتم إرسال الاختبار للمراجعة من قبل إدارة المدرسة، ثم إتاحته في بنك الأسئلة العام لجميع الطلاب والمعلمين.
             </p>
          </div>

          <div style="margin-top:2rem; padding-top:1rem; border-top:1px solid #eee;">
             <button type="button" class="btn btn--outline btn--sm" id="save-to-bank-btn" style="width:100%; color:var(--color-primary-600); border-color:var(--color-primary-200);">
               <i class="fas fa-box-archive"></i> حفظ الأسئلة للبنك
             </button>
          </div>
        </aside>

        <!-- Question Editor -->
        <div class="questions-panel" id="questions-container">
          <!-- Questions will be injected here -->
        </div>
      </div>
      
      <div style="margin-top: 2rem;">
        <button type="button" class="add-q-btn" id="add-question-btn">
          <i class="fas fa-plus-circle"></i> إضافة سؤال جديد
        </button>
      </div>
    </main>
  </div>

  <div class="floating-actions">
    <button type="button" class="btn btn--teacher" id="mob-save-btn" style="width:100%">حفظ الاختبار</button>
  </div>

  <!-- Preview Modal -->
  <div class="modal-overlay" id="preview-modal" style="display:none; z-index:200;">
    <div class="modal-card" style="max-width:800px; width:95%; height:90vh; display:flex; flex-direction:column;">
      <div class="modal-header" style="background:var(--color-gray-50); border-bottom:1px solid var(--color-gray-200);">
         <div style="display:flex; align-items:center; gap:1rem;">
           <span style="font-weight:bold; font-size:1.1rem;" id="preview-title">معاينة الاختبار</span>
           <span class="status-pill status-pill--active">وضع الطالب</span>
         </div>
         <button type="button" class="close-modal"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="flex:1; overflow-y:auto; padding:2rem; background:var(--color-gray-50);">
         <div class="exam-paper" id="preview-paper" style="background:white; padding:3rem; border-radius:8px; box-shadow:var(--shadow-sm); max-width:700px; margin:0 auto;">
            <!-- Questions rendered here -->
         </div>
      </div>
      <div class="modal-footer" style="justify-content:center;">
         <button type="button" class="btn btn--ghost close-modal-btn">إغلاق المعاينة</button>
      </div>
    </div>
  </div>

  <script src="shared-layout.js"></script>
  <script src="tenant-mode.js"></script>
  <script>
    (function() {
      'use strict';

      // State
      let questions = [];
      
      // DOM Elements
      const questionsContainer = document.getElementById('questions-container');
      const addBtn = document.getElementById('add-question-btn');
      const saveBtn = document.getElementById('save-exam-btn');
      const mobSaveBtn = document.getElementById('mob-save-btn');
      const dateInput = document.getElementById('exam-date');
      const timeInput = document.getElementById('exam-time');
      const conflictAlert = document.getElementById('conflict-alert');

      // Helper to get scope
      function getScope() {
         let scope = 'school:SCH-001'; 
         try {
            const type = localStorage.getItem('mitests-tenant-type');
            const pid = localStorage.getItem('mitests-school-id') || 'SCH-001';
            if (type === 'personal_teacher') scope = 'personal:default';
            else scope = 'school:' + pid;
         } catch(e) {}
         return scope;
      }

      function checkLockStatus(title) {
        if(!title) return;
        const scope = getScope();
        const key = 'mitests-teacher-review-queue:' + scope;
        let queue = [];
        try { queue = JSON.parse(localStorage.getItem(key)) || []; } catch(e) {}
        
        // Check if matching submissions exist
        const locked = queue.some(item => item.title === title);
        
        if(locked) {
           document.querySelectorAll('input, select, textarea, button').forEach(el => el.disabled = true);
           // Show banner
           const banner = document.createElement('div');
           banner.className = 'locked-banner';
           banner.style.background = '#fee2e2';
           banner.style.color = '#991b1b';
           banner.style.padding = '1rem';
           banner.style.marginBottom = '1rem';
           banner.style.borderRadius = '8px';
           banner.style.border = '1px solid #f87171';
           banner.style.fontWeight = 'bold';
           banner.innerHTML = '<i class="fas fa-lock"></i> تنبيه: هذا الاختبار يحتوي على تسليمات طلابية ولا يمكن تعديله.';
           const main = document.querySelector('main');
           if(main) main.prepend(banner);
        }
      }

      function loadExam(id) {
         const scope = getScope();
         const key = 'mitests-teacher-exams:' + scope;
         let exams = [];
         try { exams = JSON.parse(localStorage.getItem(key)) || []; } catch(e) {}
         const exam = exams.find(x => x.id === id);
         
         if(exam) {
            document.getElementById('exam-title').value = exam.title || '';
            document.getElementById('exam-grade').value = exam.grade || '';
            document.getElementById('exam-subject').value = exam.subject || '';
            document.getElementById('exam-duration').value = exam.durationMinutes || 45;
            
            if(exam.scheduledAt) {
               const dt = new Date(exam.scheduledAt);
               if(!isNaN(dt.getTime())) {
                   document.getElementById('exam-date').value = dt.toISOString().split('T')[0];
                   const hours = String(dt.getHours()).padStart(2, '0');
                   const mins = String(dt.getMinutes()).padStart(2, '0');
                   document.getElementById('exam-time').value = hours + ':' + mins;
               }
            }
            
            document.getElementById('public-toggle').checked = !!exam.isPublic;
            
            questions = exam.questions || [];
            if(questions.length === 0) addQuestion();
            else renderAllQuestions();
            
            checkLockStatus(exam.title);
         } else {
            alert('الاختبار غير موجود');
            window.location.href = 'teacher-exams.html';
         }
      }

      function init() {
         const urlParams = new URLSearchParams(window.location.search);
         const id = urlParams.get('id');
         
         if(id) {
            loadExam(id);
         } else {
            addQuestion();
            // Hydrate from manual Init if exists
            try {
              const rawInit = localStorage.getItem('mitests-manual-exam-init');
              if (rawInit) {
                const initData = JSON.parse(rawInit);
                if(initData.title) document.getElementById('exam-title').value = initData.title;
                if(initData.grade) document.getElementById('exam-grade').value = initData.grade;
                if(initData.subject) document.getElementById('exam-subject').value = initData.subject;
                if(initData.date) document.getElementById('exam-date').value = initData.date;
                if(initData.time) document.getElementById('exam-time').value = initData.time;
                localStorage.removeItem('mitests-manual-exam-init');
              }
            } catch(e) {}
         }
         checkConflicts();
      }

      function createQuestionId() {
        return 'q-' + Date.now() + Math.random().toString(36).substr(2, 5);
      }

      function renderQuestion(q, index) {
        const div = document.createElement('div');
        div.className = 'question-card';
        div.dataset.id = q.id;
        div.innerHTML = `
          <div class="question-header">
            <div style="display:flex; align-items:center; gap:0.75rem;">
              <span class="question-number">${index + 1}</span>
              <select class="input-control" style="width:auto; padding:4px 8px;" onchange="updateQuestionType('${q.id}', this.value)">
                <option value="MC" ${q.type === 'MC' ? 'selected' : ''}>اختيار من متعدد</option>
                <option value="Open" ${q.type === 'Open' ? 'selected' : ''}>سؤال مفتوح</option>
              </select>
            </div>
            <div class="question-actions">
               <button class="q-btn delete" onclick="deleteQuestion('${q.id}')" title="حذف السؤال"><i class="fas fa-trash"></i></button>
            </div>
          </div>
          <div class="field-group">
            <textarea class="input-control" rows="3" placeholder="نص السؤال..." oninput="updateQuestionText('${q.id}', this.value)">${q.text || ''}</textarea>
          </div>
          ${q.type === 'MC' ? renderOptions(q) : ''}
          <div style="margin-top:1rem; display:flex; align-items:center; gap:0.5rem; justify-content:flex-end;">
             <span style="font-size:0.85rem; color:var(--color-gray-500);">الدرجة:</span>
             <input type="number" class="input-control" style="width:60px; text-align:center;" value="${q.points || 1}" min="1" onchange="updateQuestionPoints('${q.id}', this.value)">
          </div>
        `;
        return div;
      }

      function renderOptions(q) {
        let html = '<div class="options-list">';
        (q.options || ['']).forEach((opt, idx) => {
          html += `
            <div class="option-item">
              <input type="radio" name="radio-${q.id}" class="option-radio" disabled>
              <input type="text" class="input-control" placeholder="الخيار ${idx+1}" value="${opt}" oninput="updateOption('${q.id}', ${idx}, this.value)">
              ${idx > 1 ? `<button class="q-btn delete" onclick="removeOption('${q.id}', ${idx})" style="font-size:0.9rem;"><i class="fas fa-times"></i></button>` : ''}
            </div>
          `;
        });
        html += `<button type="button" class="btn btn--ghost btn--sm" onclick="addOption('${q.id}')" style="align-self:start;"><i class="fas fa-plus"></i> إضافة خيار</button>`;
        html += '</div>';
        return html;
      }

      // Global Handlers (attached to window for inline onclick access)
      window.addQuestion = function() {
        questions.push({
          id: createQuestionId(),
          type: 'MC',
          text: '',
          options: ['', '', '', ''],
          points: 1
        });
        renderAllQuestions();
      };

      window.deleteQuestion = function(id) {
        if(questions.length <= 1) {
          alert("يجب أن يحتوي الاختبار على سؤال واحد على الأقل.");
          return;
        }
        if(confirm("هل أنت متأكد من حذف هذا السؤال؟")) {
          questions = questions.filter(q => q.id !== id);
          renderAllQuestions();
        }
      };

      window.updateQuestionType = function(id, type) {
        const q = questions.find(x => x.id === id);
        if(q) {
          q.type = type;
          if(type === 'MC' && (!q.options || q.options.length === 0)) {
            q.options = ['', '', '', ''];
          }
          renderAllQuestions();
        }
      };

      window.updateQuestionText = function(id, text) {
        const q = questions.find(x => x.id === id);
        if(q) q.text = text;
      };

      window.updateQuestionPoints = function(id, points) {
        const q = questions.find(x => x.id === id);
        if(q) q.points = parseInt(points) || 1;
      };

      window.updateOption = function(qId, optIdx, val) {
        const q = questions.find(x => x.id === qId);
        if(q && q.options) q.options[optIdx] = val;
      };

      window.addOption = function(qId) {
        const q = questions.find(x => x.id === qId);
        if(q) {
           q.options.push('');
           renderAllQuestions();
        }
      };

      window.removeOption = function(qId, optIdx) {
        const q = questions.find(x => x.id === qId);
        if(q) {
           q.options.splice(optIdx, 1);
           renderAllQuestions();
        }
      };

      // Preview Logic
      const previewModal = document.getElementById('preview-modal');
      const previewBtn = document.getElementById('preview-exam-btn');
      const closePreviewBtns = document.querySelectorAll('.close-modal, .close-modal-btn');

      previewBtn.addEventListener('click', () => {
         const title = document.getElementById('exam-title').value || 'معاينة الاختبار';
         document.getElementById('preview-title').textContent = title;
         const paper = document.getElementById('preview-paper');
         paper.innerHTML = '';
         
         // Render Header
         const header = document.createElement('div');
         header.style.textAlign = 'center';
         header.style.marginBottom = '2rem';
         header.style.borderBottom = '2px solid #eee';
         header.style.paddingBottom = '1rem';
         header.innerHTML = `
            <h2 style="margin:0 0 0.5rem 0;">${title}</h2>
            <div style="color:var(--color-gray-600); display:flex; justify-content:center; gap:1.5rem; font-size:0.9rem;">
               <span><i class="fas fa-clock"></i> ${document.getElementById('exam-duration').value} دقيقة</span>
               <span><i class="fas fa-layer-group"></i> ${document.getElementById('exam-grade').value || 'غير محدد'}</span>
               <span><i class="fas fa-book"></i> ${document.getElementById('exam-subject').value || 'عام'}</span>
            </div>
         `;
         paper.appendChild(header);

         // Render Questions
         if(questions.length === 0) {
            paper.innerHTML += '<p style="text-align:center; color:#888;">لا توجد أسئلة للعرض.</p>';
         } else {
            questions.forEach((q, idx) => {
               const qDiv = document.createElement('div');
               qDiv.style.marginBottom = '2rem';
               qDiv.innerHTML = `
                  <div style="display:flex; gap:0.5rem; margin-bottom:0.5rem; font-weight:bold;">
                     <span style="color:var(--color-teacher);">${idx + 1}.</span>
                     <div>${q.text || '(نص السؤال فارغ)'} <span style="font-weight:normal; color:#888; font-size:0.85rem;">(${q.points} درجات)</span></div>
                  </div>
               `;
               
               if(q.type === 'MC') {
                  const optsDiv = document.createElement('div');
                  optsDiv.style.marginRight = '1.5rem';
                  (q.options || []).forEach(opt => {
                     const row = document.createElement('div');
                     row.style.marginBottom = '0.5rem';
                     row.innerHTML = `<label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;"><input type="radio" name="p-${q.id}" disabled> ${opt}</label>`;
                     optsDiv.appendChild(row);
                  });
                  qDiv.appendChild(optsDiv);
               } else {
                  qDiv.innerHTML += `<textarea style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:4px; margin-top:0.5rem;" rows="3" placeholder="إجابة الطالب..." disabled></textarea>`;
               }
               paper.appendChild(qDiv);
            });
         }

         previewModal.style.display = 'flex';
      });

      closePreviewBtns.forEach(b => b.addEventListener('click', () => {
         previewModal.style.display = 'none';
      }));

      // Save to Bank Logic
      document.getElementById('save-to-bank-btn').addEventListener('click', () => {
         if(questions.length === 0) { alert('لا توجد أسئلة لحفظها.'); return; }
         
         const scope = getScope();
         const key = 'mitests-teacher-questions:' + scope;
         let bank = [];
         try { bank = JSON.parse(localStorage.getItem(key)) || []; } catch(e) {}
         
         let addedCount = 0;
         questions.forEach(q => {
             // Simple duplicate check by text
             const exists = bank.some(bq => bq.body === q.text);
             if(!exists && q.text) {
                 bank.push({
                    id: 'qb-' + Date.now() + Math.random().toString(36).substr(2, 4),
                    title: 'سؤال من ' + (document.getElementById('exam-title').value || 'اختبار'),
                    body: q.text,
                    subject: document.getElementById('exam-subject').value || 'عام',
                    bloom: 'غير محدد',
                    difficulty: 'متوسط',
                    type: q.type,
                    options: q.options,
                    points: q.points,
                    createdAt: new Date().toISOString()
                 });
                 addedCount++;
             }
         });
         
         if(addedCount > 0) {
             localStorage.setItem(key, JSON.stringify(bank));
             alert(`تم حفظ ${addedCount} سؤال في بنك الأسئلة الخاص بك بنجاح.`);
         } else {
             alert('لم يتم حفظ أي أسئلة جديدة (قد تكون مكررة أو فارغة).');
         }
      });



      addBtn.addEventListener('click', window.addQuestion);
      
      function checkConflicts() {
        if(!dateInput.value || !timeInput.value) {
           conflictAlert.style.display = 'none';
           return;
        }

        const selectedDateTime = new Date(dateInput.value + 'T' + timeInput.value);
        if(isNaN(selectedDateTime.getTime())) return;

        const scope = getScope();
        const key = 'mitests-teacher-exams:' + scope;
        let exams = [];
        try { exams = JSON.parse(localStorage.getItem(key)) || []; } catch(e) {}

        // Exclude current exam from conflict check if editing
        const urlParams = new URLSearchParams(window.location.search);
        const currentId = urlParams.get('id');

        const conflics = exams.filter(ex => {
           if(currentId && ex.id === currentId) return false;
           if(!ex.scheduledAt || ex.deletedAt) return false;
           const exDate = new Date(ex.scheduledAt);
           const diffMs = Math.abs(selectedDateTime - exDate);
           const diffHours = diffMs / (1000 * 60 * 60);
           return diffHours < 24;
        });

        if(conflics.length > 0) {
           conflictAlert.style.display = 'flex';
           conflictAlert.onclick = () => {
             let msg = "تنبيه: الاختبارات التالية مجدولة خلال 24 ساعة من الموعد المحدد:\n\n";
             conflics.forEach(c => {
                const d = new Date(c.scheduledAt).toLocaleString('ar-EG');
                msg += `- ${c.title} (${d})\n`;
             });
             alert(msg);
           };
        } else {
           conflictAlert.style.display = 'none';
        }
      }

      dateInput.addEventListener('change', checkConflicts);
      timeInput.addEventListener('change', checkConflicts);

      function saveExam() {
        // Validation
        const title = document.getElementById('exam-title').value.trim();
        if(!title) { alert("يرجى إدخال عنوان الاختبار"); return; }
        
        const date = dateInput.value;
        const time = timeInput.value;
        
        if(!date || !time) { alert("يرجى تحديد تاريخ ووقت الاختبار"); return; }

        // Future Date Check
        const scheduledDate = new Date(date + 'T' + time);
        if(scheduledDate < new Date()) {
           alert("خطأ: لا يمكن جدولة الاختبار في تاريخ سابق. يرجى اختيار موعد مستقبلي.");
           return;
        }

        const isPublic = document.getElementById('public-toggle').checked;
        const scope = getScope();
        
        const urlParams = new URLSearchParams(window.location.search);
        const currentId = urlParams.get('id');

        const examData = {
          id: currentId || ('ex-' + Date.now()),
          kind: 'exam',
          title: title,
          grade: document.getElementById('exam-grade').value,
          subject: document.getElementById('exam-subject').value,
          durationMinutes: document.getElementById('exam-duration').value || 45,
          scheduledAt: scheduledDate.toISOString(),
          sourceType: 'manual',
          sourcePlan: 'تم إنشاؤه يدويًا',
          status: 'published',
          questions: questions,
          isPublic: isPublic,
          approvalStatus: isPublic ? 'pending' : 'none',
          createdAt: new Date().toISOString()
        };

        const key = 'mitests-teacher-exams:' + scope;
        let exams = [];
        try {
           exams = JSON.parse(localStorage.getItem(key)) || [];
        } catch(e) { exams = []; }
        
        if(currentId) {
            const index = exams.findIndex(x => x.id === currentId);
            if(index !== -1) {
                examData.createdAt = exams[index].createdAt; 
                exams[index] = examData;
            } else {
                exams.unshift(examData);
            }
        } else {
            exams.unshift(examData);
        }
        
        localStorage.setItem(key, JSON.stringify(exams));

        let msg = "تم حفظ الاختبار بنجاح!";
        if(isPublic) msg += "\nتم إرسال الاختبار للمراجعة لإضافته لبنك الأسئلة العام.";
        
        alert(msg);
        window.location.href = 'teacher-exams.html';
      }

      saveBtn.addEventListener('click', saveExam);
      mobSaveBtn.addEventListener('click', saveExam);

      init();

    })();
  </script>
</body>
</html>
