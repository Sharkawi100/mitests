<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mitests - مهام المعلم</title>
  <meta name="description" content="صفحة مستقلة لمهام المعلم: ما يحتاج مراجعة، الطلاب المعلقون والمعتمدون.">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">

  <style>
    .teacher-navbar { border-bottom: 1px solid var(--color-gray-200); }
    body.rtl .main-content .teacher-navbar { right: var(--sidebar-width); left: 0; }
    body.ltr .main-content .teacher-navbar { left: var(--sidebar-width); right: 0; }
    body.rtl .main-content.main-content--expanded .teacher-navbar { right: var(--sidebar-collapsed-width); }
    body.ltr .main-content.main-content--expanded .teacher-navbar { left: var(--sidebar-collapsed-width); }

    .teacher-navbar .navbar__brand-icon { background: linear-gradient(135deg, var(--color-teacher), var(--color-primary-400)); }
    .sidebar__item:hover, .sidebar__item--active { background: rgba(53, 86, 178, 0.25); color: var(--color-white); }
    .sidebar__item--active { border-inline-start: 3px solid var(--color-teacher); }

    .btn--teacher { background: var(--color-teacher); border-color: var(--color-teacher); color: var(--color-white); }
    .btn--teacher:hover { background: var(--color-primary-600); border-color: var(--color-primary-600); color: var(--color-white); }

    .tasks-main {
      padding: calc(var(--navbar-height) + var(--space-6)) var(--space-6) var(--space-8);
      display: grid;
      gap: var(--space-4);
    }

    .page-header {
      background: var(--color-white);
      border-top: 4px solid var(--color-teacher);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-md);
      padding: var(--space-5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    .page-header h1 { color: var(--color-gray-900); font-size: var(--font-size-3xl); margin-bottom: var(--space-1); }
    .page-header p { color: var(--color-gray-600); }

    .tasks-kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: var(--space-4);
    }

    .task-kpi {
      border: 1px solid var(--color-gray-200);
      border-top: 4px solid var(--color-teacher);
      border-radius: var(--border-radius-md);
      background: var(--color-white);
      padding: var(--space-4);
      box-shadow: var(--shadow-sm);
      display: grid;
      gap: var(--space-1);
    }

    .task-kpi__label { color: var(--color-gray-500); font-size: var(--font-size-sm); }
    .task-kpi__value { color: var(--color-gray-900); font-size: var(--font-size-2xl); font-weight: 700; line-height: 1.2; }

    .task-board {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: var(--space-4);
    }

    .sub-title { font-size: var(--font-size-lg); color: var(--color-gray-900); margin-bottom: var(--space-3); }

    .table-wrap { overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; min-width: 720px; }
    .data-table th, .data-table td {
      padding: var(--space-3);
      border-bottom: 1px solid var(--color-gray-200);
      text-align: start;
      font-size: var(--font-size-sm);
    }
    .data-table th { color: var(--color-gray-500); font-weight: 600; background: var(--color-gray-50); }

    .status-chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: var(--border-radius-full);
      font-size: var(--font-size-xs);
      font-weight: 700;
      white-space: nowrap;
    }

    .status-chip--needs-review { background: #fef3c7; color: #92400e; }
    .status-chip--pending { background: #fee2e2; color: #991b1b; }
    .status-chip--approved { background: #dcfce7; color: #166534; }

    .approvals-grid { display: grid; grid-template-columns: 1fr; gap: var(--space-3); }

    .approval-panel {
      border: 1px solid var(--color-gray-200);
      border-radius: var(--border-radius-md);
      padding: var(--space-3);
      background: var(--color-gray-50);
    }

    .approval-panel h4 { font-size: var(--font-size-base); color: var(--color-gray-900); margin-bottom: var(--space-2); }

    .approval-list {
      list-style: none;
      display: grid;
      gap: var(--space-2);
      padding: 0;
      margin: 0;
    }

    .approval-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--font-size-sm);
      color: var(--color-gray-700);
      border-bottom: 1px dashed var(--color-gray-200);
      padding-bottom: var(--space-2);
    }

    .approval-item:last-child { border-bottom: 0; padding-bottom: 0; }
    .approval-item small { color: var(--color-gray-500); display: block; }

    @media (max-width: 1023px) {
      body.rtl .main-content .teacher-navbar { right: var(--sidebar-collapsed-width); }
      body.ltr .main-content .teacher-navbar { left: var(--sidebar-collapsed-width); }
      body.rtl .main-content { margin-right: var(--sidebar-collapsed-width); }
      body.ltr .main-content { margin-left: var(--sidebar-collapsed-width); }
      .sidebar { width: var(--sidebar-collapsed-width); }
      .sidebar .sidebar__brand-text, .sidebar .sidebar__item span, .sidebar .sidebar__toggle span { display: none; }
      .tasks-kpi-grid, .task-board { grid-template-columns: 1fr; }
    }

    @media (max-width: 767px) {
      .sidebar { display: none; }
      body.rtl .main-content, body.ltr .main-content { margin: 0; }
      body.rtl .main-content .teacher-navbar, body.ltr .main-content .teacher-navbar { right: 0; left: 0; }
      .tasks-main { padding-inline: var(--space-4); }
      .page-header h1 { font-size: var(--font-size-2xl); }
    }
  </style>
</head>
<body class="rtl">
  <aside class="sidebar" id="sidebar" aria-label="Sidebar navigation">
    <div class="sidebar__header"><div class="sidebar__logo">M</div><span class="sidebar__brand-text">سراج - المعلم</span></div>
    <nav class="sidebar__nav">
      <a class="sidebar__item" href="teacher-dashboard.html" data-teacher-home><i class="fas fa-gauge"></i><span>نظرة عامة</span></a>
      <a class="sidebar__item" href="teacher-exams.html"><i class="fas fa-file-lines"></i><span>اختباراتي</span></a>
      <a class="sidebar__item sidebar__item--active" href="teacher-tasks.html"><i class="fas fa-list-check"></i><span>مهام المعلم</span></a>
      <a class="sidebar__item" href="teacher-group.html"><i class="fas fa-users"></i><span>المجموعات</span></a>
      <a class="sidebar__item" href="teacher-question-bank.html"><i class="fas fa-database"></i><span>بنك الأسئلة</span></a>
      <a class="sidebar__item" href="teacher-community.html" data-school-only><i class="fas fa-comments"></i><span>المجتمع</span></a>
      <a class="sidebar__item" href="teacher-settings.html"><i class="fas fa-gear"></i><span>الإعدادات</span></a>
    </nav>
    <button class="sidebar__toggle" id="sidebar-toggle" aria-label="Toggle sidebar"><i class="fas fa-angles-right"></i><span>تصغير</span></button>
  </aside>

  <div class="main-content" id="main-content">
    <nav class="navbar teacher-navbar" role="navigation" aria-label="Teacher top navigation">
      <a href="teacher-tasks.html" class="navbar__brand">
        <div class="navbar__brand-icon"><i class="fas fa-list-check"></i></div>
        <span class="navbar__brand-text">مهام المعلم</span>
      </a>
      <div class="navbar__actions">
        <div class="lang-switcher" role="group" aria-label="Language selector">
          <button class="lang-switcher__btn active" data-lang="ar" aria-label="Arabic">&#1593;</button>
          <button class="lang-switcher__btn" data-lang="he" aria-label="Hebrew">&#1506;&#1489;</button>
          <button class="lang-switcher__btn" data-lang="en" aria-label="English">En</button>
        </div>
        <div class="avatar-dropdown">
          <button class="avatar-btn" type="button" data-avatar-toggle="teacher-avatar-menu" aria-label="قائمة حساب المعلم"><i class="fas fa-user"></i></button>
          <div class="avatar-menu" id="teacher-avatar-menu" data-avatar-menu>
            <span class="avatar-menu__label">حساب المعلم</span>
            <a class="avatar-menu__link" href="teacher-profile.html"><i class="fas fa-id-card"></i><span>الملف الشخصي</span></a>
            <a class="avatar-menu__link" href="teacher-settings.html"><i class="fas fa-gear"></i><span>الإعدادات</span></a>
          </div>
        </div>
        <a href="index.html" class="btn btn--teacher btn--sm"><i class="fas fa-right-from-bracket"></i><span>تسجيل الخروج</span></a>
      </div>
    </nav>

    <main class="tasks-main">
      <header class="page-header">
        <div>
          <h1>مهام المعلم</h1>
          <p>صفحة مستقلة لمعرفة: ما الذي يحتاج مراجعة، أي طالب، ومن تم اعتماده.</p>
        </div>
        <a href="teacher-dashboard.html" class="btn btn--outline">العودة للوحة</a>
      </header>

      <section class="tasks-kpi-grid">
        <article class="task-kpi">
          <p class="task-kpi__label">أعضاء جدد في المجموعات</p>
          <p class="task-kpi__value" id="task-new-group-members">0</p>
        </article>
        <article class="task-kpi">
          <p class="task-kpi__label">مشاركات جديدة</p>
          <p class="task-kpi__value" id="task-new-shares">0</p>
        </article>
        <article class="task-kpi">
          <p class="task-kpi__label">طلاب جدد مُسندون</p>
          <p class="task-kpi__value" id="task-new-assigned-students">0</p>
        </article>
      </section>

      <section class="task-board">
        <article class="card">
          <h3 class="sub-title">ما الذي يحتاج مراجعة؟ أي اختبار؟ أي طالب؟</h3>
          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>النوع</th>
                  <th>العنوان</th>
                  <th>المجموعة</th>
                  <th>الطالب</th>
                  <th>الحالة</th>
                  <th>الإجراء</th>
                </tr>
              </thead>
              <tbody id="review-queue-body"></tbody>
            </table>
          </div>
        </article>

        <article class="card">
          <h3 class="sub-title">اعتماد الطلاب</h3>
          <div class="approvals-grid">
            <section class="approval-panel">
              <h4>طلاب بانتظار الاعتماد</h4>
              <ul class="approval-list" id="pending-approval-list"></ul>
            </section>
            <section class="approval-panel">
              <h4>طلاب تمت الموافقة عليهم</h4>
              <ul class="approval-list" id="approved-students-list"></ul>
            </section>
          </div>
        </article>
      </section>
    </main>
  </div>

  <script src="shared-layout.js"></script>
  <script src="tenant-mode.js"></script>
  <script>
  (function(){
    'use strict';

    function getTenantType() {
      try { return localStorage.getItem('mitests-tenant-type') || 'school_teacher'; } catch (e) { return 'school_teacher'; }
    }

    function getScope(tenantType) {
      if (tenantType === 'personal_teacher') {
        try {
          var raw = localStorage.getItem('mitests-personal-workspace');
          if (raw) {
            var ws = JSON.parse(raw);
            if (ws && ws.workspaceId) return 'personal:' + String(ws.workspaceId);
          }
        } catch (e) {}
        return 'personal:default';
      }

      try {
        var schoolId = localStorage.getItem('mitests-school-id');
        if (schoolId) return 'school:' + schoolId;
        localStorage.setItem('mitests-school-id', 'SCH-001');
      } catch (e2) {}
      return 'school:SCH-001';
    }

    function loadArray(key, fallback) {
      try {
        var raw = localStorage.getItem(key);
        if (!raw) return fallback.slice();
        var parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) return parsed;
      } catch (e) {}
      return fallback.slice();
    }

    function saveArray(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) {}
    }

    function esc(value) {
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function isRecent(isoDate, days) {
      var d = new Date(isoDate || 0);
      if (isNaN(d.getTime())) return false;
      return (Date.now() - d.getTime()) <= days * 24 * 60 * 60 * 1000;
    }

    function formatDate(isoDate) {
      var d = new Date(isoDate || Date.now());
      if (isNaN(d.getTime())) return '-';
      return d.toLocaleString('ar-SA', { hour12: true, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    }

    var tenantType = getTenantType();
    var scope = getScope(tenantType);

    var groups = loadArray('mitests-teacher-groups:' + scope, [
      { code: 'grade9-eng', name: 'الصف تاسع 1' },
      { code: 'grade8-math', name: 'الصف ثامن 3' },
      { code: 'grade10-sci', name: 'الصف عاشر 2' },
      { code: 'grade7-eng', name: 'الصف سابع 1' }
    ]);

    var requests = loadArray('mitests-group-join-requests:' + scope, []);
    var members = loadArray('mitests-group-memberships:' + scope, []);
    var history = loadArray('mitests-group-join-history:' + scope, []);

    var sharesKey = 'mitests-teacher-shares:' + scope;
    var shares = loadArray(sharesKey, [
      { id: 's1', text: 'مشاركة rubric جديدة في المجتمع', createdAt: new Date(Date.now() - (3 * 60 * 60 * 1000)).toISOString() },
      { id: 's2', text: 'تنبيه من الإدارة حول تقييمات منتصف الفصل', createdAt: new Date(Date.now() - (26 * 60 * 60 * 1000)).toISOString() }
    ]);
    if (!loadArray(sharesKey, []).length) saveArray(sharesKey, shares);

    var reviewQueueKey = 'mitests-teacher-review-queue:' + scope;
    var reviewQueue = loadArray(reviewQueueKey, []);
    if (!reviewQueue.length) {
      reviewQueue = [
        { id: 'rq1', kind: 'exam', title: 'اختبار قراءة - الوحدة 4', groupCode: 'grade9-eng', studentName: 'يوسف لؤي', studentId: 'STD-202401', status: 'needs_review', submittedAt: new Date(Date.now() - (2 * 60 * 60 * 1000)).toISOString() },
        { id: 'rq2', kind: 'assignment', title: 'واجب المفردات - الأسبوع 3', groupCode: 'grade7-eng', studentName: 'ليان حسن', studentId: 'STD-202442', status: 'needs_review', submittedAt: new Date(Date.now() - (5 * 60 * 60 * 1000)).toISOString() },
        { id: 'rq3', kind: 'exam', title: 'اختبار العلوم - سلامة المختبر', groupCode: 'grade10-sci', studentName: 'مالك العلي', studentId: 'STD-202447', status: 'needs_review', submittedAt: new Date(Date.now() - (20 * 60 * 60 * 1000)).toISOString() }
      ];
      saveArray(reviewQueueKey, reviewQueue);
    }

    function groupName(code) {
      for (var i = 0; i < groups.length; i++) {
        if (groups[i].code === code) return groups[i].name;
      }
      return 'مجموعة غير محددة';
    }

    function setText(id, value) {
      var el = document.getElementById(id);
      if (el) el.textContent = String(value);
    }

    var newMembersCount = history.filter(function (h) { return h.status === 'approved' && isRecent(h.decidedAt, 7); }).length;
    var newSharesCount = shares.filter(function (s) { return isRecent(s.createdAt, 7); }).length;
    var newAssignedCount = members.filter(function (m) { return m.source === 'school_auto' && isRecent(m.joinedAt, 7); }).length;

    setText('task-new-group-members', newMembersCount);
    setText('task-new-shares', newSharesCount);
    setText('task-new-assigned-students', newAssignedCount);

    var reviewBody = document.getElementById('review-queue-body');
    if (reviewBody) {
      if (!reviewQueue.length) {
        reviewBody.innerHTML = '<tr><td colspan="6">لا يوجد عناصر حالياً تحتاج مراجعة.</td></tr>';
      } else {
        var reviewRows = '';
        for (var r = 0; r < reviewQueue.length; r++) {
          var item = reviewQueue[r];
          var kindText = item.kind === 'assignment' ? 'واجب' : 'اختبار';
          var statusClass = 'status-chip--pending';
          var statusText = 'قيد الانتظار';
          if (item.status === 'needs_review') {
            statusClass = 'status-chip--needs-review';
            statusText = 'تحتاج مراجعة';
          } else if (item.status === 'awaiting_submissions') {
            statusClass = 'status-chip--pending';
            statusText = 'بانتظار تسليم الطلاب';
          }
          var href = 'exam-assessment.html?kind=' + encodeURIComponent(item.kind || 'exam')
            + '&title=' + encodeURIComponent(item.title || '')
            + '&student=' + encodeURIComponent(item.studentName || '')
            + '&group=' + encodeURIComponent(groupName(item.groupCode));

          reviewRows += ''
            + '<tr>'
            + '<td>' + kindText + '</td>'
            + '<td>' + esc(item.title) + '</td>'
            + '<td>' + esc(groupName(item.groupCode)) + '</td>'
            + '<td>' + esc(item.studentName) + (item.studentId ? ' <small style="color:#6b7280;">(' + esc(item.studentId) + ')</small>' : '') + '</td>'
            + '<td><span class="status-chip ' + statusClass + '">' + statusText + '</span></td>'
            + '<td><a class="btn btn--teacher btn--sm" href="' + href + '">مراجعة الآن</a></td>'
            + '</tr>';
        }
        reviewBody.innerHTML = reviewRows;
      }
    }

    var pendingList = document.getElementById('pending-approval-list');
    if (pendingList) {
      if (!requests.length) {
        pendingList.innerHTML = '<li class="approval-item"><span>لا يوجد طلاب بانتظار الاعتماد.</span></li>';
      } else {
        requests.sort(function (a, b) { return new Date(b.requestedAt || 0).getTime() - new Date(a.requestedAt || 0).getTime(); });
        var pendingHtml = '';
        var pendingLimit = Math.min(5, requests.length);
        for (var p = 0; p < pendingLimit; p++) {
          var req = requests[p];
          pendingHtml += ''
            + '<li class="approval-item">'
            + '<span>' + esc(req.studentName || 'طالب') + '<small>' + esc(groupName(req.groupCode)) + ' • ' + formatDate(req.requestedAt) + '</small></span>'
            + '<a class="btn btn--outline btn--sm" href="teacher-group.html?g=' + encodeURIComponent(req.groupCode || '') + '">اعتماد</a>'
            + '</li>';
        }
        pendingList.innerHTML = pendingHtml;
      }
    }

    var approvedList = document.getElementById('approved-students-list');
    if (approvedList) {
      var approvedItems = history.filter(function (h) { return h.status === 'approved'; });
      if (!approvedItems.length) {
        approvedList.innerHTML = '<li class="approval-item"><span>لا يوجد اعتماد حديث بعد.</span></li>';
      } else {
        approvedItems.sort(function (a, b) { return new Date(b.decidedAt || 0).getTime() - new Date(a.decidedAt || 0).getTime(); });
        var approvedHtml = '';
        var approvedLimit = Math.min(5, approvedItems.length);
        for (var a = 0; a < approvedLimit; a++) {
          var ok = approvedItems[a];
          approvedHtml += ''
            + '<li class="approval-item">'
            + '<span>' + esc(ok.studentName || 'طالب') + '<small>' + esc(groupName(ok.groupCode)) + ' • ' + formatDate(ok.decidedAt) + '</small></span>'
            + '<span class="status-chip status-chip--approved">معتمد</span>'
            + '</li>';
        }
        approvedList.innerHTML = approvedHtml;
      }
    }
  })();
  </script>
</body>
</html>
