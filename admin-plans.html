<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mitests - الخطط والاشتراكات</title>
  <meta name="description" content="إدارة خطط الاشتراك وحدود التوكنز.">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">

  <style>
    .admin-navbar { border-bottom: 1px solid var(--color-gray-200); }
    body.rtl .main-content .admin-navbar { right: var(--sidebar-width); left: 0; }
    body.ltr .main-content .admin-navbar { left: var(--sidebar-width); right: 0; }
    body.rtl .main-content.main-content--expanded .admin-navbar { right: var(--sidebar-collapsed-width); }
    body.ltr .main-content.main-content--expanded .admin-navbar { left: var(--sidebar-collapsed-width); }

    .admin-navbar .navbar__brand-icon { background: linear-gradient(135deg, var(--color-admin), #f38a8d); }
    .sidebar__item:hover, .sidebar__item--active { background: rgba(239, 93, 96, 0.2); color: var(--color-white); }
    .sidebar__item--active { border-inline-start: 3px solid var(--color-admin); }
    .btn--admin { background: var(--color-admin); border-color: var(--color-admin); color: var(--color-white); }
    .btn--admin:hover { background: #db4f53; border-color: #db4f53; color: var(--color-white); }

    .main { padding: calc(var(--navbar-height) + var(--space-6)) var(--space-6) var(--space-8); display: grid; gap: var(--space-4); }
    .head { background: var(--color-white); border-top: 4px solid var(--color-admin); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-md); padding: var(--space-5); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-3); }
    .head h1 { font-size: var(--font-size-3xl); color: var(--color-gray-900); margin-bottom: var(--space-1); }
    .head p { color: var(--color-gray-600); }

    .status-chip {
      border-radius: var(--border-radius-full);
      background: var(--color-coral-100);
      color: var(--color-admin);
      font-size: var(--font-size-xs);
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-3);
    }

    .plans { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: var(--space-3); }
    .plan-card {
      background: var(--color-white);
      border: 1px solid var(--color-gray-200);
      border-top: 4px solid var(--color-admin);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-sm);
      padding: var(--space-4);
      display: grid;
      gap: var(--space-2);
    }

    .plan-card h2 { color: var(--color-gray-900); font-size: var(--font-size-xl); }
    .price { color: var(--color-admin); font-size: var(--font-size-2xl); font-weight: 700; }
    .meta { color: var(--color-gray-600); font-size: var(--font-size-sm); line-height: 1.7; }
    .plan-footer { display: flex; justify-content: space-between; align-items: center; gap: var(--space-2); flex-wrap: wrap; }

    .actions { display: flex; justify-content: space-between; gap: var(--space-3); flex-wrap: wrap; }

    .modal-body { padding: var(--space-4) var(--space-6) var(--space-6); display: grid; gap: var(--space-3); }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); }
    .field { display: grid; gap: var(--space-1); }
    .field label { color: var(--color-gray-700); font-size: var(--font-size-sm); font-weight: 600; }
    .field input, .field select {
      border: 1px solid var(--color-gray-300);
      border-radius: var(--border-radius-sm);
      padding: var(--space-2) var(--space-3);
      font-family: inherit;
      color: var(--color-gray-800);
      background: var(--color-white);
    }
    .field input:focus, .field select:focus {
      outline: none;
      border-color: var(--color-admin);
      box-shadow: 0 0 0 3px rgba(239, 93, 96, 0.16);
    }
    .field--full { grid-column: 1 / -1; }

    .helper { color: var(--color-gray-500); font-size: var(--font-size-xs); line-height: 1.7; }
    .modal-actions { display: flex; justify-content: space-between; flex-wrap: wrap; gap: var(--space-2); padding-top: var(--space-2); border-top: 1px solid var(--color-gray-200); }

    @media (max-width: 1023px) {
      body.rtl .main-content .admin-navbar { right: var(--sidebar-collapsed-width); }
      body.ltr .main-content .admin-navbar { left: var(--sidebar-collapsed-width); }
      body.rtl .main-content { margin-right: var(--sidebar-collapsed-width); }
      body.ltr .main-content { margin-left: var(--sidebar-collapsed-width); }
      .sidebar { width: var(--sidebar-collapsed-width); }
      .sidebar .sidebar__brand-text, .sidebar .sidebar__item span, .sidebar .sidebar__toggle span { display: none; }
      .plans, .form-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 767px) {
      .sidebar { display: none; }
      body.rtl .main-content, body.ltr .main-content { margin: 0; }
      body.rtl .main-content .admin-navbar, body.ltr .main-content .admin-navbar { right: 0; left: 0; }
      .main { padding-inline: var(--space-4); }
      .actions .btn, .plan-footer .btn, .modal-actions .btn { width: 100%; }
      .modal__header, .modal-body { padding-inline: var(--space-4); }
    }
  </style>
</head>
<body class="rtl">
  <aside class="sidebar" id="sidebar" aria-label="Sidebar navigation">
    <div class="sidebar__header"><div class="sidebar__logo">M</div><span class="sidebar__brand-text">سراج - الإدارة</span></div>
    <nav class="sidebar__nav">
      <a class="sidebar__item" href="admin-dashboard.html"><i class="fas fa-gauge"></i><span>نظرة عامة</span></a>
      <a class="sidebar__item" href="admin-ai-config.html"><i class="fas fa-robot"></i><span>إعدادات AI</span></a>
      <a class="sidebar__item" href="admin-prompt-library.html"><i class="fas fa-book-open"></i><span>مكتبة البرومبت</span></a>
      <a class="sidebar__item sidebar__item--active" href="admin-plans.html"><i class="fas fa-layer-group"></i><span>الخطط والاشتراكات</span></a>
      <a class="sidebar__item" href="admin-schools.html"><i class="fas fa-school"></i><span>إدارة المدارس</span></a>
      <a class="sidebar__item" href="admin-settings.html"><i class="fas fa-gear"></i><span>الإعدادات</span></a>
      <a class="sidebar__item" href="admin-profile.html"><i class="fas fa-id-badge"></i><span>ملفي الشخصي</span></a>
    </nav>
    <button class="sidebar__toggle" id="sidebar-toggle" aria-label="Toggle sidebar"><i class="fas fa-angles-right"></i><span>تصغير</span></button>
  </aside>

  <div class="main-content" id="main-content">
    <nav class="navbar admin-navbar" role="navigation" aria-label="Admin top navigation">
      <a href="admin-dashboard.html" class="navbar__brand">
        <div class="navbar__brand-icon"><i class="fas fa-layer-group"></i></div>
        <span class="navbar__brand-text">الخطط والاشتراكات</span>
      </a>
      <div class="navbar__actions">
        <div class="lang-switcher" role="group" aria-label="Language selector">
          <button class="lang-switcher__btn active" data-lang="ar" aria-label="Arabic">&#1593;</button>
          <button class="lang-switcher__btn" data-lang="he" aria-label="Hebrew">&#1506;&#1489;</button>
          <button class="lang-switcher__btn" data-lang="en" aria-label="English">En</button>
        </div>
        <div class="avatar-dropdown">
          <button class="avatar-btn" type="button" data-avatar-toggle="admin-avatar-menu" aria-label="قائمة الحساب">
            <i class="fas fa-user-shield"></i>
          </button>
          <div class="avatar-menu" id="admin-avatar-menu" data-avatar-menu>
            <span class="avatar-menu__label">حساب المدير</span>
            <a class="avatar-menu__link" href="admin-profile.html"><i class="fas fa-id-card"></i><span>ملفي الشخصي</span></a>
            <a class="avatar-menu__link" href="admin-dashboard.html"><i class="fas fa-gauge"></i><span>لوحة الإدارة</span></a>
          </div>
        </div>
        <a href="index.html" class="btn btn--admin btn--sm"><i class="fas fa-right-from-bracket"></i><span>تسجيل الخروج</span></a>
      </div>
    </nav>

    <main class="main">
      <header class="head">
        <div>
          <h1>باقات الاشتراك</h1>
          <p>إدارة أسعار الباقات وحدود التوكنز وتفعيل الخطط المناسبة للمؤسسات.</p>
        </div>
        <span class="status-chip"><i class="fas fa-layer-group"></i><span id="plans-count">0 باقات</span></span>
      </header>

      <section class="plans" id="plans-grid"></section>

      <section class="actions">
        <a href="admin-dashboard.html" class="btn btn--outline">العودة للوحة</a>
        <button class="btn btn--admin" data-modal-open="add-plan-modal"><i class="fas fa-plus"></i><span>إضافة باقة جديدة</span></button>
      </section>
    </main>
  </div>

  <div class="modal-overlay" id="edit-plan-modal" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="edit-plan-title" aria-modal="true">
      <div class="modal__header">
        <h2 id="edit-plan-title">إدارة الخطة</h2>
        <button class="modal__close" data-modal-close aria-label="Close"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <input id="edit-plan-id" type="hidden">
        <div class="form-grid">
          <div class="field"><label for="edit-plan-name">اسم الباقة</label><input id="edit-plan-name" type="text"></div>
          <div class="field"><label for="edit-plan-status">الحالة</label><select id="edit-plan-status"><option value="active">نشطة</option><option value="paused">موقوفة</option></select></div>
          <div class="field"><label for="edit-plan-price">السعر</label><input id="edit-plan-price" type="number" min="0" step="1"></div>
          <div class="field"><label for="edit-plan-currency">العملة</label><select id="edit-plan-currency"><option value="USD">USD</option><option value="SAR">SAR</option><option value="ILS">ILS</option></select></div>
          <div class="field field--full"><label for="edit-plan-tokens">حد التوكنز الشهري</label><input id="edit-plan-tokens" type="number" min="10000" step="10000"></div>
        </div>
        <div class="modal-actions">
          <button class="btn btn--outline" data-modal-close type="button">إلغاء</button>
          <button class="btn btn--admin" id="save-edit-plan" type="button">حفظ الخطة</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="add-plan-modal" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="add-plan-title" aria-modal="true">
      <div class="modal__header">
        <h2 id="add-plan-title">إضافة باقة جديدة</h2>
        <button class="modal__close" data-modal-close aria-label="Close"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="field"><label for="add-plan-name">اسم الباقة</label><input id="add-plan-name" type="text" placeholder="مثال: Enterprise"></div>
          <div class="field"><label for="add-plan-status">الحالة</label><select id="add-plan-status"><option value="active">نشطة</option><option value="paused">موقوفة</option></select></div>
          <div class="field"><label for="add-plan-price">السعر</label><input id="add-plan-price" type="number" min="0" step="1" placeholder="199"></div>
          <div class="field"><label for="add-plan-currency">العملة</label><select id="add-plan-currency"><option value="USD">USD</option><option value="SAR">SAR</option><option value="ILS">ILS</option></select></div>
          <div class="field field--full"><label for="add-plan-tokens">حد التوكنز الشهري</label><input id="add-plan-tokens" type="number" min="10000" step="10000" placeholder="3000000"></div>
        </div>
        <p class="helper">يمكنك إنشاء باقة جديدة وتعديلها لاحقًا من زر "إدارة الخطة".</p>
        <div class="modal-actions">
          <button class="btn btn--outline" data-modal-close type="button">إلغاء</button>
          <button class="btn btn--admin" id="save-add-plan" type="button">إضافة الباقة</button>
        </div>
      </div>
    </div>
  </div>

  <script src="shared-layout.js"></script>
  <script>
    (function () {
      'use strict';

      var plansKey = 'mitests-subscription-plans';
      var plansGridEl = document.getElementById('plans-grid');
      var plansCountEl = document.getElementById('plans-count');

      var editModalEl = document.getElementById('edit-plan-modal');
      var addModalEl = document.getElementById('add-plan-modal');

      var editIdEl = document.getElementById('edit-plan-id');
      var editNameEl = document.getElementById('edit-plan-name');
      var editStatusEl = document.getElementById('edit-plan-status');
      var editPriceEl = document.getElementById('edit-plan-price');
      var editCurrencyEl = document.getElementById('edit-plan-currency');
      var editTokensEl = document.getElementById('edit-plan-tokens');

      var addNameEl = document.getElementById('add-plan-name');
      var addStatusEl = document.getElementById('add-plan-status');
      var addPriceEl = document.getElementById('add-plan-price');
      var addCurrencyEl = document.getElementById('add-plan-currency');
      var addTokensEl = document.getElementById('add-plan-tokens');

      var defaultPlans = [
        { id: 'plan-basic', name: 'Basic', price: 49, currency: 'USD', tokens: 250000, status: 'active' },
        { id: 'plan-pro', name: 'Pro', price: 149, currency: 'USD', tokens: 1500000, status: 'active' },
        { id: 'plan-inst', name: 'Institutional', price: 599, currency: 'USD', tokens: 10000000, status: 'active' }
      ];

      function escapeHtml(value) {
        return String(value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function readPlans() {
        try {
          var raw = localStorage.getItem(plansKey);
          if (!raw) return defaultPlans.slice();
          var parsed = JSON.parse(raw);
          if (!Array.isArray(parsed) || !parsed.length) return defaultPlans.slice();
          return parsed;
        } catch (e) {
          return defaultPlans.slice();
        }
      }

      function savePlans(list) {
        try {
          localStorage.setItem(plansKey, JSON.stringify(list));
        } catch (e) {}
      }

      function normalizePlan(raw, idx) {
        var row = raw || {};
        return {
          id: String(row.id || ('plan-' + idx)).trim(),
          name: String(row.name || 'Plan').trim(),
          price: Number(row.price) || 0,
          currency: String(row.currency || 'USD').trim() || 'USD',
          tokens: Number(row.tokens) || 0,
          status: row.status === 'paused' ? 'paused' : 'active'
        };
      }

      function closeModal(modalEl) {
        if (!modalEl) return;
        modalEl.classList.remove('modal-overlay--active');
        modalEl.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }

      function openModal(modalEl) {
        if (!modalEl) return;
        modalEl.classList.add('modal-overlay--active');
        modalEl.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      }

      var plans = readPlans().map(normalizePlan);

      function formatPrice(plan) {
        return plan.price.toLocaleString() + ' ' + plan.currency + ' / شهر';
      }

      function formatTokens(tokens) {
        return (Number(tokens) || 0).toLocaleString();
      }

      function statusLabel(status) {
        return status === 'paused' ? 'موقوفة' : 'نشطة';
      }

      function renderPlans() {
        plansGridEl.innerHTML = '';

        for (var i = 0; i < plans.length; i++) {
          var plan = plans[i];
          var card = document.createElement('article');
          card.className = 'plan-card';
          card.innerHTML = '' +
            '<h2>' + escapeHtml(plan.name) + '</h2>' +
            '<p class="price">' + formatPrice(plan) + '</p>' +
            '<p class="meta">حد التوكنز: ' + formatTokens(plan.tokens) + ' توكن / شهر</p>' +
            '<div class="plan-footer">' +
              '<span class="status-chip"><i class="fas fa-circle"></i><span>' + escapeHtml(statusLabel(plan.status)) + '</span></span>' +
              '<button class="btn btn--admin btn--sm" type="button" data-plan-id="' + escapeHtml(plan.id) + '">إدارة الخطة</button>' +
            '</div>';
          plansGridEl.appendChild(card);
        }

        plansCountEl.textContent = plans.length + ' باقات';
      }

      function openEditById(id) {
        var target = null;
        for (var i = 0; i < plans.length; i++) {
          if (plans[i].id === id) {
            target = plans[i];
            break;
          }
        }
        if (!target) return;

        editIdEl.value = target.id;
        editNameEl.value = target.name;
        editStatusEl.value = target.status;
        editPriceEl.value = target.price;
        editCurrencyEl.value = target.currency;
        editTokensEl.value = target.tokens;

        openModal(editModalEl);
      }

      plansGridEl.addEventListener('click', function (e) {
        var btn = e.target.closest('[data-plan-id]');
        if (!btn) return;
        openEditById(btn.getAttribute('data-plan-id'));
      });

      document.getElementById('save-edit-plan').addEventListener('click', function () {
        var id = String(editIdEl.value || '').trim();
        var name = String(editNameEl.value || '').trim();
        var status = String(editStatusEl.value || 'active').trim() === 'paused' ? 'paused' : 'active';
        var price = Number(editPriceEl.value);
        var currency = String(editCurrencyEl.value || 'USD').trim() || 'USD';
        var tokens = Number(editTokensEl.value);

        if (!id || !name || !isFinite(price) || price < 0 || !isFinite(tokens) || tokens < 10000) {
          alert('يرجى إدخال بيانات صحيحة للخطة.');
          return;
        }

        for (var i = 0; i < plans.length; i++) {
          if (plans[i].id !== id) continue;
          plans[i].name = name;
          plans[i].status = status;
          plans[i].price = price;
          plans[i].currency = currency;
          plans[i].tokens = tokens;
          break;
        }

        savePlans(plans);
        renderPlans();
        closeModal(editModalEl);
      });

      document.getElementById('save-add-plan').addEventListener('click', function () {
        var name = String(addNameEl.value || '').trim();
        var status = String(addStatusEl.value || 'active').trim() === 'paused' ? 'paused' : 'active';
        var price = Number(addPriceEl.value);
        var currency = String(addCurrencyEl.value || 'USD').trim() || 'USD';
        var tokens = Number(addTokensEl.value);

        if (!name || !isFinite(price) || price < 0 || !isFinite(tokens) || tokens < 10000) {
          alert('يرجى إدخال بيانات صحيحة للباقة الجديدة.');
          return;
        }

        plans.push({
          id: 'plan-' + Date.now().toString(36),
          name: name,
          status: status,
          price: price,
          currency: currency,
          tokens: tokens
        });

        savePlans(plans);
        renderPlans();

        addNameEl.value = '';
        addPriceEl.value = '';
        addTokensEl.value = '';
        addStatusEl.value = 'active';
        addCurrencyEl.value = 'USD';

        closeModal(addModalEl);
      });

      document.addEventListener('keydown', function (e) {
        if (e.key !== 'Escape') return;
        closeModal(editModalEl);
        closeModal(addModalEl);
      });

      document.addEventListener('DOMContentLoaded', function () {
        renderPlans();
      });
    })();
  </script>
</body>
</html>



