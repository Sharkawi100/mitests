<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mitests - معالج إنشاء الاختبار</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <style>
    .teacher-navbar{border-bottom:1px solid var(--color-gray-200)}body.rtl .main-content .teacher-navbar{right:var(--sidebar-width);left:0}body.ltr .main-content .teacher-navbar{left:var(--sidebar-width);right:0}body.rtl .main-content.main-content--expanded .teacher-navbar{right:var(--sidebar-collapsed-width)}body.ltr .main-content.main-content--expanded .teacher-navbar{left:var(--sidebar-collapsed-width)}.teacher-navbar .navbar__brand-icon{background:linear-gradient(135deg,var(--color-teacher),var(--color-primary-400))}.sidebar__item:hover,.sidebar__item--active{background:rgba(53,86,178,.25);color:var(--color-white)}.sidebar__item--active{border-inline-start:3px solid var(--color-teacher)}.btn--teacher{background:var(--color-teacher);border-color:var(--color-teacher);color:var(--color-white)}.btn--teacher:hover{background:var(--color-primary-600);border-color:var(--color-primary-600);color:var(--color-white)}
    .wizard-main{padding:calc(var(--navbar-height) + var(--space-5)) var(--space-6) var(--space-8);max-width:1050px;display:grid;gap:var(--space-4)}body.rtl .wizard-main{margin-left:auto}body.ltr .wizard-main{margin-right:auto}.page-head,.wizard{background:var(--color-white);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-md)}.page-head{padding:var(--space-5);border-top:4px solid var(--color-teacher)}.page-head h1{font-size:var(--font-size-2xl);margin-bottom:var(--space-2)}
    .wizard{padding:var(--space-5)}.bar{height:8px;background:var(--color-primary-100);border-radius:999px;overflow:hidden}.bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--color-teacher),var(--color-primary-400));transition:width .2s}.steps{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--space-2);margin:var(--space-3) 0 var(--space-4)}.step{display:flex;align-items:center;gap:var(--space-2);font-size:var(--font-size-sm);color:var(--color-gray-500);font-weight:600}.step b{width:28px;height:28px;border:2px solid var(--color-gray-300);border-radius:50%;display:inline-flex;align-items:center;justify-content:center}.step.active,.step.done{color:var(--color-teacher)}.step.active b{background:var(--color-teacher);border-color:var(--color-teacher);color:var(--color-white)}.step.done b{border-color:var(--color-teacher)}
    .panel{display:none;gap:var(--space-4)}.panel.active{display:grid}.grid2{display:grid;grid-template-columns:1fr 1fr;gap:var(--space-3)}.field{display:grid;gap:var(--space-1)}.field.full{grid-column:1/-1}.field input,.field select,.field textarea{border:1px solid var(--color-gray-300);border-radius:var(--border-radius-sm);padding:var(--space-3);font-family:inherit}.field textarea{min-height:120px;resize:vertical}.field input:focus,.field select:focus,.field textarea:focus{outline:0;border-color:var(--color-teacher);box-shadow:0 0 0 3px rgba(53,86,178,.15)}
    .tags{display:flex;flex-wrap:wrap;gap:var(--space-2)}.tag{border:1px solid var(--color-primary-300);background:var(--color-primary-100);padding:var(--space-1) var(--space-3);border-radius:999px;cursor:pointer}.tag.on{background:var(--color-teacher);border-color:var(--color-teacher);color:var(--color-white)}.srcs{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--space-3)}.src{border:2px solid var(--color-gray-200);border-radius:var(--border-radius-md);padding:var(--space-4);cursor:pointer}.src.on{border-color:var(--color-teacher);background:rgba(53,86,178,.06)}.src i{color:var(--color-teacher);font-size:1.3rem}.srcp{display:none}.srcp.on{display:block}.drop,.editor{border:2px dashed var(--color-primary-300);border-radius:var(--border-radius-md);padding:var(--space-6);text-align:center;color:var(--color-gray-600)}.editor{border-style:solid;min-height:170px}
    .checks{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--space-2)}.checks label{border:1px solid var(--color-gray-200);padding:var(--space-2);border-radius:var(--border-radius-sm);display:flex;gap:var(--space-2);align-items:center}.checks input,.switch input{accent-color:var(--color-teacher)}.toggle{display:flex;align-items:center;justify-content:space-between;padding:var(--space-3);background:var(--color-primary-100);border:1px solid var(--color-primary-300);border-radius:var(--border-radius-md)}
    .summary{border:1px solid var(--color-gray-200);border-radius:var(--border-radius-md);overflow:hidden}.row{display:grid;grid-template-columns:180px 1fr;padding:var(--space-2) var(--space-3);border-bottom:1px solid var(--color-gray-100)}.row:last-child{border-bottom:0}.row dt{color:var(--color-gray-500);font-weight:600}.row dd{margin:0}.actions{display:flex;justify-content:space-between;gap:var(--space-3);margin-top:var(--space-2)}.end{display:flex;gap:var(--space-2)}.gen{background:linear-gradient(135deg,var(--color-teacher),#4c6fd2);border-color:var(--color-teacher);color:var(--color-white);box-shadow:0 0 0 rgba(76,111,210,.45);animation:glow 2s infinite}.gen:hover{background:linear-gradient(135deg,var(--color-primary-600),var(--color-primary-500));color:var(--color-white)}@keyframes glow{70%{box-shadow:0 0 0 14px rgba(76,111,210,0)}}
    .ov{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:900}.ov.on{display:flex}.box{background:var(--color-white);border-radius:var(--border-radius-lg);padding:var(--space-6);text-align:center;min-width:270px}.spin{width:48px;height:48px;margin:0 auto var(--space-3);border:4px solid var(--color-primary-200);border-top-color:var(--color-teacher);border-radius:50%;animation:sp .9s linear infinite}@keyframes sp{to{transform:rotate(360deg)}}
    @media (max-width:1023px){body.rtl .main-content .teacher-navbar{right:var(--sidebar-collapsed-width)}body.ltr .main-content .teacher-navbar{left:var(--sidebar-collapsed-width)}body.rtl .main-content{margin-right:var(--sidebar-collapsed-width)}body.ltr .main-content{margin-left:var(--sidebar-collapsed-width)}.sidebar{width:var(--sidebar-collapsed-width)}.sidebar .sidebar__brand-text,.sidebar .sidebar__item span,.sidebar .sidebar__toggle span{display:none}.grid2,.srcs,.checks{grid-template-columns:1fr}.steps{grid-template-columns:repeat(2,1fr)}}@media (max-width:767px){.sidebar{display:none}body.rtl .main-content,body.ltr .main-content{margin:0}body.rtl .main-content .teacher-navbar,body.ltr .main-content .teacher-navbar{right:0;left:0}.wizard-main{padding-inline:var(--space-4)}.actions,.end{flex-direction:column}.actions .btn,.end .btn{width:100%}.actions{position:sticky;bottom:calc(env(safe-area-inset-bottom,0px) + 8px);background:rgba(255,255,255,.96);backdrop-filter:blur(6px);border:1px solid var(--color-primary-200);border-radius:12px;padding:var(--space-3);z-index:25}}
    .breadcrumb{font-size:var(--font-size-sm);color:var(--color-gray-500);display:flex;align-items:center;gap:var(--space-2)}.breadcrumb a{color:var(--color-teacher);text-decoration:none}.breadcrumb a:hover{text-decoration:underline}
    .file-preview{display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3);background:var(--color-primary-100);border:1px solid var(--color-primary-300);border-radius:var(--border-radius-sm);margin-top:var(--space-2)}.file-preview i{color:var(--color-teacher);font-size:1.2rem}.file-preview .file-name{flex:1;font-size:var(--font-size-sm);font-weight:600;color:var(--color-gray-800)}.file-preview .file-remove{background:none;border:none;color:var(--color-admin);cursor:pointer;font-size:var(--font-size-lg);padding:var(--space-1)}
    .drop.drag-over{border-color:var(--color-teacher);background:rgba(53,86,178,.08)}.drop{cursor:pointer}
    .file-ai-panel{margin-top:var(--space-3);border:1px solid var(--color-primary-300);border-radius:var(--border-radius-md);padding:var(--space-3);background:rgba(53,86,178,.04);display:grid;gap:var(--space-2)}.file-ai-panel strong{color:var(--color-teacher)}.file-ai-list{margin:0;padding-inline-start:1.2rem;display:grid;gap:4px}.file-ai-status{font-size:var(--font-size-sm);color:var(--color-gray-700)}.field-help{font-size:var(--font-size-xs);color:var(--color-gray-500)}.no-text-box{border:1px solid var(--color-primary-300);border-radius:var(--border-radius-md);background:var(--color-primary-100);padding:var(--space-4);display:grid;gap:var(--space-3)}
    .field.error input,.field.error select,.field.error textarea{border-color:var(--color-admin);box-shadow:0 0 0 3px rgba(239,93,96,.12)}.field .error-msg{color:var(--color-admin);font-size:var(--font-size-xs);margin-top:2px;display:none}.field.error .error-msg{display:block}
    .success-box{min-width:320px}.success-icon{font-size:3rem;color:#16a34a;margin-bottom:var(--space-3)}.success-actions{display:flex;gap:var(--space-2);margin-top:var(--space-4);justify-content:center}
    .wizard-toast{position:fixed;bottom:var(--space-5);inset-inline-start:50%;transform:translateX(-50%);background:#111827;color:var(--color-white);padding:var(--space-2) var(--space-4);border-radius:999px;box-shadow:var(--shadow-lg);font-size:var(--font-size-sm);z-index:1300;display:none}.wizard-toast.on{display:block}
    .wizard-mode-bar{display:grid;gap:var(--space-2);margin-bottom:var(--space-4);padding:var(--space-3);border:1px solid var(--color-primary-300);border-radius:var(--border-radius-md);background:rgba(53,86,178,.05)}.mode-switch{display:inline-flex;gap:var(--space-1);background:var(--color-white);border:1px solid var(--color-primary-200);padding:4px;border-radius:999px;width:max-content}.mode-btn{border:0;background:transparent;padding:8px 14px;border-radius:999px;font-weight:700;color:var(--color-gray-600);cursor:pointer}.mode-btn.on{background:var(--color-teacher);color:var(--color-white)}.wizard-mode-help{margin:0;color:var(--color-gray-700);font-size:var(--font-size-sm)}
    .preset-strip{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:var(--space-2);margin-bottom:var(--space-3)}.preset-chip{border:1px solid var(--color-primary-200);background:var(--color-white);border-radius:var(--border-radius-md);padding:var(--space-2);text-align:start;cursor:pointer;display:grid;gap:2px}.preset-chip strong{color:var(--color-gray-900);font-size:var(--font-size-sm)}.preset-chip span{font-size:var(--font-size-xs);color:var(--color-gray-600)}.preset-chip.on{border-color:var(--color-teacher);background:rgba(53,86,178,.08);box-shadow:0 0 0 2px rgba(53,86,178,.12)}
    .advanced-section{border:1px solid var(--color-primary-200);border-radius:var(--border-radius-md);padding:var(--space-3);background:rgba(53,86,178,.04);display:grid;gap:var(--space-3)}.advanced-section summary{cursor:pointer;font-weight:700;color:var(--color-teacher)}.advanced-section[open] summary{margin-bottom:var(--space-1)}.advanced-grid{padding-top:var(--space-1)}.ai-step-note{margin:0 0 var(--space-2);color:var(--color-gray-700);font-size:var(--font-size-sm)}
    .steps .step.step--hidden{display:none}
    .live-summary{margin-top:var(--space-4);padding:var(--space-4);border:1px solid var(--color-primary-300);border-radius:var(--border-radius-md);background:linear-gradient(145deg,rgba(53,86,178,.08),rgba(255,255,255,.98));display:grid;gap:var(--space-3)}.live-summary__head{display:flex;justify-content:space-between;align-items:center;gap:var(--space-2)}.live-summary__head h3{margin:0;font-size:var(--font-size-lg)}.live-summary__status{font-size:var(--font-size-xs);color:var(--color-gray-600)}.live-summary__grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:var(--space-2)}.live-summary__item{padding:var(--space-2);background:var(--color-white);border:1px solid var(--color-primary-200);border-radius:var(--border-radius-sm);display:grid;gap:2px}.live-summary__item span{font-size:var(--font-size-xs);color:var(--color-gray-500)}.live-summary__item strong{font-size:var(--font-size-sm);color:var(--color-gray-900)}.live-summary__estimate{margin:0;font-size:var(--font-size-sm);color:var(--color-gray-700)}
    .drop.drop-error{border-color:var(--color-admin);background:rgba(239,93,96,.08)}
    @media (max-width:1023px){.preset-strip,.live-summary__grid{grid-template-columns:1fr 1fr}}
    @media (max-width:767px){.mode-switch{width:100%;display:grid;grid-template-columns:1fr 1fr}.preset-strip,.live-summary__grid{grid-template-columns:1fr}.live-summary__head{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body class="rtl">
  <aside class="sidebar" id="sidebar" aria-label="Sidebar navigation">
    <div class="sidebar__header"><div class="sidebar__logo">M</div><span class="sidebar__brand-text">سراج - المعلم</span></div>
    <nav class="sidebar__nav">
      <a class="sidebar__item" href="teacher-dashboard.html"><i class="fas fa-gauge"></i><span>نظرة عامة</span></a>
      <a class="sidebar__item sidebar__item--active" href="exam-wizard.html"><i class="fas fa-file-lines"></i><span>إنشاء اختبار</span></a>
      <a class="sidebar__item" href="teacher-tasks.html"><i class="fas fa-list-check"></i><span>مهام المعلم</span></a>
      <a class="sidebar__item" href="teacher-group.html"><i class="fas fa-users"></i><span>المجموعات</span></a>
      <a class="sidebar__item" href="teacher-question-bank.html"><i class="fas fa-database"></i><span>بنك الأسئلة</span></a>
      <a class="sidebar__item" href="teacher-community.html"><i class="fas fa-comments"></i><span>المجتمع</span></a>
      <a class="sidebar__item" href="teacher-settings.html"><i class="fas fa-gear"></i><span>الإعدادات</span></a>
    </nav>
    <button class="sidebar__toggle" id="sidebar-toggle" aria-label="Toggle sidebar"><i class="fas fa-angles-right"></i><span>تصغير</span></button>
  </aside>
  <div class="main-content" id="main-content">
    <nav class="navbar teacher-navbar" role="navigation" aria-label="Teacher top navigation">
      <a href="teacher-dashboard.html" class="navbar__brand"><div class="navbar__brand-icon"><i class="fas fa-wand-magic-sparkles"></i></div><span class="navbar__brand-text">معالج الاختبار</span></a>
      <div class="navbar__actions">
        <div class="lang-switcher" role="group" aria-label="Language selector">
          <button class="lang-switcher__btn active" data-lang="ar" aria-label="Arabic">&#1593;</button><button class="lang-switcher__btn" data-lang="he" aria-label="Hebrew">&#1506;&#1489;</button><button class="lang-switcher__btn" data-lang="en" aria-label="English">En</button>
        </div>
        <div class="avatar-dropdown">
          <button class="avatar-btn" type="button" data-avatar-toggle="teacher-avatar-menu" aria-label="قائمة حساب المعلم"><i class="fas fa-user"></i></button>
          <div class="avatar-menu" id="teacher-avatar-menu" data-avatar-menu>
            <span class="avatar-menu__label">حساب المعلم</span>
            <a class="avatar-menu__link" href="teacher-profile.html"><i class="fas fa-id-card"></i><span>الملف الشخصي</span></a>
            <a class="avatar-menu__link" href="teacher-settings.html"><i class="fas fa-gear"></i><span>الإعدادات</span></a>
          </div>
        </div>
        <a href="index.html" class="btn btn--teacher btn--sm"><i class="fas fa-right-from-bracket"></i><span>تسجيل الخروج</span></a>
      </div>
    </nav>
    <main class="wizard-main">
      <nav class="breadcrumb" aria-label="Breadcrumb"><a href="teacher-dashboard.html">لوحة المعلم</a> <span>›</span> <span>معالج الاختبار</span></nav>
      <header class="page-head"><h1 data-i18n="wizardTitle">معالج إنشاء الاختبار بالذكاء الاصطناعي</h1><p data-i18n="wizardSub">تدفق موجه من 4 خطوات لبناء اختبار كامل.</p></header>
      <section id="bank-seed" class="card hidden">
        <h2>أسئلة مضافة من بنك الأسئلة</h2>
        <p id="bank-seed-count" class="helper-text"></p>
        <ul id="bank-seed-list"></ul>
        <div>
          <button type="button" id="bank-seed-clear" class="btn btn--outline btn--sm">مسح القائمة</button>
        </div>
      </section>
      <section class="wizard">
        <div class="bar"><span id="pfill"></span></div>
        <div class="steps">
          <div class="step active" data-si="1"><b>1</b><span>معلومات عامة</span></div>
          <div class="step" data-si="2"><b>2</b><span>مصدر المحتوى</span></div>
          <div class="step" data-si="3"><b>3</b><span>خيارات متقدمة</span></div>
          <div class="step" data-si="4"><b>4</b><span>مراجعة وإنشاء</span></div>
        </div>
        <div class="wizard-mode-bar">
          <div class="mode-switch" role="group" aria-label="نمط المعالج">
            <button type="button" class="mode-btn on" data-mode="quick">إنشاء سريع</button>
            <button type="button" class="mode-btn" data-mode="advanced">إنشاء متقدم</button>
          </div>
          <p class="wizard-mode-help" id="wizard-mode-help">الوضع السريع يقلل الحقول الإلزامية ويستخدم إعدادات ذكية جاهزة.</p>
        </div>

        <section class="panel active" data-sp="1">
          <h2>معلومات عامة</h2>
          <div class="preset-strip" id="preset-strip">
            <button type="button" class="preset-chip on" data-preset="standard" data-q="10" data-difficulty="mixed" data-duration="45" data-types="MC,Open-end,True/False"><strong>اختبار قياسي</strong><span>10 أسئلة - 45 دقيقة</span></button>
            <button type="button" class="preset-chip" data-preset="quick_quiz" data-q="6" data-difficulty="easy" data-duration="20" data-types="MC,True/False"><strong>اختبار سريع</strong><span>6 أسئلة - 20 دقيقة</span></button>
            <button type="button" class="preset-chip" data-preset="homework" data-q="8" data-difficulty="medium" data-duration="30" data-types="MC,Short Answer,Completion"><strong>واجب منزلي</strong><span>8 أسئلة - تركيز تطبيقي</span></button>
            <button type="button" class="preset-chip" data-preset="challenge" data-q="12" data-difficulty="hard" data-duration="60" data-types="Open-end,MC,Matching"><strong>تحدي متقدم</strong><span>12 سؤالاً - صعوبة عالية</span></button>
          </div>
          <div class="grid2">
            <div class="field full"><label for="et">عنوان الاختبار</label><input id="et" placeholder="مثال: اختبار اللغة الإنجليزية للصف التاسع"></div>
            <div class="field"><label for="ek">نوع التقييم</label><select id="ek"><option value="">اختر النوع</option><option value="exam">اختبار</option><option value="assignment">واجب</option></select></div>
            <div class="field"><label for="eg">الصف</label><select id="eg"><option value="">اختر الصف</option></select></div>
            <div class="field"><label for="es">المادة</label><select id="es"><option value="">اختر المادة</option></select></div>
            <div class="field"><label for="esd">تاريخ الاختبار</label><input id="esd" type="date"><small class="error-msg">يرجى تحديد تاريخ الاختبار</small></div>
            <div class="field"><label for="est">وقت البدء</label><input id="est" type="time"><small class="error-msg">يرجى تحديد وقت بدء الاختبار</small></div>
          </div>
          <details class="advanced-section" id="general-advanced">
            <summary>إعدادات متقدمة للأسئلة</summary>
            <div class="grid2 advanced-grid">
              <div class="field full">
                <label>المهارات (اختيار متعدد)</label>
                <div class="tags" id="skills">
                  <button type="button" class="tag" data-skill="القراءة الناقدة">القراءة الناقدة</button>
                  <button type="button" class="tag" data-skill="حل المشكلات">حل المشكلات</button>
                  <button type="button" class="tag" data-skill="تفكير تحليلي">تفكير تحليلي</button>
                  <button type="button" class="tag" data-skill="استخلاص النتائج">استخلاص النتائج</button>
                </div>
              </div>
              <div class="field"><label for="eq">عدد الأسئلة</label><input id="eq" type="number" min="1" max="50" placeholder="مثال: 15"></div>
              <div class="field"><label for="ed">مستوى الصعوبة</label><select id="ed"><option value="">اختر المستوى</option><option value="easy">سهل</option><option value="medium">متوسط</option><option value="hard">صعب</option><option value="mixed">مختلط</option></select></div>
              <div class="field"><label for="edr">مدة الاختبار (بالدقائق)</label><input id="edr" type="number" min="5" max="180" placeholder="مثال: 45"></div>
            </div>
          </details>
        </section>

        <section class="panel" data-sp="2">
          <h2>مصدر المحتوى</h2>
          <div class="srcs" style="grid-template-columns: repeat(2, 1fr);">
            <button type="button" class="src on" data-src="up"><i class="fas fa-file-arrow-up"></i><h3>أ. رفع ملف</h3><p>PDF / Docs</p></button>
            <button type="button" class="src" data-src="ai"><i class="fas fa-pen-fancy"></i><h3>ب. توليد نص بالذكاء الاصطناعي</h3><p>الموضوع / النوع / طول النص</p></button>
            <button type="button" class="src" data-src="nt"><i class="fas fa-wand-magic-sparkles"></i><h3>ج. اختبار بدون نص</h3><p>توليد AI مباشر بدون قطعة قراءة</p></button>
            <button type="button" class="src" data-src="manual"><i class="fas fa-pen-to-square"></i><h3>د. إدخال يدوي</h3><p>كتابة الأسئلة يدوياً بدون AI</p></button>
          </div>
          <div class="srcp on" data-srcp="up"><div class="drop" id="drop-zone"><input type="file" id="file-input" accept=".pdf,.doc,.docx" hidden><i class="fas fa-cloud-arrow-up"></i><p><strong>اسحب الملف هنا أو اضغط للاختيار</strong><br>PDF / Docs</p></div><div id="file-preview" class="file-preview hidden"></div><div id="file-ai-panel" class="file-ai-panel hidden"><div class="file-ai-status" id="file-ai-status">سيتم تحليل الملف بعد الرفع.</div><label class="field">إجراء مقترح من AI<select id="file-ai-action"><option value="convert_db">تحويل المحتوى إلى قاعدة الأسئلة</option><option value="similar_exam">توليد اختبار مشابه لنفس المستوى</option><option value="extract_outcomes">استخراج نواتج التعلم وبناء مخطط اختبار</option><option value="homework_variant">إنشاء نسخة واجب مختصرة من نفس الملف</option><option value="mix_strategy">استراتيجية هجينة (استخراج + توليد)</option></select></label><ul id="file-ai-list" class="file-ai-list"></ul></div></div>
          <div class="srcp" data-srcp="ai"><div class="grid2"><div class="field"><label for="at">الموضوع</label><input id="at"></div><div class="field"><label for="ag">النمط</label><select id="ag"><option value="">اختر النمط</option><option>قصة</option><option>حوار</option><option>قطعة علمية</option><option>مقال</option></select></div><div class="field full"><label for="al">طول النص</label><select id="al"><option value="">اختر الطول</option><option value="short">قصير (حتى 300 كلمة)</option><option value="medium">متوسط (300-600 كلمة)</option><option value="long">طويل (أكثر من 600 كلمة)</option></select></div></div></div>
          <div class="srcp" data-srcp="nt"><div class="no-text-box"><p><strong>توليد اختبار بدون نص</strong><br>يستخدم AI لبناء اختبار مباشر بدون قطعة قراءة. مناسب للرياضيات، المفاهيم العلمية، أو اختبارات المهارات.</p><div class="grid2"><div class="field"><label for="nt-goal">هدف الاختبار</label><input id="nt-goal" placeholder="مثال: قياس إتقان الكسور والنسب"></div><div class="field"><label for="nt-focus">التركيز</label><select id="nt-focus"><option value="">اختر التركيز</option><option value="concepts">مفاهيم أساسية</option><option value="application">تطبيق عملي</option><option value="mixed">مختلط</option></select></div><div class="field full"><label for="nt-extra">تعليمات إضافية للذكاء الاصطناعي</label><textarea id="nt-extra" placeholder="مثال: اجعل 30% من الأسئلة تحديات قصيرة بدون نص."></textarea><small class="field-help">يقترح النظام أسئلة مباشرة بدون نص تمهيدي مع الحفاظ على مستوى الصف والصعوبة.</small></div></div></div></div>
          <div class="srcp" data-srcp="manual"><div class="no-text-box" style="background:var(--color-primary-50); border-color:var(--color-teacher);"><p><strong>الإدخال اليدوي</strong><br>سيتم نقلك إلى محرر الاختبار التقليدي لإضافة الأسئلة وكتابتها بنفسك. سيتم حفظ العنوان والصف والمادة التي اخترتها.</p><button type="button" class="btn btn--teacher" id="go-manual-btn">الانتقال للمحرر اليدوي الآن <i class="fas fa-arrow-left"></i></button></div></div>
        </section>

        <section class="panel" data-sp="3">
          <h2>خيارات الذكاء الاصطناعي المتقدمة</h2>
          <p class="ai-step-note" id="ai-step-note">في الوضع السريع يمكنك تجاوز هذه الخطوة، وسيتم الاعتماد على القالب الذي اخترته.</p>
          <details class="advanced-section" id="ai-advanced" open>
            <summary>تحرير هيكلة الأسئلة والتعليمات</summary>
            <div class="field">
              <label>اختيار أنواع الأسئلة</label>
              <div class="checks">
                <label><input type="checkbox" name="qt" value="MC" checked>MC</label>
                <label><input type="checkbox" name="qt" value="Open-end" checked>مفتوح</label>
                <label><input type="checkbox" name="qt" value="True/False">صح/خطأ</label>
                <label><input type="checkbox" name="qt" value="Matching">مطابقة</label>
                <label><input type="checkbox" name="qt" value="Short Answer">إجابة قصيرة</label>
                <label><input type="checkbox" name="qt" value="Completion">إكمال</label>
              </div>
            </div>
            <div class="toggle"><div><strong>تفعيل تصنيف بلوم</strong><p>الوزن الذكي (المستوى 1=1، المستوى 2=2...)</p></div><label class="switch"><input id="sw" type="checkbox"><span>تفعيل</span></label></div>
            <div class="field"><label for="tr">تعليمات خاصة للذكاء الاصطناعي</label><textarea id="tr" placeholder="اكتب طلب المعلم الخاص"></textarea></div>
          </details>
        </section>

        <section class="panel" data-sp="4">
          <h2>مراجعة وإنشاء</h2>
          <dl class="summary">
            <div class="row"><dt>نمط الإنشاء</dt><dd id="smode">-</dd></div>
            <div class="row"><dt>القالب</dt><dd id="spreset">-</dd></div>
            <div class="row"><dt>نوع التقييم</dt><dd id="stk">-</dd></div>
            <div class="row"><dt>عنوان الاختبار</dt><dd id="st">-</dd></div>
            <div class="row"><dt>الصف</dt><dd id="sg">-</dd></div>
            <div class="row"><dt>المادة</dt><dd id="ss">-</dd></div>
            <div class="row"><dt>المهارات</dt><dd id="sk">-</dd></div>
            <div class="row"><dt>مصدر المحتوى</dt><dd id="sc">-</dd></div>
            <div class="row"><dt>خطة المعالجة</dt><dd id="sfc">-</dd></div>
            <div class="row"><dt>أنواع الأسئلة</dt><dd id="sq">-</dd></div>
            <div class="row"><dt>الوزن الذكي</dt><dd id="swv">-</dd></div>
            <div class="row"><dt>طلب المعلم</dt><dd id="sr">-</dd></div>
            <div class="row"><dt>عدد الأسئلة</dt><dd id="sqc">-</dd></div>
            <div class="row"><dt>مستوى الصعوبة</dt><dd id="sdf">-</dd></div>
            <div class="row"><dt>مدة الاختبار</dt><dd id="sdr">-</dd></div>
            <div class="row"><dt>موعد الاختبار</dt><dd id="ssc">-</dd></div>
          </dl>
        </section>
        <section class="live-summary" id="live-summary">
          <div class="live-summary__head">
            <h3>ملخص مباشر</h3>
            <span class="live-summary__status" id="autosave-status">الحفظ التلقائي مفعل</span>
          </div>
          <div class="live-summary__grid">
            <div class="live-summary__item"><span>النمط</span><strong id="live-mode">إنشاء سريع</strong></div>
            <div class="live-summary__item"><span>القالب</span><strong id="live-preset">اختبار قياسي</strong></div>
            <div class="live-summary__item"><span>النوع</span><strong id="live-kind">اختبار</strong></div>
            <div class="live-summary__item"><span>العنوان</span><strong id="live-title">غير محدد</strong></div>
            <div class="live-summary__item"><span>الصف / المادة</span><strong id="live-grade-subject">غير محدد</strong></div>
            <div class="live-summary__item"><span>المصدر</span><strong id="live-source">رفع ملف</strong></div>
          </div>
          <p class="live-summary__estimate" id="live-estimate">ناتج متوقع: 10 أسئلة خلال 45 دقيقة.</p>
        </section>

        <div class="actions">
          <button id="back" type="button" class="btn btn--outline">السابق</button>
          <div class="end">
            <button id="next" type="button" class="btn btn--teacher">التالي</button>
            <button id="draft" type="button" class="btn btn--outline btn--lg hidden"><i class="fas fa-save"></i> حفظ كمسودة</button>
            <button id="gen" type="button" class="btn gen btn--lg hidden"><i class="fas fa-wand-magic-sparkles"></i> إنشاء الاختبار بالذكاء الاصطناعي</button>
          </div>
        </div>
      </section>
    </main>
  </div>
  <div id="ov" class="ov" aria-hidden="true"><div class="box"><div class="spin"></div><strong>جاري المعالجة...</strong><p>يتم الآن إنشاء الاختبار باستخدام الذكاء الاصطناعي</p></div></div>
  <div id="success-ov" class="ov" aria-hidden="true"><div class="box success-box"><i class="fas fa-circle-check success-icon"></i><strong>تم إنشاء الاختبار بنجاح!</strong><p>يمكنك الآن مراجعة الاختبار أو العودة للوحة المعلم.</p><div class="success-actions"><a href="exam-preview.html" class="btn gen" id="success-preview-link">عرض الاختبار</a><a href="teacher-dashboard.html" class="btn btn--outline">العودة للوحة</a></div></div></div>
  <div id="wizard-toast" class="wizard-toast" aria-live="polite"></div>
  <script src="shared-layout.js"></script>
  <script src="tenant-mode.js"></script>
  <script src="cefr-data.js"></script>
  <script>
    (function () {
      'use strict';

      var currentStep = 1;
      var wizardPanels = document.querySelectorAll('[data-sp]');
      var steps = document.querySelectorAll('[data-si]');
      var wizardRoot = document.querySelector('.wizard');
      var fill = document.getElementById('pfill');
      var backBtn = document.getElementById('back');
      var nextBtn = document.getElementById('next');
      var genBtn = document.getElementById('gen');
      var draftBtn = document.getElementById('draft');
      var overlay = document.getElementById('ov');
      var successPreviewLink = document.getElementById('success-preview-link');
      var dropZone = document.getElementById('drop-zone');
      var fileInput = document.getElementById('file-input');
      var filePreview = document.getElementById('file-preview');
      var fileAiPanel = document.getElementById('file-ai-panel');
      var fileAiStatus = document.getElementById('file-ai-status');
      var fileAiList = document.getElementById('file-ai-list');
      var fileAiAction = document.getElementById('file-ai-action');
      var uploadedFile = null;
      var kindSelect = document.getElementById('ek');
      var gradeSelect = document.getElementById('eg');
      var subjectSelect = document.getElementById('es');
      var questionCountInput = document.getElementById('eq');
      var difficultySelect = document.getElementById('ed');
      var durationInput = document.getElementById('edr');
      var aiTopicInput = document.getElementById('at');
      var noTextGoalInput = document.getElementById('nt-goal');
      var noTextFocusInput = document.getElementById('nt-focus');
      var noTextExtraInput = document.getElementById('nt-extra');
      var scheduleDateInput = document.getElementById('esd');
      var scheduleTimeInput = document.getElementById('est');
      var seedBox = document.getElementById('bank-seed');
      var seedCount = document.getElementById('bank-seed-count');
      var seedList = document.getElementById('bank-seed-list');
      var clearSeedBtn = document.getElementById('bank-seed-clear');
      var wizardToast = document.getElementById('wizard-toast');
      var modeButtons = document.querySelectorAll('.mode-btn');
      var modeHelp = document.getElementById('wizard-mode-help');
      var presetButtons = document.querySelectorAll('.preset-chip');
      var generalAdvanced = document.getElementById('general-advanced');
      var aiAdvanced = document.getElementById('ai-advanced');
      var aiStepNote = document.getElementById('ai-step-note');
      var autosaveStatus = document.getElementById('autosave-status');
      var liveMode = document.getElementById('live-mode');
      var livePreset = document.getElementById('live-preset');
      var liveKind = document.getElementById('live-kind');
      var liveTitle = document.getElementById('live-title');
      var liveGradeSubject = document.getElementById('live-grade-subject');
      var liveSource = document.getElementById('live-source');
      var liveEstimate = document.getElementById('live-estimate');
      var scheduleBufferMinutes = 60;
      var wizardMode = 'quick';
      var selectedPreset = 'standard';
      var autosaveKey = 'mitests-exam-wizard-autosave';

      function showToast(message) {
        if (!wizardToast) return;
        wizardToast.textContent = String(message || '');
        wizardToast.classList.add('on');
        window.setTimeout(function () {
          wizardToast.classList.remove('on');
        }, 2600);
      }

      var gradesKey = 'mitests-admin-grades';
      var subjectsKey = 'mitests-admin-subjects';
      var defaultGrades = ['الصف السابع', 'الصف الثامن', 'الصف التاسع', 'الصف العاشر'];
      var defaultSubjects = ['اللغة العربية', 'اللغة الإنجليزية', 'الرياضيات', 'العلوم'];

      function readInitialKind() {
        var kind = '';
        try {
          kind = new URLSearchParams(window.location.search).get('kind') || '';
        } catch (e) {}
        if (kind !== 'exam' && kind !== 'assignment') {
          try {
            var storedKind = localStorage.getItem('mitests-create-item-kind') || '';
            if (storedKind === 'exam' || storedKind === 'assignment') kind = storedKind;
          } catch (e2) {}
        }
        return (kind === 'assignment') ? 'assignment' : 'exam';
      }

      function hydrateInitialKind() {
        if (!kindSelect) return;
        var initialKind = readInitialKind();
        kindSelect.value = initialKind;
        try { localStorage.setItem('mitests-create-item-kind', initialKind); } catch (e) {}
      }

      function loadCatalog(key, fallback) {
        try {
          var raw = localStorage.getItem(key);
          if (!raw) return fallback.slice();
          var parsed = JSON.parse(raw);
          if (Array.isArray(parsed) && parsed.length) return parsed;
        } catch (e) {}
        return fallback.slice();
      }

      function renderSelect(selectEl, placeholder, items) {
        if (!selectEl) return;
        selectEl.innerHTML = '';

        var placeholderOpt = document.createElement('option');
        placeholderOpt.value = '';
        placeholderOpt.textContent = placeholder;
        selectEl.appendChild(placeholderOpt);

        for (var i = 0; i < items.length; i++) {
          var opt = document.createElement('option');
          opt.value = items[i];
          opt.textContent = items[i];
          selectEl.appendChild(opt);
        }
      }

      function hydrateCatalogs() {
        renderSelect(gradeSelect, 'اختر الصف', loadCatalog(gradesKey, defaultGrades));
        renderSelect(subjectSelect, 'اختر المادة', loadCatalog(subjectsKey, defaultSubjects));
      }

      function getCurrentScope() {
        var tenantType = 'school_teacher';
        try {
          tenantType = localStorage.getItem('mitests-tenant-type') || 'school_teacher';
        } catch (e) {}
        var scope = 'school:SCH-001';
        if (tenantType === 'personal_teacher') {
          var wsRaw = '';
          try {
            wsRaw = localStorage.getItem('mitests-personal-workspace') || '';
          } catch (e2) {}
          if (wsRaw) {
            try {
              var ws = JSON.parse(wsRaw);
              scope = 'personal:' + (ws.workspaceId || 'default');
            } catch (e3) {
              scope = 'personal:default';
            }
          } else {
            scope = 'personal:default';
          }
        } else {
          var schoolId = 'SCH-001';
          try {
            schoolId = localStorage.getItem('mitests-school-id') || 'SCH-001';
          } catch (e4) {}
          scope = 'school:' + schoolId;
        }
        return scope;
      }

      function readStoredArray(key) {
        var items = [];
        try {
          var raw = localStorage.getItem(key);
          if (raw) {
            var parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) items = parsed;
          }
        } catch (e) {}
        return items;
      }

      function normalizeDurationMinutes(rawValue) {
        var parsed = parseInt(rawValue, 10);
        if (!isNaN(parsed) && parsed >= 5 && parsed <= 180) return parsed;
        return 45;
      }

      function toDisplayDateTime(isoString) {
        if (!isoString) return 'غير محدد';
        var time = new Date(isoString);
        if (isNaN(time.getTime())) return 'غير محدد';
        try {
          return time.toLocaleString('ar-EG', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch (e) {
          return isoString;
        }
      }

      function getAiProviderName() {
        try {
          return localStorage.getItem('mitests-admin-ai-provider') || 'Claude 3.5';
        } catch (e) {
          return 'Claude 3.5';
        }
      }

      function getFileExtension(fileName) {
        var name = String(fileName || '');
        var dot = name.lastIndexOf('.');
        if (dot === -1) return '';
        return name.substring(dot + 1).toLowerCase();
      }

      function resetFileAiPanel() {
        if (!fileAiPanel || !fileAiStatus || !fileAiList) return;
        fileAiPanel.classList.add('hidden');
        fileAiStatus.textContent = 'سيتم تحليل الملف بعد الرفع.';
        fileAiList.innerHTML = '';
        if (fileAiAction) fileAiAction.value = 'convert_db';
      }

      function runFileAiAnalysis(file) {
        if (!fileAiPanel || !fileAiStatus || !fileAiList) return;

        var provider = getAiProviderName();
        var ext = getFileExtension(file ? file.name : '');
        var sizeKb = file ? Math.max(1, Math.round(file.size / 1024)) : 0;

        fileAiPanel.classList.remove('hidden');
        fileAiStatus.textContent = 'جاري تحليل الملف عبر مزود AI (' + provider + ')...';
        fileAiList.innerHTML = '';

        window.setTimeout(function () {
          var suggestions = [
            'استخراج الأسئلة والاختيارات تلقائيًا وتحويلها إلى قاعدة بيانات الأسئلة.',
            'توليد اختبار مشابه بنفس الدرجة والمادة مع تنويع صياغة الأسئلة.',
            'تحليل نواتج التعلم المتوقعة واقتراح توزيع للأسئلة حسب بلوم.'
          ];

          if (ext === 'pdf') {
            suggestions.push('اقتراح تقسيم الملف إلى وحدات تعليمية قبل التحويل إلى بنوك أسئلة.');
            if (fileAiAction) fileAiAction.value = 'convert_db';
          } else {
            suggestions.push('اقتراح تنظيف المحتوى النصي أولًا ثم توليد نسخة واجب مختصرة.');
            if (fileAiAction) fileAiAction.value = 'similar_exam';
          }

          if (sizeKb > 2048) {
            suggestions.push('الملف كبير نسبيًا: يوصى باستراتيجية هجينة (استخراج + توليد) للحصول على أفضل نتائج.');
            if (fileAiAction) fileAiAction.value = 'mix_strategy';
          } else {
            suggestions.push('الملف متوسط الحجم: مناسب لتوليد اختبار فوري ونسخة واجب في نفس الدورة.');
          }

          fileAiStatus.textContent = 'اكتمل التحليل عبر ' + provider + '. اختر طريقة المعالجة الأنسب:';

          var html = '';
          for (var i = 0; i < suggestions.length; i++) {
            html += '<li>' + suggestions[i] + '</li>';
          }
          fileAiList.innerHTML = html;
        }, 900);
      }

      function getSourceProcessingLabel(sourceKey) {
        if (sourceKey === 'up') {
          if (!uploadedFile) return 'لم يتم رفع ملف بعد';
          var actionMap = {
            convert_db: 'تحويل المحتوى إلى قاعدة الأسئلة',
            similar_exam: 'توليد اختبار مشابه لنفس المستوى',
            extract_outcomes: 'استخراج نواتج التعلم وبناء مخطط اختبار',
            homework_variant: 'إنشاء نسخة واجب مختصرة من نفس الملف',
            mix_strategy: 'استراتيجية هجينة (استخراج + توليد)'
          };
          return actionMap[(fileAiAction && fileAiAction.value) || ''] || 'غير محدد';
        }

        if (sourceKey === 'ai') return 'توليد نص مع هيكلة أسئلة AI';

        var focusMap = {
          concepts: 'اختبار مباشر للمفاهيم الأساسية',
          application: 'اختبار مباشر للتطبيق العملي',
          mixed: 'اختبار مباشر مختلط (مفاهيم + تطبيق)'
        };
        if (sourceKey === 'nt') {
          if (noTextFocusInput && noTextFocusInput.value) {
            return focusMap[noTextFocusInput.value] || 'اختبار بدون نص';
          }
          return 'اختبار بدون نص (توليد AI مباشر)';
        }

        return 'غير محدد';
      }

      function buildScheduledAtIso() {
        if (!scheduleDateInput || !scheduleTimeInput) return '';
        var datePart = scheduleDateInput.value;
        var timePart = scheduleTimeInput.value;
        if (!datePart || !timePart) return '';
        var localDate = new Date(datePart + 'T' + timePart + ':00');
        if (isNaN(localDate.getTime())) return '';
        return localDate.toISOString();
      }

      function getKindText(kind) {
        return kind === 'assignment' ? 'واجب' : 'اختبار';
      }

      function detectSchedulingConflicts(exams, scheduledAtIso, durationMinutes) {
        var conflicts = [];
        if (!scheduledAtIso) return conflicts;

        var startTs = Date.parse(scheduledAtIso);
        if (isNaN(startTs)) return conflicts;
        var endTs = startTs + (durationMinutes * 60000);
        var closeWindowMs = scheduleBufferMinutes * 60000;

        for (var i = 0; i < exams.length; i++) {
          var exam = exams[i];
          if (!exam || exam.deletedAt || !exam.scheduledAt) continue;

          var examStart = Date.parse(exam.scheduledAt);
          if (isNaN(examStart)) continue;
          var examDuration = normalizeDurationMinutes(exam.durationMinutes);
          var examEnd = examStart + (examDuration * 60000);

          var overlap = (startTs < examEnd) && (endTs > examStart);
          var gapMs = 0;

          if (!overlap) {
            if (endTs <= examStart) gapMs = examStart - endTs;
            else if (examEnd <= startTs) gapMs = startTs - examEnd;
          }

          var close = !overlap && gapMs > 0 && gapMs <= closeWindowMs;
          if (!overlap && !close) continue;

          conflicts.push({
            type: overlap ? 'overlap' : 'close',
            exam: exam,
            gapMinutes: Math.max(1, Math.round(gapMs / 60000))
          });
        }

        return conflicts;
      }

      function confirmSchedulingIfNeeded(scope, scheduledAtIso, durationMinutes) {
        if (!scheduledAtIso) return true;

        var examsKey = 'mitests-teacher-exams:' + scope;
        var exams = readStoredArray(examsKey);
        var conflicts = detectSchedulingConflicts(exams, scheduledAtIso, durationMinutes);
        if (!conflicts.length) return true;

        showToast('تنبيه جدولة: توجد مواعيد متداخلة/قريبة. راجع التقويم بعد الإنشاء.');
        return true;
      }

      function loadSeedQuestions() {
        try {
          var raw = localStorage.getItem('mitests-selected-questions');
          if (!raw) return [];
          var parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) return parsed;
        } catch (e) {}
        return [];
      }

      function renderSeedQuestions() {
        if (!seedBox || !seedCount || !seedList) return;
        var items = loadSeedQuestions();
        if (!items.length) {
          seedBox.classList.add('hidden');
          return;
        }

        seedBox.classList.remove('hidden');
        seedCount.textContent = 'تم استلام ' + items.length + ' سؤال من بنك الأسئلة. يمكنك المتابعة مباشرة أو تعديل الإعدادات.';

        seedList.innerHTML = '';
        var limit = Math.min(items.length, 5);
        for (var i = 0; i < limit; i++) {
          var li = document.createElement('li');
          li.textContent = (items[i].title || 'سؤال') + (items[i].subject ? ' (' + items[i].subject + ')' : '');
          seedList.appendChild(li);
        }

        if (items.length > limit) {
          var more = document.createElement('li');
          more.textContent = '... +' + (items.length - limit) + ' أسئلة إضافية';
          seedList.appendChild(more);
        }
      }

      function getKindLabel() {
        var kind = kindSelect ? kindSelect.value : '';
        if (kind === 'assignment') return 'واجب';
        if (kind === 'exam') return 'اختبار';
        return 'غير مختار';
      }

      function toggleScheduleFieldsByKind() {
        var isExam = !!(kindSelect && kindSelect.value === 'exam');
        if (scheduleDateInput) {
          scheduleDateInput.disabled = !isExam;
          if (!isExam) scheduleDateInput.closest('.field').classList.remove('error');
        }
        if (scheduleTimeInput) {
          scheduleTimeInput.disabled = !isExam;
          if (!isExam) scheduleTimeInput.closest('.field').classList.remove('error');
        }
      }

      function getModeLabel() {
        return wizardMode === 'advanced' ? 'إنشاء متقدم' : 'إنشاء سريع';
      }

      function getPresetLabel(presetKey) {
        var key = String(presetKey || '');
        if (key === 'quick_quiz') return 'اختبار سريع';
        if (key === 'homework') return 'واجب منزلي';
        if (key === 'challenge') return 'تحدي متقدم';
        return 'اختبار قياسي';
      }

      function getStepFlow() {
        return wizardMode === 'advanced' ? [1, 2, 3, 4] : [1, 2, 4];
      }

      function indexInFlow(flow, stepNumber) {
        for (var i = 0; i < flow.length; i++) {
          if (flow[i] === stepNumber) return i;
        }
        return -1;
      }

      function getActiveSourceKey() {
        var sourceNode = document.querySelector('.src.on');
        return sourceNode ? sourceNode.dataset.src : '';
      }

      function getSourceLabel(sourceKey) {
        var srcMap = { up: 'رفع ملف', ai: 'توليد نص AI', nt: 'اختبار بدون نص (AI)', manual: 'إدخال يدوي' };
        return srcMap[sourceKey] || 'غير مختار';
      }

      function setAutosaveStatus(text) {
        if (autosaveStatus) autosaveStatus.textContent = text;
      }

      function getTimeLabel() {
        var now = new Date();
        var h = String(now.getHours()); if (h.length < 2) h = '0' + h;
        var m = String(now.getMinutes()); if (m.length < 2) m = '0' + m;
        return h + ':' + m;
      }

      function saveAutosaveSnapshot(statusText) {
        var skills = [];
        var skillNodes = document.querySelectorAll('.tag.on');
        for (var i = 0; i < skillNodes.length; i++) skills.push(skillNodes[i].dataset.skill);

        var qTypes = [];
        var qTypeNodes = document.querySelectorAll('input[name="qt"]:checked');
        for (var j = 0; j < qTypeNodes.length; j++) qTypes.push(qTypeNodes[j].value);

        try {
          localStorage.setItem(autosaveKey, JSON.stringify({
            mode: wizardMode,
            preset: selectedPreset,
            title: val('et'),
            kind: kindSelect ? kindSelect.value : '',
            grade: gradeSelect ? gradeSelect.value : '',
            subject: subjectSelect ? subjectSelect.value : '',
            qCount: questionCountInput ? questionCountInput.value : '',
            difficulty: difficultySelect ? difficultySelect.value : '',
            duration: durationInput ? durationInput.value : '',
            scheduleDate: scheduleDateInput ? scheduleDateInput.value : '',
            scheduleTime: scheduleTimeInput ? scheduleTimeInput.value : '',
            sourceType: getActiveSourceKey(),
            aiTopic: aiTopicInput ? aiTopicInput.value.trim() : '',
            noTextGoal: noTextGoalInput ? noTextGoalInput.value.trim() : '',
            noTextFocus: noTextFocusInput ? noTextFocusInput.value : '',
            noTextExtra: noTextExtraInput ? noTextExtraInput.value.trim() : '',
            teacherPrompt: val('tr'),
            bloom: !!document.getElementById('sw').checked,
            skills: skills,
            qTypes: qTypes,
            updatedAt: new Date().toISOString()
          }));
          setAutosaveStatus(statusText || ('تم حفظ تلقائيًا عند ' + getTimeLabel()));
        } catch (e) {}
      }

      function applyTagSelection(skills) {
        var nodes = document.querySelectorAll('.tag');
        for (var i = 0; i < nodes.length; i++) {
          var key = nodes[i].dataset.skill;
          nodes[i].classList.toggle('on', skills.indexOf(key) !== -1);
        }
      }

      function applyQuestionTypeSelection(types) {
        var nodes = document.querySelectorAll('input[name="qt"]');
        for (var i = 0; i < nodes.length; i++) {
          nodes[i].checked = types.indexOf(nodes[i].value) !== -1;
        }
      }

      function setModeHelpText() {
        if (!modeHelp) return;
        modeHelp.textContent = wizardMode === 'advanced'
          ? 'الوضع المتقدم يعرض كل خيارات الهيكلة الدقيقة للأسئلة والتوليد.'
          : 'الوضع السريع يقلل الحقول الإلزامية ويستخدم إعدادات ذكية جاهزة.';
      }

      function setAiStepNoteText() {
        if (!aiStepNote) return;
        aiStepNote.textContent = wizardMode === 'advanced'
          ? 'عدّل أنواع الأسئلة وطلب المعلم بالتفصيل قبل التوليد.'
          : 'في الوضع السريع يمكنك تجاوز هذه الخطوة، وسيتم الاعتماد على القالب الذي اخترته.';
      }

      function applyPresetButton(button, skipAutosave) {
        if (!button) return;
        selectedPreset = button.dataset.preset || 'standard';

        for (var i = 0; i < presetButtons.length; i++) {
          presetButtons[i].classList.toggle('on', presetButtons[i] === button);
        }

        if (questionCountInput && button.dataset.q) questionCountInput.value = button.dataset.q;
        if (difficultySelect && button.dataset.difficulty) difficultySelect.value = button.dataset.difficulty;
        if (durationInput && button.dataset.duration) durationInput.value = button.dataset.duration;

        var typeList = String(button.dataset.types || '').split(',');
        var cleaned = [];
        for (var t = 0; t < typeList.length; t++) {
          var item = String(typeList[t] || '').trim();
          if (item) cleaned.push(item);
        }
        if (cleaned.length) applyQuestionTypeSelection(cleaned);

        updateLiveSummary();
        if (currentStep === 4) updateSummary();
        if (!skipAutosave) saveAutosaveSnapshot('تم تحديث القالب عند ' + getTimeLabel());
      }

      function applyPresetByKey(presetKey, skipAutofill, skipAutosave) {
        var target = null;
        for (var i = 0; i < presetButtons.length; i++) {
          if (presetButtons[i].dataset.preset === presetKey) {
            target = presetButtons[i];
            break;
          }
        }
        if (!target && presetButtons.length) target = presetButtons[0];
        if (!target) return;

        if (skipAutofill) {
          selectedPreset = target.dataset.preset || 'standard';
          for (var j = 0; j < presetButtons.length; j++) {
            presetButtons[j].classList.toggle('on', presetButtons[j] === target);
          }
          updateLiveSummary();
          return;
        }

        applyPresetButton(target, skipAutosave);
      }

      function activateSource(sourceKey) {
        var sourceNodes = document.querySelectorAll('.src');
        var srcPanels = document.querySelectorAll('.srcp');

        for (var i = 0; i < sourceNodes.length; i++) {
          var node = sourceNodes[i];
          node.classList.toggle('on', node.dataset.src === sourceKey);
        }

        for (var j = 0; j < srcPanels.length; j++) {
          srcPanels[j].classList.toggle('on', srcPanels[j].dataset.srcp === sourceKey);
        }

        if (dropZone) dropZone.classList.remove('drop-error');
        if (sourceKey === 'up' && uploadedFile && fileAiPanel) fileAiPanel.classList.remove('hidden');
        if (sourceKey !== 'up' && fileAiPanel) fileAiPanel.classList.add('hidden');
      }

      function setWizardMode(mode, skipAutosave) {
        wizardMode = (mode === 'advanced') ? 'advanced' : 'quick';
        if (wizardRoot) wizardRoot.setAttribute('data-mode', wizardMode);

        for (var i = 0; i < modeButtons.length; i++) {
          modeButtons[i].classList.toggle('on', modeButtons[i].dataset.mode === wizardMode);
        }

        if (wizardMode === 'advanced') {
          if (generalAdvanced) generalAdvanced.open = true;
          if (aiAdvanced) aiAdvanced.open = true;
        } else {
          if (generalAdvanced) generalAdvanced.open = false;
          if (aiAdvanced) aiAdvanced.open = false;
        }

        setModeHelpText();
        setAiStepNoteText();

        var flow = getStepFlow();
        if (indexInFlow(flow, currentStep) === -1) {
          currentStep = flow[Math.max(0, flow.length - 2)];
        }

        if (!skipAutosave) saveAutosaveSnapshot('تم تحديث النمط عند ' + getTimeLabel());
        updateStepper();
      }

      function updateLiveSummary() {
        var sourceKey = getActiveSourceKey();
        var qCount = val('eq') || '10';
        var duration = val('edr') || '45';
        var title = val('et') || 'غير محدد';
        var gradeSubject = (gradeSelect.value || '—') + ' / ' + (subjectSelect.value || '—');

        if (liveMode) liveMode.textContent = getModeLabel();
        if (livePreset) livePreset.textContent = getPresetLabel(selectedPreset);
        if (liveKind) liveKind.textContent = getKindLabel();
        if (liveTitle) liveTitle.textContent = title;
        if (liveGradeSubject) liveGradeSubject.textContent = gradeSubject;
        if (liveSource) liveSource.textContent = getSourceLabel(sourceKey);
        if (liveEstimate) {
          liveEstimate.textContent = 'ناتج متوقع: ' + qCount + ' سؤال خلال ' + duration + ' دقيقة.';
        }
      }

      function restoreAutosaveSnapshot() {
        var state = null;
        try {
          var raw = localStorage.getItem(autosaveKey);
          if (raw) state = JSON.parse(raw);
        } catch (e) {}
        if (!state || typeof state !== 'object') return;

        if (val('et') || gradeSelect.value || subjectSelect.value) return;

        if (state.title) document.getElementById('et').value = state.title;
        if (state.kind && kindSelect) kindSelect.value = state.kind;
        if (state.grade && gradeSelect) gradeSelect.value = state.grade;
        if (state.subject && subjectSelect) subjectSelect.value = state.subject;
        if (state.qCount && questionCountInput) questionCountInput.value = state.qCount;
        if (state.difficulty && difficultySelect) difficultySelect.value = state.difficulty;
        if (state.duration && durationInput) durationInput.value = state.duration;
        if (state.scheduleDate && scheduleDateInput) scheduleDateInput.value = state.scheduleDate;
        if (state.scheduleTime && scheduleTimeInput) scheduleTimeInput.value = state.scheduleTime;
        if (state.aiTopic && aiTopicInput) aiTopicInput.value = state.aiTopic;
        if (state.noTextGoal && noTextGoalInput) noTextGoalInput.value = state.noTextGoal;
        if (state.noTextFocus && noTextFocusInput) noTextFocusInput.value = state.noTextFocus;
        if (state.noTextExtra && noTextExtraInput) noTextExtraInput.value = state.noTextExtra;
        if (typeof state.teacherPrompt === 'string') document.getElementById('tr').value = state.teacherPrompt;
        if (state.bloom) document.getElementById('sw').checked = true;
        if (Array.isArray(state.skills)) applyTagSelection(state.skills);
        if (Array.isArray(state.qTypes) && state.qTypes.length) applyQuestionTypeSelection(state.qTypes);
        if (state.sourceType) activateSource(state.sourceType);
        if (state.mode) setWizardMode(state.mode, true);
        if (state.preset) applyPresetByKey(state.preset, true, true);

        setAutosaveStatus('تم استرجاع آخر إعدادات محفوظة');
      }

      function updateGenerateButtonText() {
        var kind = kindSelect ? kindSelect.value : '';
        var isAssignment = kind === 'assignment';

        genBtn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> ' + (isAssignment ? 'إنشاء الواجب بالذكاء الاصطناعي' : 'إنشاء الاختبار بالذكاء الاصطناعي');

        var overlayText = document.querySelector('#ov .box p');
        if (overlayText) {
          overlayText.textContent = isAssignment
            ? 'يتم الآن إنشاء الواجب باستخدام الذكاء الاصطناعي'
            : 'يتم الآن إنشاء الاختبار باستخدام الذكاء الاصطناعي';
        }
      }

      function updateStepper() {
        var flow = getStepFlow();
        var currentIndex = indexInFlow(flow, currentStep);
        if (currentIndex === -1) {
          currentStep = flow[0];
          currentIndex = 0;
        }

        for (var i = 0; i < wizardPanels.length; i++) {
          wizardPanels[i].classList.toggle('active', Number(wizardPanels[i].dataset.sp) === currentStep);
        }

        for (var j = 0; j < steps.length; j++) {
          var stepNumber = Number(steps[j].dataset.si);
          var stepFlowIndex = indexInFlow(flow, stepNumber);

          steps[j].classList.remove('active', 'done', 'step--hidden');
          if (stepFlowIndex === -1) {
            steps[j].classList.add('step--hidden');
            continue;
          }
          if (stepFlowIndex < currentIndex) steps[j].classList.add('done');
          if (stepFlowIndex === currentIndex) steps[j].classList.add('active');
        }

        var denominator = Math.max(1, flow.length - 1);
        var progress = (currentIndex / denominator) * 100;
        fill.style.width = progress + '%';
        backBtn.disabled = currentIndex === 0;

        var atLastStep = currentIndex === (flow.length - 1);
        nextBtn.classList.toggle('hidden', atLastStep);
        genBtn.classList.toggle('hidden', !atLastStep);
        draftBtn.classList.toggle('hidden', !atLastStep);

        if (currentStep === 4) updateSummary();
        updateGenerateButtonText();
        updateLiveSummary();
      }

      function val(id) {
        return document.getElementById(id).value.trim();
      }

      function updateSummary() {
        var skills = [];
        var skillNodes = document.querySelectorAll('.tag.on');
        for (var i = 0; i < skillNodes.length; i++) skills.push(skillNodes[i].dataset.skill);

        var qTypes = [];
        var qTypeNodes = document.querySelectorAll('input[name="qt"]:checked');
        for (var j = 0; j < qTypeNodes.length; j++) qTypes.push(qTypeNodes[j].value);

        var sourceKey = getActiveSourceKey();

        document.getElementById('smode').textContent = getModeLabel();
        document.getElementById('spreset').textContent = getPresetLabel(selectedPreset);
        document.getElementById('stk').textContent = getKindLabel();
        document.getElementById('st').textContent = val('et') || 'غير محدد';
        document.getElementById('sg').textContent = gradeSelect.value || 'غير مختار';
        document.getElementById('ss').textContent = subjectSelect.value || 'غير مختار';
        document.getElementById('sk').textContent = skills.length ? skills.join(', ') : 'غير مختار';
        document.getElementById('sc').textContent = getSourceLabel(sourceKey);
        document.getElementById('sfc').textContent = getSourceProcessingLabel(sourceKey);
        document.getElementById('sq').textContent = qTypes.length ? qTypes.join(', ') : 'غير مختار';
        document.getElementById('swv').textContent = document.getElementById('sw').checked ? 'مفعل' : 'غير مفعل';
        document.getElementById('sr').textContent = val('tr') || 'بدون توجيه';
        document.getElementById('sqc').textContent = val('eq') || 'غير محدد';
        var diffMap = {easy:'سهل',medium:'متوسط',hard:'صعب',mixed:'مختلط'};
        document.getElementById('sdf').textContent = diffMap[val('ed')] || 'غير مختار';
        document.getElementById('sdr').textContent = val('edr') ? val('edr') + ' دقيقة' : 'غير محدد';
        if (kindSelect.value === 'exam') {
          document.getElementById('ssc').textContent = toDisplayDateTime(buildScheduledAtIso());
        } else {
          document.getElementById('ssc').textContent = 'غير مطلوب للواجب';
        }
      }

      function getSelectedQuestionTypes() {
        var nodes = document.querySelectorAll('input[name="qt"]:checked');
        var selected = [];
        for (var i = 0; i < nodes.length; i++) selected.push(nodes[i].value);
        return selected.length ? selected : ['MC'];
      }

      function pickDifficulty(baseDifficulty, index) {
        var base = String(baseDifficulty || '').trim();
        if (!base || base === 'mixed') {
          var mixed = ['easy', 'medium', 'hard'];
          return mixed[index % mixed.length];
        }
        return base;
      }

      function buildGeneratedQuestions(config) {
        var total = Math.max(1, Math.min(50, Number(config.count) || 8));
        var types = config.types && config.types.length ? config.types : ['MC'];
        var subject = config.subject || 'المادة';
        var grade = config.grade || 'الصف';
        var title = config.title || 'الاختبار';
        var teacherPrompt = String(config.teacherPrompt || '').trim();
        var seedItems = loadSeedQuestions();
        var bloomLevels = ['L1 - التذكر', 'L2 - الفهم', 'L3 - التطبيق', 'L4 - التحليل', 'L5 - التقييم'];
        var questions = [];

        for (var i = 0; i < total; i++) {
          var type = types[i % types.length];
          var difficulty = pickDifficulty(config.difficulty, i);
          var seed = seedItems[i] || null;
          var seedHint = seed && (seed.title || seed.text || seed.question) ? (seed.title || seed.text || seed.question) : '';
          var baseText = 'سؤال ' + (i + 1) + ' في ' + subject + ' (' + grade + ')';
          if (seedHint) {
            baseText = 'اعتمادًا على سؤال بنك الأسئلة: "' + seedHint + '"، طوّر نسخة مناسبة بعنوان ' + title + '.';
          } else if (teacherPrompt) {
            baseText = baseText + '. توجيه المعلم: ' + teacherPrompt;
          } else {
            baseText = baseText + '.';
          }

          var q = {
            id: i + 1,
            type: type,
            bloom: bloomLevels[i % bloomLevels.length],
            difficulty: difficulty,
            points: (type === 'Open-end' || type === 'Short Answer') ? 10 : 5,
            text: baseText,
            options: [],
            answer: 'تُراجع الإجابة وفق نموذج التصحيح المعتمد.'
          };

          if (type === 'MC') {
            q.options = [
              { label: 'أ', text: 'الخيار الأول', correct: true },
              { label: 'ب', text: 'الخيار الثاني', correct: false },
              { label: 'ج', text: 'الخيار الثالث', correct: false },
              { label: 'د', text: 'الخيار الرابع', correct: false }
            ];
            q.answer = 'الإجابة الصحيحة: الخيار (أ).';
          } else if (type === 'True/False') {
            q.options = [
              { label: 'صح', text: 'العبارة صحيحة', correct: true },
              { label: 'خطأ', text: 'العبارة خاطئة', correct: false }
            ];
            q.answer = 'الإجابة الصحيحة: صح.';
          } else if (type === 'Matching') {
            q.answer = 'تتم المطابقة حسب المفاهيم الرئيسة في الدرس.';
          } else if (type === 'Completion') {
            q.answer = 'تُستكمل الجملة بالكلمة/المفهوم الصحيح.';
          } else if (type === 'Short Answer') {
            q.answer = 'إجابة قصيرة نموذجية من 2-3 أسطر.';
          } else if (type === 'Open-end') {
            q.answer = 'إجابة تحليلية تعتمد على جودة التبرير واللغة.';
          }

          questions.push(q);
        }

        return questions;
      }

      function validateStep(step) {
        var valid = true;
        document.querySelectorAll('.field.error').forEach(function(f){f.classList.remove('error');});
        if (dropZone) dropZone.classList.remove('drop-error');

        if (step === 1) {
          if (!val('et')) { document.getElementById('et').closest('.field').classList.add('error'); valid = false; }
          if (!kindSelect.value) { kindSelect.closest('.field').classList.add('error'); valid = false; }
          if (!gradeSelect.value) { gradeSelect.closest('.field').classList.add('error'); valid = false; }
          if (!subjectSelect.value) { subjectSelect.closest('.field').classList.add('error'); valid = false; }
          if (kindSelect.value === 'exam') {
            if (!scheduleDateInput.value) { scheduleDateInput.closest('.field').classList.add('error'); valid = false; }
            if (!scheduleTimeInput.value) { scheduleTimeInput.closest('.field').classList.add('error'); valid = false; }
          }
        }

        if (step === 2) {
          var sourceKey = getActiveSourceKey();
          if (!sourceKey) valid = false;
          if (sourceKey === 'up' && !uploadedFile) {
            if (dropZone) dropZone.classList.add('drop-error');
            valid = false;
          }
          if (sourceKey === 'ai' && aiTopicInput && !aiTopicInput.value.trim()) {
            aiTopicInput.closest('.field').classList.add('error');
            valid = false;
          }
          if (sourceKey === 'nt' && noTextGoalInput && !noTextGoalInput.value.trim()) {
            noTextGoalInput.closest('.field').classList.add('error');
            valid = false;
          }
        }

        return valid;
      }

      nextBtn.addEventListener('click', function () {
        if (!validateStep(currentStep)) return;
        var flow = getStepFlow();
        var currentIndex = indexInFlow(flow, currentStep);
        if (currentIndex < flow.length - 1) currentStep = flow[currentIndex + 1];
        saveAutosaveSnapshot('تم حفظ التقدم عند ' + getTimeLabel());
        updateStepper();
      });

      backBtn.addEventListener('click', function () {
        var flow = getStepFlow();
        var currentIndex = indexInFlow(flow, currentStep);
        if (currentIndex > 0) currentStep = flow[currentIndex - 1];
        updateStepper();
      });

      for (var m = 0; m < modeButtons.length; m++) {
        modeButtons[m].addEventListener('click', function () {
          setWizardMode(this.dataset.mode || 'quick', false);
        });
      }

      for (var p = 0; p < presetButtons.length; p++) {
        presetButtons[p].addEventListener('click', function () {
          applyPresetButton(this, false);
        });
      }

      var tags = document.querySelectorAll('.tag');
      for (var t = 0; t < tags.length; t++) {
        tags[t].addEventListener('click', function () {
          this.classList.toggle('on');
          updateLiveSummary();
          if (currentStep === 4) updateSummary();
          saveAutosaveSnapshot('تم تحديث المهارات عند ' + getTimeLabel());
        });
      }

      var sources = document.querySelectorAll('.src');
      for (var s = 0; s < sources.length; s++) {
        sources[s].addEventListener('click', function () {
          var key = this.dataset.src;
          activateSource(key);
          if (currentStep === 4) updateSummary();
          updateLiveSummary();
          saveAutosaveSnapshot('تم تحديث مصدر المحتوى عند ' + getTimeLabel());
        });
      }

      if (kindSelect) {
        kindSelect.addEventListener('change', function () {
          try {
            localStorage.setItem('mitests-create-item-kind', kindSelect.value || 'exam');
          } catch (e) {}
          updateGenerateButtonText();
          toggleScheduleFieldsByKind();
          if (kindSelect.value) {
            kindSelect.closest('.field').classList.remove('error');
          }
          if (kindSelect.value !== 'exam') {
            if (scheduleDateInput) scheduleDateInput.closest('.field').classList.remove('error');
            if (scheduleTimeInput) scheduleTimeInput.closest('.field').classList.remove('error');
          }
          updateLiveSummary();
          if (currentStep === 4) updateSummary();
          saveAutosaveSnapshot('تم تحديث نوع التقييم عند ' + getTimeLabel());
        });
      }

      if (scheduleDateInput) {
        scheduleDateInput.addEventListener('change', function () {
          if (scheduleDateInput.value) scheduleDateInput.closest('.field').classList.remove('error');
          updateLiveSummary();
          if (currentStep === 4) updateSummary();
          saveAutosaveSnapshot('تم تحديث تاريخ الموعد عند ' + getTimeLabel());
        });
      }

      if (scheduleTimeInput) {
        scheduleTimeInput.addEventListener('change', function () {
          if (scheduleTimeInput.value) scheduleTimeInput.closest('.field').classList.remove('error');
          updateLiveSummary();
          if (currentStep === 4) updateSummary();
          saveAutosaveSnapshot('تم تحديث وقت الموعد عند ' + getTimeLabel());
        });
      }

      function bindFieldAuto(id, label) {
        var node = document.getElementById(id);
        if (!node) return;
        var onChange = function () {
          if (node.value && node.closest('.field')) node.closest('.field').classList.remove('error');
          updateLiveSummary();
          if (currentStep === 4) updateSummary();
          saveAutosaveSnapshot('تم تحديث ' + label + ' عند ' + getTimeLabel());
        };
        node.addEventListener('input', onChange);
        node.addEventListener('change', onChange);
      }

      bindFieldAuto('et', 'العنوان');
      bindFieldAuto('eg', 'الصف');
      bindFieldAuto('es', 'المادة');
      bindFieldAuto('eq', 'عدد الأسئلة');
      bindFieldAuto('ed', 'مستوى الصعوبة');
      bindFieldAuto('edr', 'المدة');
      bindFieldAuto('at', 'موضوع النص');
      bindFieldAuto('nt-goal', 'هدف الاختبار');
      bindFieldAuto('nt-focus', 'تركيز الاختبار');
      bindFieldAuto('nt-extra', 'تعليمات بدون نص');
      bindFieldAuto('tr', 'تعليمات الذكاء الاصطناعي');

      if (fileAiAction) {
        fileAiAction.addEventListener('change', function () {
          updateLiveSummary();
          if (currentStep === 4) updateSummary();
          saveAutosaveSnapshot('تم تحديث خطة معالجة الملف عند ' + getTimeLabel());
        });
      }

      var qTypeNodes = document.querySelectorAll('input[name="qt"]');
      for (var qt = 0; qt < qTypeNodes.length; qt++) {
        qTypeNodes[qt].addEventListener('change', function () {
          updateLiveSummary();
          if (currentStep === 4) updateSummary();
          saveAutosaveSnapshot('تم تحديث أنواع الأسئلة عند ' + getTimeLabel());
        });
      }

      var bloomSwitch = document.getElementById('sw');
      if (bloomSwitch) {
        bloomSwitch.addEventListener('change', function () {
          if (currentStep === 4) updateSummary();
          saveAutosaveSnapshot('تم تحديث تصنيف بلوم عند ' + getTimeLabel());
        });
      }

      genBtn.addEventListener('click', function () {
        if (!validateStep(1)) {
          currentStep = 1;
          updateStepper();
          return;
        }
        if (!validateStep(2)) {
          currentStep = 2;
          updateStepper();
          return;
        }

        var itemKind = kindSelect.value || 'exam';
        var itemTitle = val('et') || (itemKind === 'assignment' ? 'واجب جديد' : 'اختبار جديد');
        var durationMinutes = normalizeDurationMinutes(val('edr'));
        var scheduledAtIso = (itemKind === 'exam') ? buildScheduledAtIso() : '';
        var sourceType = getActiveSourceKey();
        var sourcePlan = getSourceProcessingLabel(sourceType);
        var questionTypes = getSelectedQuestionTypes();
        var generatedQuestions = buildGeneratedQuestions({
          count: val('eq'),
          types: questionTypes,
          subject: subjectSelect.value,
          grade: gradeSelect.value,
          title: itemTitle,
          difficulty: val('ed') || 'mixed',
          teacherPrompt: val('tr')
        });
        var examId = 'ex-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        var previewHref = 'exam-preview.html?id=' + encodeURIComponent(examId);
        var scope = '';

        if (itemKind === 'exam' && !scheduledAtIso) {
          showToast('يرجى تحديد تاريخ ووقت الاختبار قبل الإنشاء.');
          currentStep = 1;
          updateStepper();
          return;
        }

        try {
          scope = getCurrentScope();

          if (itemKind === 'exam' && !confirmSchedulingIfNeeded(scope, scheduledAtIso, durationMinutes)) {
            return;
          }

          var examsKey = 'mitests-teacher-exams:' + scope;
          var exams = readStoredArray(examsKey);
          exams.unshift({
            id: examId,
            kind: itemKind,
            title: itemTitle,
            grade: gradeSelect.value || '',
            subject: subjectSelect.value || '',
            durationMinutes: durationMinutes,
            scheduledAt: scheduledAtIso,
            qCount: generatedQuestions.length,
            difficulty: val('ed') || 'mixed',
            questionTypes: questionTypes,
            bloomEnabled: !!document.getElementById('sw').checked,
            teacherPrompt: val('tr'),
            sourceType: sourceType,
            sourcePlan: sourcePlan,
            sourceFileName: uploadedFile ? uploadedFile.name : '',
            wizardMode: wizardMode,
            wizardPreset: selectedPreset,
            noTextGoal: noTextGoalInput ? noTextGoalInput.value.trim() : '',
            noTextFocus: noTextFocusInput ? noTextFocusInput.value : '',
            noTextExtra: noTextExtraInput ? noTextExtraInput.value.trim() : '',
            groupCode: new URLSearchParams(window.location.search).get('group') || '',
            status: 'draft',
            questions: generatedQuestions,
            createdAt: new Date().toISOString()
          });
          localStorage.setItem(examsKey, JSON.stringify(exams));
        } catch (queueError) {}

        if (successPreviewLink) successPreviewLink.setAttribute('href', previewHref);

        overlay.classList.add('on');
        overlay.setAttribute('aria-hidden', 'false');
        setTimeout(function () {
          try { localStorage.removeItem(autosaveKey); } catch (e) {}
          overlay.classList.remove('on');
          overlay.setAttribute('aria-hidden', 'true');
          window.location.href = previewHref;
        }, 2400);
      });

      var goManualBtn = document.getElementById('go-manual-btn');
      if(goManualBtn) {
        goManualBtn.addEventListener('click', function() {
           // Save metadata to localStorage to be picked up by editor
           try {
             var meta = {
               title: val('et'),
               grade: gradeSelect.value,
               subject: subjectSelect.value,
               date: scheduleDateInput.value,
               time: scheduleTimeInput.value
             };
             localStorage.setItem('mitests-manual-exam-init', JSON.stringify(meta));
           } catch(e) {}
           window.location.href = 'exam-editor.html';
        });
      }

      draftBtn.addEventListener('click', function () {
        try {
          var activeSource = getActiveSourceKey();
          localStorage.setItem('mitests-exam-draft', JSON.stringify({
            mode: wizardMode,
            preset: selectedPreset,
            kind: kindSelect.value,
            title: val('et'),
            grade: gradeSelect.value,
            subject: subjectSelect.value,
            qCount: val('eq'),
            diff: val('ed'),
            dur: val('edr'),
            sourceType: activeSource,
            sourcePlan: getSourceProcessingLabel(activeSource),
            noTextGoal: noTextGoalInput ? noTextGoalInput.value.trim() : '',
            noTextFocus: noTextFocusInput ? noTextFocusInput.value : '',
            noTextExtra: noTextExtraInput ? noTextExtraInput.value.trim() : '',
            scheduleDate: scheduleDateInput ? scheduleDateInput.value : '',
            scheduleTime: scheduleTimeInput ? scheduleTimeInput.value : ''
          }));
        } catch(e){}
        saveAutosaveSnapshot('تم حفظ المسودة عند ' + getTimeLabel());
        showToast('تم حفظ المسودة بنجاح.');
      });

      /* File upload */
      if (dropZone && fileInput) {
        dropZone.addEventListener('click', function(){ dropZone.classList.remove('drop-error'); fileInput.click(); });
        dropZone.addEventListener('dragover', function(e){ e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', function(){ dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', function(e){ e.preventDefault(); dropZone.classList.remove('drag-over'); if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', function(){ if(fileInput.files.length) handleFile(fileInput.files[0]); });
      }
      function handleFile(file) {
        uploadedFile = file;
        if (dropZone) dropZone.classList.remove('drop-error');
        filePreview.classList.remove('hidden');
        filePreview.innerHTML = '<i class="fas fa-file-pdf"></i><span class="file-name">' + file.name + ' (' + (file.size/1024).toFixed(0) + ' KB)</span><button type="button" class="file-remove" title="حذف"><i class="fas fa-xmark"></i></button>';
        runFileAiAnalysis(file);
        updateLiveSummary();
        if (currentStep === 4) updateSummary();
        saveAutosaveSnapshot('تم حفظ الملف المصدر عند ' + getTimeLabel());
        filePreview.querySelector('.file-remove').addEventListener('click', function(){
          uploadedFile = null;
          filePreview.classList.add('hidden');
          filePreview.innerHTML = '';
          fileInput.value = '';
          resetFileAiPanel();
          updateLiveSummary();
          saveAutosaveSnapshot('تم حذف الملف المصدر عند ' + getTimeLabel());
          if (currentStep === 4) updateSummary();
        });
      }

      if (clearSeedBtn) {
        clearSeedBtn.addEventListener('click', function () {
          try {
            localStorage.removeItem('mitests-selected-questions');
          } catch (e) {}
          renderSeedQuestions();
        });
      }

      hydrateCatalogs();
      hydrateInitialKind();
      resetFileAiPanel();
      renderSeedQuestions();
      activateSource(getActiveSourceKey() || 'up');
      applyPresetByKey('standard', false, true);
      restoreAutosaveSnapshot();
      toggleScheduleFieldsByKind();
      setWizardMode(wizardMode, true);
      updateGenerateButtonText();
      updateLiveSummary();
      updateStepper();
    })();
  </script>
</body>
</html>
