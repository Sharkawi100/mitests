<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mitests - معالج إنشاء الاختبار</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <style>
    .teacher-navbar{border-bottom:1px solid var(--color-gray-200)}body.rtl .main-content .teacher-navbar{right:var(--sidebar-width);left:0}body.ltr .main-content .teacher-navbar{left:var(--sidebar-width);right:0}body.rtl .main-content.main-content--expanded .teacher-navbar{right:var(--sidebar-collapsed-width)}body.ltr .main-content.main-content--expanded .teacher-navbar{left:var(--sidebar-collapsed-width)}.teacher-navbar .navbar__brand-icon{background:linear-gradient(135deg,var(--color-teacher),var(--color-primary-400))}.sidebar__item:hover,.sidebar__item--active{background:rgba(53,86,178,.25);color:var(--color-white)}.sidebar__item--active{border-inline-start:3px solid var(--color-teacher)}.btn--teacher{background:var(--color-teacher);border-color:var(--color-teacher);color:var(--color-white)}.btn--teacher:hover{background:var(--color-primary-600);border-color:var(--color-primary-600);color:var(--color-white)}
    .wizard-main{padding:calc(var(--navbar-height) + var(--space-5)) var(--space-6) var(--space-8);max-width:1050px;display:grid;gap:var(--space-4)}body.rtl .wizard-main{margin-left:auto}body.ltr .wizard-main{margin-right:auto}.page-head,.wizard{background:var(--color-white);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-md)}.page-head{padding:var(--space-5);border-top:4px solid var(--color-teacher)}.page-head h1{font-size:var(--font-size-2xl);margin-bottom:var(--space-2)}
    .wizard{padding:var(--space-5)}.bar{height:8px;background:var(--color-primary-100);border-radius:999px;overflow:hidden}.bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--color-teacher),var(--color-primary-400));transition:width .2s}.steps{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--space-2);margin:var(--space-3) 0 var(--space-4)}.step{display:flex;align-items:center;gap:var(--space-2);font-size:var(--font-size-sm);color:var(--color-gray-500);font-weight:600}.step b{width:28px;height:28px;border:2px solid var(--color-gray-300);border-radius:50%;display:inline-flex;align-items:center;justify-content:center}.step.active,.step.done{color:var(--color-teacher)}.step.active b{background:var(--color-teacher);border-color:var(--color-teacher);color:var(--color-white)}.step.done b{border-color:var(--color-teacher)}
    .panel{display:none;gap:var(--space-4)}.panel.active{display:grid}.grid2{display:grid;grid-template-columns:1fr 1fr;gap:var(--space-3)}.field{display:grid;gap:var(--space-1)}.field.full{grid-column:1/-1}.field input,.field select,.field textarea{border:1px solid var(--color-gray-300);border-radius:var(--border-radius-sm);padding:var(--space-3);font-family:inherit}.field textarea{min-height:120px;resize:vertical}.field input:focus,.field select:focus,.field textarea:focus{outline:0;border-color:var(--color-teacher);box-shadow:0 0 0 3px rgba(53,86,178,.15)}
    .tags{display:flex;flex-wrap:wrap;gap:var(--space-2)}.tag{border:1px solid var(--color-primary-300);background:var(--color-primary-100);padding:var(--space-1) var(--space-3);border-radius:999px;cursor:pointer}.tag.on{background:var(--color-teacher);border-color:var(--color-teacher);color:var(--color-white)}.srcs{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--space-3)}.src{border:2px solid var(--color-gray-200);border-radius:var(--border-radius-md);padding:var(--space-4);cursor:pointer}.src.on{border-color:var(--color-teacher);background:rgba(53,86,178,.06)}.src i{color:var(--color-teacher);font-size:1.3rem}.srcp{display:none}.srcp.on{display:block}.drop,.editor{border:2px dashed var(--color-primary-300);border-radius:var(--border-radius-md);padding:var(--space-6);text-align:center;color:var(--color-gray-600)}.editor{border-style:solid;min-height:170px}
    .checks{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--space-2)}.checks label{border:1px solid var(--color-gray-200);padding:var(--space-2);border-radius:var(--border-radius-sm);display:flex;gap:var(--space-2);align-items:center}.checks input,.switch input{accent-color:var(--color-teacher)}.toggle{display:flex;align-items:center;justify-content:space-between;padding:var(--space-3);background:var(--color-primary-100);border:1px solid var(--color-primary-300);border-radius:var(--border-radius-md)}
    .summary{border:1px solid var(--color-gray-200);border-radius:var(--border-radius-md);overflow:hidden}.row{display:grid;grid-template-columns:180px 1fr;padding:var(--space-2) var(--space-3);border-bottom:1px solid var(--color-gray-100)}.row:last-child{border-bottom:0}.row dt{color:var(--color-gray-500);font-weight:600}.row dd{margin:0}.actions{display:flex;justify-content:space-between;gap:var(--space-3);margin-top:var(--space-2)}.end{display:flex;gap:var(--space-2)}.gen{background:linear-gradient(135deg,var(--color-teacher),#4c6fd2);border-color:var(--color-teacher);color:var(--color-white);box-shadow:0 0 0 rgba(76,111,210,.45);animation:glow 2s infinite}.gen:hover{background:linear-gradient(135deg,var(--color-primary-600),var(--color-primary-500));color:var(--color-white)}@keyframes glow{70%{box-shadow:0 0 0 14px rgba(76,111,210,0)}}
    .ov{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:900}.ov.on{display:flex}.box{background:var(--color-white);border-radius:var(--border-radius-lg);padding:var(--space-6);text-align:center;min-width:270px}.spin{width:48px;height:48px;margin:0 auto var(--space-3);border:4px solid var(--color-primary-200);border-top-color:var(--color-teacher);border-radius:50%;animation:sp .9s linear infinite}@keyframes sp{to{transform:rotate(360deg)}}
    @media (max-width:1023px){body.rtl .main-content .teacher-navbar{right:var(--sidebar-collapsed-width)}body.ltr .main-content .teacher-navbar{left:var(--sidebar-collapsed-width)}body.rtl .main-content{margin-right:var(--sidebar-collapsed-width)}body.ltr .main-content{margin-left:var(--sidebar-collapsed-width)}.sidebar{width:var(--sidebar-collapsed-width)}.sidebar .sidebar__brand-text,.sidebar .sidebar__item span,.sidebar .sidebar__toggle span{display:none}.grid2,.srcs,.checks{grid-template-columns:1fr}.steps{grid-template-columns:repeat(2,1fr)}}@media (max-width:767px){.sidebar{display:none}body.rtl .main-content,body.ltr .main-content{margin:0}body.rtl .main-content .teacher-navbar,body.ltr .main-content .teacher-navbar{right:0;left:0}.wizard-main{padding-inline:var(--space-4)}.actions,.end{flex-direction:column}.actions .btn,.end .btn{width:100%}}
    .breadcrumb{font-size:var(--font-size-sm);color:var(--color-gray-500);display:flex;align-items:center;gap:var(--space-2)}.breadcrumb a{color:var(--color-teacher);text-decoration:none}.breadcrumb a:hover{text-decoration:underline}
    .file-preview{display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3);background:var(--color-primary-100);border:1px solid var(--color-primary-300);border-radius:var(--border-radius-sm);margin-top:var(--space-2)}.file-preview i{color:var(--color-teacher);font-size:1.2rem}.file-preview .file-name{flex:1;font-size:var(--font-size-sm);font-weight:600;color:var(--color-gray-800)}.file-preview .file-remove{background:none;border:none;color:var(--color-admin);cursor:pointer;font-size:var(--font-size-lg);padding:var(--space-1)}
    .drop.drag-over{border-color:var(--color-teacher);background:rgba(53,86,178,.08)}.drop{cursor:pointer}
    .field.error input,.field.error select,.field.error textarea{border-color:var(--color-admin);box-shadow:0 0 0 3px rgba(239,93,96,.12)}.field .error-msg{color:var(--color-admin);font-size:var(--font-size-xs);margin-top:2px;display:none}.field.error .error-msg{display:block}
    .success-box{min-width:320px}.success-icon{font-size:3rem;color:#16a34a;margin-bottom:var(--space-3)}.success-actions{display:flex;gap:var(--space-2);margin-top:var(--space-4);justify-content:center}
  </style>
</head>
<body class="rtl">
  <aside class="sidebar" id="sidebar" aria-label="Sidebar navigation">
    <div class="sidebar__header"><div class="sidebar__logo">M</div><span class="sidebar__brand-text">سراج - المعلم</span></div>
    <nav class="sidebar__nav">
      <a class="sidebar__item" href="teacher-dashboard.html"><i class="fas fa-gauge"></i><span>نظرة عامة</span></a>
      <a class="sidebar__item sidebar__item--active" href="exam-wizard.html"><i class="fas fa-file-lines"></i><span>إنشاء اختبار</span></a>
      <a class="sidebar__item" href="teacher-tasks.html"><i class="fas fa-list-check"></i><span>مهام المعلم</span></a>
      <a class="sidebar__item" href="teacher-group.html"><i class="fas fa-users"></i><span>المجموعات</span></a>
      <a class="sidebar__item" href="teacher-question-bank.html"><i class="fas fa-database"></i><span>بنك الأسئلة</span></a>
      <a class="sidebar__item" href="teacher-community.html"><i class="fas fa-comments"></i><span>المجتمع</span></a>
      <a class="sidebar__item" href="teacher-settings.html"><i class="fas fa-gear"></i><span>الإعدادات</span></a>
    </nav>
    <button class="sidebar__toggle" id="sidebar-toggle" aria-label="Toggle sidebar"><i class="fas fa-angles-right"></i><span>تصغير</span></button>
  </aside>
  <div class="main-content" id="main-content">
    <nav class="navbar teacher-navbar" role="navigation" aria-label="Teacher top navigation">
      <a href="teacher-dashboard.html" class="navbar__brand"><div class="navbar__brand-icon"><i class="fas fa-wand-magic-sparkles"></i></div><span class="navbar__brand-text">معالج الاختبار</span></a>
      <div class="navbar__actions">
        <div class="lang-switcher" role="group" aria-label="Language selector">
          <button class="lang-switcher__btn active" data-lang="ar" aria-label="Arabic">&#1593;</button><button class="lang-switcher__btn" data-lang="he" aria-label="Hebrew">&#1506;&#1489;</button><button class="lang-switcher__btn" data-lang="en" aria-label="English">En</button>
        </div>
        <div class="avatar-dropdown">
          <button class="avatar-btn" type="button" data-avatar-toggle="teacher-avatar-menu" aria-label="قائمة حساب المعلم"><i class="fas fa-user"></i></button>
          <div class="avatar-menu" id="teacher-avatar-menu" data-avatar-menu>
            <span class="avatar-menu__label">حساب المعلم</span>
            <a class="avatar-menu__link" href="teacher-profile.html"><i class="fas fa-id-card"></i><span>الملف الشخصي</span></a>
            <a class="avatar-menu__link" href="teacher-settings.html"><i class="fas fa-gear"></i><span>الإعدادات</span></a>
          </div>
        </div>
        <a href="index.html" class="btn btn--teacher btn--sm"><i class="fas fa-right-from-bracket"></i><span>تسجيل الخروج</span></a>
      </div>
    </nav>
    <main class="wizard-main">
      <nav class="breadcrumb" aria-label="Breadcrumb"><a href="teacher-dashboard.html">لوحة المعلم</a> <span>›</span> <span>معالج الاختبار</span></nav>
      <header class="page-head"><h1 data-i18n="wizardTitle">معالج إنشاء الاختبار بالذكاء الاصطناعي</h1><p data-i18n="wizardSub">تدفق موجه من 4 خطوات لبناء اختبار كامل.</p></header>
      <section id="bank-seed" class="card hidden">
        <h2>أسئلة مضافة من بنك الأسئلة</h2>
        <p id="bank-seed-count" class="helper-text"></p>
        <ul id="bank-seed-list"></ul>
        <div>
          <button type="button" id="bank-seed-clear" class="btn btn--outline btn--sm">مسح القائمة</button>
        </div>
      </section>
      <section class="wizard">
        <div class="bar"><span id="pfill"></span></div>
        <div class="steps">
          <div class="step active" data-si="1"><b>1</b><span>معلومات عامة</span></div>
          <div class="step" data-si="2"><b>2</b><span>مصدر المحتوى</span></div>
          <div class="step" data-si="3"><b>3</b><span>هيكلة AI</span></div>
          <div class="step" data-si="4"><b>4</b><span>مراجعة وإنشاء</span></div>
        </div>

        <section class="panel active" data-sp="1">
          <h2>معلومات عامة</h2>
          <div class="grid2">
            <div class="field full"><label for="et">عنوان الاختبار</label><input id="et" placeholder="مثال: اختبار اللغة الإنجليزية للصف التاسع"></div>
            <div class="field"><label for="ek">نوع التقييم</label><select id="ek"><option value="">اختر النوع</option><option value="exam">اختبار</option><option value="assignment">واجب</option></select></div>
            <div class="field"><label for="eg">الصف</label><select id="eg"><option value="">اختر الصف</option></select></div>
            <div class="field"><label for="es">المادة</label><select id="es"><option value="">اختر المادة</option></select></div>
            <div class="field full">
              <label>المهارات (اختيار متعدد)</label>
              <div class="tags" id="skills">
                <button type="button" class="tag" data-skill="القراءة الناقدة">القراءة الناقدة</button>
                <button type="button" class="tag" data-skill="حل المشكلات">حل المشكلات</button>
                <button type="button" class="tag" data-skill="تفكير تحليلي">تفكير تحليلي</button>
                <button type="button" class="tag" data-skill="استخلاص النتائج">استخلاص النتائج</button>
              </div>
            </div>
            <div class="field"><label for="eq">عدد الأسئلة</label><input id="eq" type="number" min="1" max="50" placeholder="مثال: 15"></div>
            <div class="field"><label for="ed">مستوى الصعوبة</label><select id="ed"><option value="">اختر المستوى</option><option value="easy">سهل</option><option value="medium">متوسط</option><option value="hard">صعب</option><option value="mixed">مختلط</option></select></div>
            <div class="field"><label for="edr">مدة الاختبار (بالدقائق)</label><input id="edr" type="number" min="5" max="180" placeholder="مثال: 45"></div>
          </div>
        </section>

        <section class="panel" data-sp="2">
          <h2>مصدر المحتوى</h2>
          <div class="srcs">
            <button type="button" class="src on" data-src="up"><i class="fas fa-file-arrow-up"></i><h3>أ. رفع ملف</h3><p>PDF / Docs</p></button>
            <button type="button" class="src" data-src="ai"><i class="fas fa-pen-fancy"></i><h3>ب. توليد نص بالذكاء الاصطناعي</h3><p>الموضوع / النوع / طول النص</p></button>
            <button type="button" class="src" data-src="man"><i class="fas fa-paste"></i><h3>ج. بشكل يدوي</h3><p>عنصر TinyMCE</p></button>
          </div>
          <div class="srcp on" data-srcp="up"><div class="drop" id="drop-zone"><input type="file" id="file-input" accept=".pdf,.doc,.docx" hidden><i class="fas fa-cloud-arrow-up"></i><p><strong>اسحب الملف هنا أو اضغط للاختيار</strong><br>PDF / Docs</p></div><div id="file-preview" class="file-preview hidden"></div></div>
          <div class="srcp" data-srcp="ai"><div class="grid2"><div class="field"><label for="at">الموضوع</label><input id="at"></div><div class="field"><label for="ag">النمط</label><select id="ag"><option value="">اختر النمط</option><option>قصة</option><option>حوار</option><option>قطعة علمية</option><option>مقال</option></select></div><div class="field full"><label for="al">طول النص</label><select id="al"><option value="">اختر الطول</option><option value="short">قصير (حتى 300 كلمة)</option><option value="medium">متوسط (300-600 كلمة)</option><option value="long">طويل (أكثر من 600 كلمة)</option></select></div></div></div>
          <div class="srcp" data-srcp="man"><div class="editor">عنصر TinyMCE</div></div>
        </section>

        <section class="panel" data-sp="3">
          <h2>هيكلة AI</h2>
          <div class="field">
            <label>اختيار أنواع الأسئلة</label>
            <div class="checks">
              <label><input type="checkbox" name="qt" value="MC" checked>MC</label>
              <label><input type="checkbox" name="qt" value="Open-end" checked>مفتوح</label>
              <label><input type="checkbox" name="qt" value="True/False">صح/خطأ</label>
              <label><input type="checkbox" name="qt" value="Matching">مطابقة</label>
              <label><input type="checkbox" name="qt" value="Short Answer">إجابة قصيرة</label>
              <label><input type="checkbox" name="qt" value="Completion">إكمال</label>
            </div>
          </div>
          <div class="toggle"><div><strong>تفعيل تصنيف بلوم</strong><p>الوزن الذكي (المستوى 1=1، المستوى 2=2...)</p></div><label class="switch"><input id="sw" type="checkbox"><span>تفعيل</span></label></div>
          <div class="field"><label for="tr">تعليمات خاصة للذكاء الاصطناعي</label><textarea id="tr" placeholder="اكتب طلب المعلم الخاص"></textarea></div>
        </section>

        <section class="panel" data-sp="4">
          <h2>مراجعة وإنشاء</h2>
          <dl class="summary">
            <div class="row"><dt>نوع التقييم</dt><dd id="stk">-</dd></div>
            <div class="row"><dt>عنوان الاختبار</dt><dd id="st">-</dd></div>
            <div class="row"><dt>الصف</dt><dd id="sg">-</dd></div>
            <div class="row"><dt>المادة</dt><dd id="ss">-</dd></div>
            <div class="row"><dt>المهارات</dt><dd id="sk">-</dd></div>
            <div class="row"><dt>مصدر المحتوى</dt><dd id="sc">-</dd></div>
            <div class="row"><dt>أنواع الأسئلة</dt><dd id="sq">-</dd></div>
            <div class="row"><dt>الوزن الذكي</dt><dd id="swv">-</dd></div>
            <div class="row"><dt>طلب المعلم</dt><dd id="sr">-</dd></div>
            <div class="row"><dt>عدد الأسئلة</dt><dd id="sqc">-</dd></div>
            <div class="row"><dt>مستوى الصعوبة</dt><dd id="sdf">-</dd></div>
            <div class="row"><dt>مدة الاختبار</dt><dd id="sdr">-</dd></div>
          </dl>
        </section>

        <div class="actions">
          <button id="back" type="button" class="btn btn--outline">السابق</button>
          <div class="end">
            <button id="next" type="button" class="btn btn--teacher">التالي</button>
            <button id="draft" type="button" class="btn btn--outline btn--lg hidden"><i class="fas fa-save"></i> حفظ كمسودة</button>
            <button id="gen" type="button" class="btn gen btn--lg hidden"><i class="fas fa-wand-magic-sparkles"></i> إنشاء الاختبار بالذكاء الاصطناعي</button>
          </div>
        </div>
      </section>
    </main>
  </div>
  <div id="ov" class="ov" aria-hidden="true"><div class="box"><div class="spin"></div><strong>جاري المعالجة...</strong><p>يتم الآن إنشاء الاختبار باستخدام الذكاء الاصطناعي</p></div></div>
  <div id="success-ov" class="ov" aria-hidden="true"><div class="box success-box"><i class="fas fa-circle-check success-icon"></i><strong>تم إنشاء الاختبار بنجاح!</strong><p>يمكنك الآن مراجعة الاختبار أو العودة للوحة المعلم.</p><div class="success-actions"><a href="exam-preview.html" class="btn gen">عرض الاختبار</a><a href="teacher-dashboard.html" class="btn btn--outline">العودة للوحة</a></div></div></div>
  <script src="shared-layout.js"></script>
  <script src="tenant-mode.js"></script>
  <script>
    (function () {
      'use strict';

      var currentStep = 1;
      var totalSteps = 4;
      var wizardPanels = document.querySelectorAll('[data-sp]');
      var steps = document.querySelectorAll('[data-si]');
      var fill = document.getElementById('pfill');
      var backBtn = document.getElementById('back');
      var nextBtn = document.getElementById('next');
      var genBtn = document.getElementById('gen');
      var draftBtn = document.getElementById('draft');
      var overlay = document.getElementById('ov');
      var dropZone = document.getElementById('drop-zone');
      var fileInput = document.getElementById('file-input');
      var filePreview = document.getElementById('file-preview');
      var uploadedFile = null;
      var kindSelect = document.getElementById('ek');
      var gradeSelect = document.getElementById('eg');
      var subjectSelect = document.getElementById('es');
      var seedBox = document.getElementById('bank-seed');
      var seedCount = document.getElementById('bank-seed-count');
      var seedList = document.getElementById('bank-seed-list');
      var clearSeedBtn = document.getElementById('bank-seed-clear');

      var gradesKey = 'mitests-admin-grades';
      var subjectsKey = 'mitests-admin-subjects';
      var defaultGrades = ['الصف السابع', 'الصف الثامن', 'الصف التاسع', 'الصف العاشر'];
      var defaultSubjects = ['اللغة العربية', 'اللغة الإنجليزية', 'الرياضيات', 'العلوم'];

      function readInitialKind() {
        var kind = '';
        try {
          kind = new URLSearchParams(window.location.search).get('kind') || '';
        } catch (e) {}
        if (kind !== 'exam' && kind !== 'assignment') {
          try {
            var storedKind = localStorage.getItem('mitests-create-item-kind') || '';
            if (storedKind === 'exam' || storedKind === 'assignment') kind = storedKind;
          } catch (e2) {}
        }
        return (kind === 'assignment') ? 'assignment' : 'exam';
      }

      function hydrateInitialKind() {
        if (!kindSelect) return;
        var initialKind = readInitialKind();
        kindSelect.value = initialKind;
        try { localStorage.setItem('mitests-create-item-kind', initialKind); } catch (e) {}
      }

      function loadCatalog(key, fallback) {
        try {
          var raw = localStorage.getItem(key);
          if (!raw) return fallback.slice();
          var parsed = JSON.parse(raw);
          if (Array.isArray(parsed) && parsed.length) return parsed;
        } catch (e) {}
        return fallback.slice();
      }

      function renderSelect(selectEl, placeholder, items) {
        if (!selectEl) return;
        selectEl.innerHTML = '';

        var placeholderOpt = document.createElement('option');
        placeholderOpt.value = '';
        placeholderOpt.textContent = placeholder;
        selectEl.appendChild(placeholderOpt);

        for (var i = 0; i < items.length; i++) {
          var opt = document.createElement('option');
          opt.value = items[i];
          opt.textContent = items[i];
          selectEl.appendChild(opt);
        }
      }

      function hydrateCatalogs() {
        renderSelect(gradeSelect, 'اختر الصف', loadCatalog(gradesKey, defaultGrades));
        renderSelect(subjectSelect, 'اختر المادة', loadCatalog(subjectsKey, defaultSubjects));
      }

      function loadSeedQuestions() {
        try {
          var raw = localStorage.getItem('mitests-selected-questions');
          if (!raw) return [];
          var parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) return parsed;
        } catch (e) {}
        return [];
      }

      function renderSeedQuestions() {
        if (!seedBox || !seedCount || !seedList) return;
        var items = loadSeedQuestions();
        if (!items.length) {
          seedBox.classList.add('hidden');
          return;
        }

        seedBox.classList.remove('hidden');
        seedCount.textContent = 'تم استلام ' + items.length + ' سؤال من بنك الأسئلة. يمكنك المتابعة مباشرة أو تعديل الإعدادات.';

        seedList.innerHTML = '';
        var limit = Math.min(items.length, 5);
        for (var i = 0; i < limit; i++) {
          var li = document.createElement('li');
          li.textContent = (items[i].title || 'سؤال') + (items[i].subject ? ' (' + items[i].subject + ')' : '');
          seedList.appendChild(li);
        }

        if (items.length > limit) {
          var more = document.createElement('li');
          more.textContent = '... +' + (items.length - limit) + ' أسئلة إضافية';
          seedList.appendChild(more);
        }
      }

      function getKindLabel() {
        var kind = kindSelect ? kindSelect.value : '';
        if (kind === 'assignment') return 'واجب';
        if (kind === 'exam') return 'اختبار';
        return 'غير مختار';
      }

      function updateGenerateButtonText() {
        var kind = kindSelect ? kindSelect.value : '';
        var isAssignment = kind === 'assignment';

        genBtn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> ' + (isAssignment ? 'إنشاء الواجب بالذكاء الاصطناعي' : 'إنشاء الاختبار بالذكاء الاصطناعي');

        var overlayText = document.querySelector('#ov .box p');
        if (overlayText) {
          overlayText.textContent = isAssignment
            ? 'يتم الآن إنشاء الواجب باستخدام الذكاء الاصطناعي'
            : 'يتم الآن إنشاء الاختبار باستخدام الذكاء الاصطناعي';
        }
      }

      function updateStepper() {
        for (var i = 0; i < wizardPanels.length; i++) {
          wizardPanels[i].classList.toggle('active', Number(wizardPanels[i].dataset.sp) === currentStep);
        }

        for (var j = 0; j < steps.length; j++) {
          var stepNumber = Number(steps[j].dataset.si);
          steps[j].classList.remove('active', 'done');
          if (stepNumber < currentStep) steps[j].classList.add('done');
          if (stepNumber === currentStep) steps[j].classList.add('active');
        }

        fill.style.width = ((currentStep - 1) / (totalSteps - 1)) * 100 + '%';
        backBtn.disabled = currentStep === 1;
        nextBtn.classList.toggle('hidden', currentStep === totalSteps);
        genBtn.classList.toggle('hidden', currentStep !== totalSteps);
        draftBtn.classList.toggle('hidden', currentStep !== totalSteps);

        if (currentStep === 4) updateSummary();
        updateGenerateButtonText();
      }

      function val(id) {
        return document.getElementById(id).value.trim();
      }

      function updateSummary() {
        var skills = [];
        var skillNodes = document.querySelectorAll('.tag.on');
        for (var i = 0; i < skillNodes.length; i++) skills.push(skillNodes[i].dataset.skill);

        var qTypes = [];
        var qTypeNodes = document.querySelectorAll('input[name="qt"]:checked');
        for (var j = 0; j < qTypeNodes.length; j++) qTypes.push(qTypeNodes[j].value);

        var src = document.querySelector('.src.on');
        var srcMap = { up: 'رفع ملف', ai: 'توليد نص AI', man: 'بشكل يدوي' };

        document.getElementById('stk').textContent = getKindLabel();
        document.getElementById('st').textContent = val('et') || 'غير محدد';
        document.getElementById('sg').textContent = gradeSelect.value || 'غير مختار';
        document.getElementById('ss').textContent = subjectSelect.value || 'غير مختار';
        document.getElementById('sk').textContent = skills.length ? skills.join(', ') : 'غير مختار';
        document.getElementById('sc').textContent = src ? srcMap[src.dataset.src] : 'غير مختار';
        document.getElementById('sq').textContent = qTypes.length ? qTypes.join(', ') : 'غير مختار';
        document.getElementById('swv').textContent = document.getElementById('sw').checked ? 'مفعل' : 'غير مفعل';
        document.getElementById('sr').textContent = val('tr') || 'بدون توجيه';
        document.getElementById('sqc').textContent = val('eq') || 'غير محدد';
        var diffMap = {easy:'سهل',medium:'متوسط',hard:'صعب',mixed:'مختلط'};
        document.getElementById('sdf').textContent = diffMap[val('ed')] || 'غير مختار';
        document.getElementById('sdr').textContent = val('edr') ? val('edr') + ' دقيقة' : 'غير محدد';
      }

      function validateStep(step) {
        var valid = true;
        document.querySelectorAll('.field.error').forEach(function(f){f.classList.remove('error');});
        if (step === 1) {
          if (!val('et')) { document.getElementById('et').closest('.field').classList.add('error'); valid = false; }
          if (!kindSelect.value) { kindSelect.closest('.field').classList.add('error'); valid = false; }
          if (!gradeSelect.value) { gradeSelect.closest('.field').classList.add('error'); valid = false; }
          if (!subjectSelect.value) { subjectSelect.closest('.field').classList.add('error'); valid = false; }
        }
        return valid;
      }

      nextBtn.addEventListener('click', function () {
        if (!validateStep(currentStep)) return;
        currentStep = Math.min(totalSteps, currentStep + 1);
        updateStepper();
      });

      backBtn.addEventListener('click', function () {
        currentStep = Math.max(1, currentStep - 1);
        updateStepper();
      });

      var tags = document.querySelectorAll('.tag');
      for (var t = 0; t < tags.length; t++) {
        tags[t].addEventListener('click', function () {
          this.classList.toggle('on');
        });
      }

      var sources = document.querySelectorAll('.src');
      for (var s = 0; s < sources.length; s++) {
        sources[s].addEventListener('click', function () {
          for (var i = 0; i < sources.length; i++) sources[i].classList.remove('on');
          this.classList.add('on');

          var key = this.dataset.src;
          var srcPanels = document.querySelectorAll('.srcp');
          for (var j = 0; j < srcPanels.length; j++) {
            srcPanels[j].classList.toggle('on', srcPanels[j].dataset.srcp === key);
          }
        });
      }

      if (kindSelect) {
        kindSelect.addEventListener('change', function () {
          try {
            localStorage.setItem('mitests-create-item-kind', kindSelect.value || 'exam');
          } catch (e) {}
          updateGenerateButtonText();
          if (kindSelect.value) {
            kindSelect.closest('.field').classList.remove('error');
          }
        });
      }

      genBtn.addEventListener('click', function () {
        var itemKind = kindSelect.value || 'exam';
        var itemTitle = val('et') || (itemKind === 'assignment' ? 'واجب جديد' : 'اختبار جديد');
        var queueStatus = 'awaiting_submissions';

        try {
          var tenantType = localStorage.getItem('mitests-tenant-type') || 'school_teacher';
          var scope = 'school:SCH-001';
          if (tenantType === 'personal_teacher') {
            var wsRaw = localStorage.getItem('mitests-personal-workspace');
            if (wsRaw) {
              var ws = JSON.parse(wsRaw);
              scope = 'personal:' + (ws.workspaceId || 'default');
            } else {
              scope = 'personal:default';
            }
          } else {
            scope = 'school:' + (localStorage.getItem('mitests-school-id') || 'SCH-001');
          }

          var queueKey = 'mitests-teacher-review-queue:' + scope;
          var queue = [];
          var queueRaw = localStorage.getItem(queueKey);
          if (queueRaw) {
            var parsedQueue = JSON.parse(queueRaw);
            if (Array.isArray(parsedQueue)) queue = parsedQueue;
          }

          queue.unshift({
            id: 'rq-' + Date.now(),
            kind: itemKind,
            title: itemTitle,
            groupCode: new URLSearchParams(window.location.search).get('group') || '',
            studentName: 'بانتظار تسليم الطلاب',
            studentId: '',
            status: queueStatus,
            submittedAt: new Date().toISOString()
          });

          localStorage.setItem(queueKey, JSON.stringify(queue));
        } catch (queueError) {}

        overlay.classList.add('on');
        overlay.setAttribute('aria-hidden', 'false');
        setTimeout(function () {
          overlay.classList.remove('on');
          overlay.setAttribute('aria-hidden', 'true');
          window.location.href = 'exam-assessment.html?kind=' + encodeURIComponent(itemKind) + '&title=' + encodeURIComponent(itemTitle);
        }, 2400);
      });

      draftBtn.addEventListener('click', function () {
        try { localStorage.setItem('mitests-exam-draft', JSON.stringify({kind:kindSelect.value,title:val('et'),grade:gradeSelect.value,subject:subjectSelect.value,qCount:val('eq'),diff:val('ed'),dur:val('edr')})); } catch(e){}
        alert('تم حفظ المسودة بنجاح!');
      });

      /* File upload */
      if (dropZone && fileInput) {
        dropZone.addEventListener('click', function(){ fileInput.click(); });
        dropZone.addEventListener('dragover', function(e){ e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', function(){ dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', function(e){ e.preventDefault(); dropZone.classList.remove('drag-over'); if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', function(){ if(fileInput.files.length) handleFile(fileInput.files[0]); });
      }
      function handleFile(file) {
        uploadedFile = file;
        filePreview.classList.remove('hidden');
        filePreview.innerHTML = '<i class="fas fa-file-pdf"></i><span class="file-name">' + file.name + ' (' + (file.size/1024).toFixed(0) + ' KB)</span><button type="button" class="file-remove" title="حذف"><i class="fas fa-xmark"></i></button>';
        filePreview.querySelector('.file-remove').addEventListener('click', function(){ uploadedFile=null; filePreview.classList.add('hidden'); filePreview.innerHTML=''; fileInput.value=''; });
      }

      if (clearSeedBtn) {
        clearSeedBtn.addEventListener('click', function () {
          try {
            localStorage.removeItem('mitests-selected-questions');
          } catch (e) {}
          renderSeedQuestions();
        });
      }

      hydrateCatalogs();
      hydrateInitialKind();
      renderSeedQuestions();
      updateGenerateButtonText();
      updateStepper();
    })();
  </script>
</body>
</html>

